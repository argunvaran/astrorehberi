{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{% static 'astrology/favicon.png' %}?v=2">
    <link rel="shortcut icon" type="image/png" href="{% static 'astrology/favicon.png' %}?v=2">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTRO | Deep Cosmos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0F0C29;
            --gradient-start: #0F0C29;
            --gradient-mid: #302B63;
            --gradient-end: #24243E;
            --accent: #E94560;
            --gold: #FFD700;
            --text: #EEEEEE;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-mid), var(--gradient-end));
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3 {
            font-family: 'Cinzel', serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: rgba(15, 12, 41, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            padding: 2rem;
            position: fixed;
            height: 100vh;
            transition: transform 0.3s;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 1.8rem;
            color: var(--gold);
            margin-bottom: 3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .nav-item:hover,
        .nav-item.active {
            background: linear-gradient(90deg, rgba(233, 69, 96, 0.2), transparent);
            color: var(--text);
            border-left: 3px solid var(--accent);
        }

        .main {
            margin-left: 280px;
            flex: 1;
            padding: 3rem;
        }

        .glass-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .btn {
            background: var(--accent);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(233, 69, 96, 0.4);
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-bottom: 1rem;
            font-family: 'Outfit';
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main {
                margin-left: 0;
                padding: 1.5rem;
            }

            .mobile-toggle {
                display: block;
            }
        }

        .mobile-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 101;
            background: var(--accent);
            padding: 10px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .planet-row {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .planet-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .planet-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            margin-right: 15px;
        }

        /* TAROT STYLES */
        #view-tarot {
            background: radial-gradient(circle at center, #1a0b2e 0%, #0F0C29 100%);
            min-height: 100vh;
            /* Increased height */
            border-radius: 20px;
            position: relative;
            overflow: visible;
            /* Changed from hidden to allow floating elements if needed */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 80px 40px;
            /* More top padding */
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.8);
        }

        .tarot-table {
            width: 100%;
            height: 400px;
            /* Increased height */
            perspective: 1200px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            /* Align top to give space below */
            position: relative;
            margin-bottom: 50px;
            margin-top: 50px;
        }

        /* Card Card */
        .tarot-card-container {
            width: 100px;
            height: 170px;
            position: absolute;
            transform-style: preserve-3d;
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
            border-radius: 12px;
        }

        .tarot-card-container:hover {
            transform: translateY(-20px) scale(1.05) rotateZ(2deg);
            z-index: 100 !important;
            box-shadow: 0 0 20px var(--gold);
        }

        .tarot-card-container.flipped {
            transform: rotateY(180deg) !important;
            z-index: 50 !important;
            /* Removed scale and translate to keep them in slots */
        }

        /* Layout for selected cards */
        .selected-slot {
            transition: all 0.5s;
        }

        /* Front & Back */
        .card-face {
            width: 100%;
            height: 100%;
            position: absolute;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow: hidden;
        }

        .card-back {
            background: linear-gradient(135deg, #111, #222);
            border: 2px solid var(--gold);
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.8);
        }

        .card-back::before {
            content: '';
            position: absolute;
            top: 5px;
            bottom: 5px;
            left: 5px;
            right: 5px;
            border: 1px dashed rgba(255, 215, 0, 0.3);
            border-radius: 8px;
        }

        .card-back::after {
            content: 'üîÆ';
            font-size: 2.5rem;
            filter: drop-shadow(0 0 5px var(--gold));
            opacity: 0.8;
        }

        .card-front {
            background: linear-gradient(180deg, #fff, #f4e4bc);
            color: #111;
            transform: rotateY(180deg);
            border: 4px solid #fff;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            font-family: 'Cinzel', serif;
        }

        .card-art {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .card-title {
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 5px;
            padding: 0 5px;
            letter-spacing: 1px;
        }
    </style>

    </style>
</head>

<body>

    <!-- Top Modal Removed -->
    <!-- LANDING PAGE REMOVED (Moved to landing.html) -->


    <div class="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>

    <div class="app-container" id="app-root" style="display:flex">
        <!-- SIDEBAR -->
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <i class="fas fa-star-and-crescent"></i> <span data-i18n="app_name">DEEP COSMOS</span>
            </div>

            <div class="nav-item active" onclick="nav('chart', this)">
                <i class="fas fa-globe-europe"></i> <span data-i18n="menu_chart">Natal Chart</span>
            </div>
            <div class="nav-item" onclick="nav('daily', this)">
                <i class="fas fa-calendar-day"></i> <span data-i18n="menu_daily">Daily & Weekly</span>
            </div>
            <div class="nav-item" onclick="nav('social', this)">
                <i class="fas fa-users"></i> <span data-i18n="menu_social">Social Analysis</span>
            </div>

            <!-- RESTORED LOVE MATCH -->
            <div class="nav-item" onclick="nav('synastry', this)">
                <i class="fas fa-heart"></i> <span data-i18n="menu_synastry">Love Match</span>
            </div>

            <!-- SIDEBAR ITEM -->
            <div class="nav-item" onclick="nav('career', this)">
                <i class="fas fa-briefcase"></i> <span data-i18n="menu_career">Career Path</span>
            </div>



            <div class="nav-item" onclick="nav('tarot', this)"
                style="border: 1px solid var(--accent); background: rgba(233,69,96,0.1)">
                <i class="fas fa-hat-wizard"></i> <span style="color:var(--gold); font-weight:bold">Tarot Room</span>
            </div>
            <div class="nav-item" onclick="nav('draconic', this)">
                <i class="fas fa-dragon"></i> <span data-i18n="menu_draconic">Draconic Soul</span>
            </div>
            <div class="nav-item" onclick="nav('hours', this)">
                <i class="fas fa-hourglass-half"></i> <span data-i18n="menu_hours">Planetary Hours</span>
            </div>

            <!-- ADMIN LINK (HIDDEN BY DEFAULT) -->
            <div id="admin-nav-item" class="nav-item" onclick="window.open('/api/custom-admin/', '_blank')"
                style="display:none; border: 1px solid #E94560; background: rgba(233,69,96,0.2); color: #E94560">
                <i class="fas fa-satellite-dish"></i> <span>Kozmik Panel</span>
            </div>

            <!-- GLOBAL LANGUAGE SELECTOR -->
            <div style="margin-top:auto; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1)">
                <label style="color:rgba(255,255,255,0.5); font-size:0.8rem; display:block; margin-bottom:8px"
                    data-i18n="label_lang">Dil / Language</label>
                <select id="lang" onchange="changeLang(this.value)"
                    style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:8px; cursor:pointer">
                    <option value="tr" selected>T√ºrk√ße üáπüá∑</option>
                    <option value="en">English üá∫üá∏</option>
                </select>
            </div>


            <div style="margin-top:10px; font-size:0.8rem; color:rgba(255,255,255,0.4)">
                App v4.6 | <span data-i18n="footer">Synced with NASA</span>
            </div>
        </nav>

        <!-- MAIN -->
        <main class="main" style="position:relative">
            <!-- AUTH WIDGET -->
            <div id="auth-widget"
                style="position:absolute; top:20px; right:20px; z-index:900; display:flex; gap:10px; align-items:center">
                <div id="user-display" style="font-weight:bold; color:var(--gold); display:block"><i
                        class="fas fa-user-circle"></i> {{ user.username }}</div>
                <button id="btn-logout-trig" onclick="doLogout()" class="btn"
                    style="display:flex; background:rgba(255,100,100,0.2); width:40px; justify-content:center; padding:10px">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>


            <!-- AUTH MODAL REMOVED -->


            <!-- CHART -->
            <section id="view-chart" class="view animate-in">
                <h1 style="font-size:2.5rem; margin-bottom:0.5rem" data-i18n="chart_title">Natal Chart Calculator</h1>
                <p style="color:rgba(255,255,255,0.6); margin-bottom:2rem" data-i18n="chart_subtitle">NASA Precision
                    Engines</p>
                <div class="glass-card">
                    <!-- LOCATION SELECTOR -->
                    <div style="margin-bottom:20px; text-align:left">
                        <label id="loc-label"
                            style="color:var(--gold); font-size:0.9rem; margin-bottom:5px; display:block">
                            <i class="fas fa-map-marker-alt"></i> <span data-i18n="label_place">Birth Place</span>
                        </label>
                        {% if profile %}
                        <!-- Read-Only Mode for Registered Users -->
                        <div id="main-loc-container" style="display:none">
                            <!-- Hidden Selectors just in case JS needs them? No, we use locked input -->
                            <input type="hidden" id="loc-city">
                        </div>
                        <input type="text" id="locked-loc-input" class="glass-input" disabled
                            value="{{ profile.birth_place }}"
                            style="display:block; width:100%; margin-top:5px; opacity:0.8; cursor:not-allowed; background:rgba(255,255,255,0.05); color:var(--text); border:1px solid var(--border)">
                        {% else %}
                        <!-- Guest Mode -->
                        <div id="main-loc-container" style="display:flex; gap:10px; flex-wrap:wrap">
                            <select id="loc-country" class="glass-input" style="flex:1; min-width:120px"
                                onchange="loadProvinces()">
                                <option value="">Loading...</option>
                            </select>
                            <select id="loc-province" class="glass-input" style="flex:1; min-width:120px; display:none;"
                                onchange="loadCities()">
                                <option value="">Province...</option>
                            </select>
                            <select id="loc-city" class="glass-input" style="flex:1; min-width:120px"
                                onchange="setCityCoords()">
                                <option value="">City/District...</option>
                            </select>
                        </div>
                        <input type="text" id="locked-loc-input" class="glass-input" disabled
                            style="display:none; width:100%; margin-top:5px; opacity:0.8; cursor:not-allowed">
                        {% endif %}
                    </div>

                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
                        <div>
                            <label data-i18n="label_date">Birth Date</label>
                            <input type="text" id="date"
                                value="{{ profile.birth_date|date:'Y/m/d'|default:'1990/01/01' }}" {% if profile %}readonly style="opacity:0.7; cursor:not-allowed" {% endif %} placeholder="YYYY/MM/DD">
                                
                        </div>
                        <div>
                            <label data-i18n="label_time">Birth Time</label>
                            <input type="text" id="time" value="{{ profile.birth_time|time:'H:i'|default:'12:00' }}" {%if profile %}readonly style="opacity:0.7; cursor:not-allowed" {% endif %}>
                                
                        </div>
                        <!-- Coordinates (Auto-filled) -->
                        <div>
                            <label data-i18n="label_lat">Latitude</label>
                            <input type="number" id="lat" value="{{ profile.lat|default:'41.0082' }}" {% if profile %}readonly style="opacity:0.7; cursor:not-allowed" {% endif %}>
                                
                        </div>
                        <div>
                            <label data-i18n="label_lon">Longitude</label>
                            <input type="number" id="lon" value="{{ profile.lon|default:'28.9784' }}" {% if profile %}readonly style="opacity:0.7; cursor:not-allowed" {% endif %}>
                                
                        </div>
                    </div>

                    <div id="tz-display"
                        style="margin-top:10px; font-size:0.85rem; color:var(--accent); font-style:italic; display:none">
                        <i class="fas fa-clock"></i> Targeted Timezone: <span id="tz-name">Auto</span>
                    </div>

                    <button class="btn" onclick="calcChart()" style="margin-top:20px"><i class="fas fa-bolt"></i> <span
                            data-i18n="btn_calc">Generate Analysis</span></button>
                    <div id="loader-chart" style="display:none; margin-top:20px; color:var(--accent)">Running NASA
                        Engines...</div>
                </div>
                <div id="res-chart" style="display:none"></div>
            </section>

            <!-- DAILY -->
            <section id="view-daily" class="view animate-in" style="display:none">
                <div style="margin-bottom:1rem">
                    <h1 style="font-size:2.5rem; margin:0" data-i18n="daily_title">Cosmic Forecast</h1>
                    <p style="color:rgba(255,255,255,0.6); margin-top:5px" data-i18n="daily_subtitle">Your 7-Day Fortune
                        Outlook</p>
                </div>

                <div class="glass-card">
                    <h3 style="color:var(--gold); display:flex; justify-content:space-between">
                        <span><i class="fas fa-chart-line"></i> <span data-i18n="graph_title">7-Day Energy
                                Forecast</span></span>
                        <span style="font-size:0.8rem; opacity:0.6">Fortune Teller Mode</span>
                    </h3>
                    <div style="height:300px; margin-top:20px"><canvas id="weeklyChart"></canvas></div>
                </div>

                <h3 style="margin:20px 0; color:var(--accent); letter-spacing:1px">DAILY FORTUNE</h3>
                <div id="daily-list" class="glass-card"
                    style="border:none; background:transparent; padding:0; box-shadow:none">
                    <!-- Dynamic Items -->
                </div>

                <div id="daily-content" class="glass-card" style="border-left: 4px solid var(--accent)">
                    <h3><i class="fas fa-satellite-dish"></i> <span data-i18n="daily_intel">Daily Intel</span></h3>
                    <div id="daily-text" style="font-size:1.1rem; line-height:1.6; margin-top:10px">Loading...</div>
                </div>
            </section>

            <!-- SOCIAL -->
            <section id="view-social" class="view animate-in" style="display:none">
                <h1 style="font-size:2.5rem; margin-bottom:0.5rem" data-i18n="social_title">Social Synergy</h1>
                <div style="display:flex; gap:20px; flex-wrap:wrap">
                    <div style="flex:1; min-width:300px">
                        <div class="glass-card">
                            <h3 data-i18n="soc_add_title">Add Member</h3>
                            <input type="text" id="soc-name" placeholder="Name">
                            <input type="text" id="soc-date" value="1995/05/05">
                            <button class="btn" onclick="addMember()" data-i18n="btn_add">Add Person</button>
                        </div>
                        <div id="member-list"></div>
                    </div>
                    <div style="flex:1; min-width:300px">
                        <div class="glass-card" id="social-res" style="text-align:center">
                            <p data-i18n="soc_placeholder">Add members to see analysis</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SYNASTRY -->
            <section id="view-synastry" class="view animate-in" style="display:none">
                <h1 data-i18n="menu_synastry">Love Match</h1>
                <div class="glass-card">
                    <div style="display:flex; gap:20px; align-items:center;">
                        <div><label>Partner Date</label><input type="text" id="syn-date" value="1992/02/14"></div>
                        <button class="btn" onclick="calcSynastry()" style="height:fit-content; margin-top:10px"
                            data-i18n="btn_match">Check Match</button>
                    </div>
                    <div id="syn-res" style="margin-top:20px;"></div>
                </div>
            </section>

            <!-- DRACONIC -->
            <section id="view-draconic" class="view animate-in" style="display:none">
                <h1 data-i18n="menu_draconic">Draconic Soul Chart</h1>
                <p style="color:rgba(255,255,255,0.6)" data-i18n="draconic_subtitle">Your Higher Self / Soul's Purpose
                </p>
                <div id="draconic-res" class="glass-card"></div>
            </section>

            <!-- HOURS -->
            <section id="view-hours" class="view animate-in" style="display:none">
                <h1 data-i18n="menu_hours">Planetary Hours</h1>
                <p style="color:rgba(255,255,255,0.6)">Optimize your daily schedule</p>
                <div id="hours-res" class="glass-card"></div>
            </section>

            <!-- TAROT ROOM (Correctly Placed) -->
            <div id="view-tarot" class="view" style="display:none">
                <div style="max-width:800px; margin:0 auto; text-align:center">
                    <h2
                        style="color:var(--gold); margin-bottom:10px; font-size:2.5rem; text-shadow:0 0 10px rgba(255,215,0,0.5)">
                        Mystic Tarot</h2>
                    <p style="opacity:0.7; margin-bottom:40px; font-size:1.1rem">Focus on your question, clear your
                        mind, and let the cards guide you.</p>

                    <div id="tarot-table" class="tarot-table">
                        <!-- Deck Pile -->
                        <div id="tarot-deck-pile"
                            style="position:relative; width:100px; height:170px; cursor:pointer; margin:0 auto"
                            onclick="startTarot()">
                            <div class="tarot-card-container" style="top:0; left:0; transform:translateZ(0px)">
                                <div class="card-face card-back"></div>
                            </div>
                            <div class="tarot-card-container" style="top:-2px; left:-2px; transform:translateZ(-1px)">
                                <div class="card-face card-back"></div>
                            </div>
                            <div class="tarot-card-container" style="top:-4px; left:-4px; transform:translateZ(-2px)">
                                <div class="card-face card-back"></div>
                            </div>
                            <div
                                style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:200px; text-align:center; color:white; font-weight:bold; text-shadow:0 2px 4px black; pointer-events:none">
                                TAP TO SHUFFLE</div>
                        </div>
                    </div>
                </div>

                <!-- Slots -->
                <div id="tarot-slots"
                    style="display:flex; gap:20px; margin-bottom:30px; min-height:180px; justify-content:center; flex-wrap:wrap">
                    <div id="slot-0" class="selected-slot"
                        style="width:100px; height:170px; border:2px dashed rgba(255,255,255,0.2); border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.5; font-size:0.8rem">
                        <span>PAST</span><i class="fas fa-history" style="margin-top:5px"></i>
                    </div>
                    <div id="slot-1" class="selected-slot"
                        style="width:100px; height:170px; border:2px dashed rgba(255,255,255,0.2); border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.5; font-size:0.8rem">
                        <span>PRESENT</span><i class="fas fa-hourglass-half" style="margin-top:5px"></i>
                    </div>
                    <div id="slot-2" class="selected-slot"
                        style="width:100px; height:170px; border:2px dashed rgba(255,255,255,0.2); border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.5; font-size:0.8rem">
                        <span>FUTURE</span><i class="fas fa-rocket" style="margin-top:5px"></i>
                    </div>
                </div>

                <div style="text-align:center; margin-bottom:30px">
                    <button id="btn-reveal-tarot" class="btn"
                        style="display:none; background:var(--gold); color:black; font-weight:800; animation:pulse 1s infinite; font-size:1.2rem; padding:15px 40px"
                        onclick="revealTarot()">REVEAL DESTINY</button>
                </div>

                <div id="tarot-reading-area" class="reading-area"
                    style="display:none; padding-bottom:50px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px">
                </div>
                <div style="margin-top:20px; cursor:pointer; opacity:0.5; font-size:0.9rem; text-align:center"
                    onclick="resetTarot()"><i class="fas fa-redo"></i> Reset Table</div>
            </div>
            <!-- CAREER VIEW RE-INSERTED CORRECTLY -->
            <section id="view-career" class="view animate-in" style="display:none">
                <h1 data-i18n="menu_career">Career Path</h1>
                <p style="color:rgba(255,255,255,0.6)" data-i18n="career_subtitle">Deep Professional Analysis</p>

                <div class="glass-card" id="career-input-card">
                    <p data-i18n="career_prompt" style="font-size:1.1rem; margin-bottom:15px">Please calculate your
                        Natal Chart first to unlock your Career Analysis.</p>
                    <button class="btn" onclick="nav('chart', document.querySelectorAll('.nav-item')[0])"
                        data-i18n="btn_goto_chart">Go to Chart</button>
                </div>

                <div id="career-res" style="display:none; flex-direction: column; gap:20px;">
                    <!-- Content injected via JS -->
                </div>
            </section>
        </main>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // ... (Existing variables)

        // CAREER LOGIC
        async function loadCareer() {
            if (!currentData) {
                document.getElementById('career-input-card').style.display = 'block';
                document.getElementById('career-res').style.display = 'none';
                return;
            }
            document.getElementById('career-input-card').style.display = 'none';
            const resDiv = document.getElementById('career-res');
            resDiv.style.display = 'flex';
            resDiv.innerHTML = '<div style="color:var(--accent)">Analyzing Career Path...</div>';

            try {
                const date = document.getElementById('date').value;
                const time = document.getElementById('time').value;
                const lat = document.getElementById('lat').value;
                const lon = document.getElementById('lon').value;
                const lang = document.getElementById('lang').value;

                const response = await fetch('/api/career-analysis/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, time, lat, lon, lang })
                });
                const data = await response.json();

                if (data.analysis) {
                    const text = data.analysis[lang] || data.analysis['en'];

                    const t_mc = lang === 'tr' ? 'Tepe Noktasƒ± & Stat√º' : 'Midheaven & Status';
                    const t_sat = lang === 'tr' ? 'Sat√ºrn & Yapƒ±' : 'Saturn & Structure';
                    const t_fore = lang === 'tr' ? 'Aylƒ±k Tahmin' : 'Monthly Forecast';

                    // Split sections if possible or render rich HTML
                    resDiv.innerHTML = `
                        <div class="glass-card animate-in" style="border-left:4px solid var(--gold)">
                            <h2 style="color:var(--gold)"><i class="fas fa-crown"></i> ${t_mc}</h2>
                            <div style="margin-top:15px; line-height:1.8; font-size:1.05rem">
                               ${text.split('<br>')[0]}
                            </div>
                        </div>
                        <div class="glass-card animate-in" style="border-left:4px solid var(--accent)">
                            <h2 style="color:var(--accent)"><i class="fas fa-mountain"></i> ${t_sat}</h2>
                            <div style="margin-top:15px; line-height:1.8; font-size:1.05rem">
                               ${text.split('<br>')[1] || ''}
                            </div>
                        </div>
                        <div class="glass-card animate-in" style="background: linear-gradient(135deg, rgba(233,69,96,0.1), rgba(0,0,0,0.3))">
                             <h2 style="color:#fff"><i class="fas fa-meteor"></i> ${t_fore}</h2>
                             <div style="margin-top:15px; line-height:1.8; font-size:1.1rem; font-style:italic">
                               ${text.split('<br>')[2] || ''}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                resDiv.innerHTML = 'Error loading career data.';
                console.error(e);
            }
        }

        // Navigation Interceptor
        const originalNav = window.nav || function (id, el) { };
        window.nav = function (id, el) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // Show new
            if (el) el.classList.add('active');
            const view = document.getElementById('view-' + id);
            if (view) view.style.display = 'block';
            if (id === 'tarot') document.getElementById('view-tarot').style.display = 'flex';

            // Trigger Loaders
            if (id === 'career') loadCareer();
            if (id === 'draconic') renderDraconic(currentData);
            if (id === 'hours') renderHours(currentData);
            if (id === 'daily') loadDaily();
            if (id === 'social') analyzeGroup();
        };


        /* TAROT LOGIC */
        let tarotState = 'deck'; // deck, spread, selected, revealed
        let selectedTarotCards = [];
        let fetchedTarotData = []; // Cards
        let fetchedTarotResponse = null; // Full Response

        async function startTarot() {
            if (tarotState !== 'deck') return;

            const table = document.getElementById('tarot-table');
            table.innerHTML = ''; // Clear pile

            // 1. Fetch Data silently
            const lang = document.getElementById('lang').value;
            try {
                const res = await fetch(`/api/draw-tarot/?lang=${lang}`);
                const data = await res.json();
                fetchedTarotResponse = data; // Store full
                if (data.cards) fetchedTarotData = data.cards; // Keep for compatibility
            } catch (e) { console.error("Tarot Fetch Error", e); }

            // 2. Generate Spread (22 Cards Arc)
            const total = 22;
            const center = window.innerWidth < 768 ? 150 : 300;

            for (let i = 0; i < total; i++) {
                const card = document.createElement('div');
                card.className = 'tarot-card-container';
                card.innerHTML = `<div class="card-face card-back"></div><div class="card-face card-front"></div>`;

                // Initial: Center
                card.style.left = '50%';
                card.style.top = '50%';
                card.style.transform = 'translate(-50%, -50%)';
                card.style.transitionDelay = `${i * 0.05}s`;

                card.onclick = () => selectTarotCard(card, i);

                table.appendChild(card);

                // Spread Animation
                setTimeout(() => {
                    const angle = -60 + (i * (120 / total)); // -60 to +60 deg
                    const radius = 450; // Wider
                    const x = Math.sin(angle * Math.PI / 180) * radius;
                    const y = Math.cos(angle * Math.PI / 180) * radius * 0.2; // Much flatter (0.2) to avoid overlap

                    // Shift UP by 60px to clear slots
                    card.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px - 60px)) rotate(${angle}deg)`;
                }, 100);
            }
            tarotState = 'spread';
            document.getElementById('tarot-slots').style.opacity = '1';
        }

        function selectTarotCard(el, index) {
            if (tarotState !== 'spread' || selectedTarotCards.length >= 3) return;
            if (el.classList.contains('picked')) return;

            const slotIndex = selectedTarotCards.length;
            selectedTarotCards.push(index);
            el.classList.add('picked');

            // Move to Slot (Physical DOM Move)
            const slot = document.getElementById(`slot-${slotIndex}`);

            // Clear slot placeholder (Past, Present icons)
            slot.innerHTML = '';
            slot.appendChild(el);

            // Reset Card Styles to fit container
            el.style.position = 'relative';
            el.style.top = '0';
            el.style.left = '0';
            el.style.transform = 'none';
            el.style.width = '100%';
            el.style.height = '100%';
            el.style.margin = '0';
            el.style.pointerEvents = 'none'; // Lock it
            el.style.zIndex = '10';

            // Remove Slot Styling
            slot.style.opacity = '1';
            slot.style.border = 'none';

            if (selectedTarotCards.length === 3) {
                document.getElementById('btn-reveal-tarot').style.display = 'inline-block';
            }
        }

        async function revealTarot() {
            const readingArea = document.getElementById('tarot-reading-area');
            readingArea.innerHTML = '';
            readingArea.style.display = 'grid';
            document.getElementById('btn-reveal-tarot').style.display = 'none';

            // Emergency Data Check
            if (!fetchedTarotData || fetchedTarotData.length < 3) {
                console.warn("Tarot data missing, attempting refetch...");
                const lang = document.getElementById('lang').value;
                try {
                    const res = await fetch(`/api/draw-tarot/?lang=${lang}`);
                    const data = await res.json();
                    fetchedTarotResponse = data;
                    if (data.cards) fetchedTarotData = data.cards;
                } catch (e) {
                    alert("The stars are clouded. Please try again.");
                    return;
                }
            }

            const pickedEls = document.querySelectorAll('.tarot-card-container.picked');

            pickedEls.forEach((el, i) => {
                const data = fetchedTarotData[i];
                if (!data) return;

                // 1. Flip Animation IN PLACE
                setTimeout(() => {
                    el.classList.add('flipped');
                    // Update Front Content
                    const front = el.querySelector('.card-front');
                    if (data.is_reversed) front.classList.add('reversed');

                    front.innerHTML = `
                        <div class="card-title" style="font-size:0.6rem; color:#333">${data.name}</div>
                        <div class="card-art" style="color:${data.color}; font-size:2.5rem; margin:5px 0">${data.element === 'Fire' ? 'üî•' : data.element === 'Water' ? 'üíß' : data.element === 'Air' ? 'üå™Ô∏è' : 'üåø'}</div>
                        <div style="font-size:0.5rem; text-transform:uppercase; letter-spacing:1px; color:#555">${data.position}</div>
                     `;
                }, i * 600);

                // 2. Add description below
                setTimeout(() => {
                    readingArea.innerHTML += `
                        <div class="glass-card animate-in" style="text-align:left">
                             <h3 style="color:${data.color}; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px">
                                <i class="fas ${data.position === 'Past' ? 'fa-history' : data.position === 'Present' ? 'fa-hourglass-half' : 'fa-rocket'}"></i> 
                                ${data.position}: ${data.name} <span style="font-size:0.7em; opacity:0.7">${data.is_reversed ? '(Reversed)' : ''}</span>
                             </h3>
                             <p style="line-height:1.6; font-size:1rem">${data.meaning}</p>
                        </div>
                     `;
                }, 2000 + (i * 600));
            });

            // 3. Add Synthesis & Outcome
            setTimeout(() => {
                if (fetchedTarotResponse && fetchedTarotResponse.wish) {
                    const summaryHtml = `
                        <div class="glass-card animate-in" style="grid-column: 1 / -1; margin-top:30px; border:2px solid ${fetchedTarotResponse.wish.score >= 0 ? 'var(--gold)' : '#ff4444'}; background:linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,0,10,0.8))">
                            <h2 style="color:${fetchedTarotResponse.wish.score >= 0 ? 'var(--gold)' : '#ff6666'}; text-align:center; margin-bottom:15px; font-size:1.8rem; text-shadow:0 0 10px rgba(0,0,0,0.5)">
                                <i class="fas fa-magic"></i> ${fetchedTarotResponse.wish.title}
                            </h2>
                            <p style="font-size:1.2rem; line-height:1.6; text-align:center; margin-bottom:20px; font-style:italic; color:#fff">"${fetchedTarotResponse.wish.text}"</p>
                            <hr style="border-color:rgba(255,255,255,0.1); margin-bottom:20px">
                            <h3 style="color:var(--text); margin-bottom:10px; text-transform:uppercase; letter-spacing:2px; font-size:1rem"><i class="fas fa-align-left"></i> ${document.getElementById('lang').value === 'tr' ? 'Kozmik √ñzet' : 'Cosmic Synthesis'}</h3>
                            <p style="opacity:0.9; line-height:1.8; text-align:justify; font-size:1.1rem">${fetchedTarotResponse.synthesis}</p>
                        </div>
                     `;
                    readingArea.innerHTML += summaryHtml;
                    setTimeout(() => {
                        const area = document.getElementById('view-tarot');
                    }, 100);
                }
            }, 4000);
        }

        function resetTarot() {
            tarotState = 'deck';
            selectedTarotCards = [];
            document.getElementById('tarot-table').innerHTML = `
                 <div id="tarot-deck-pile" style="position:relative; width:100px; height:170px; cursor:pointer" onclick="startTarot()">
                    <div class="tarot-card-container" style="top:0; left:0; transform:translateZ(0px)"> <div class="card-face card-back"></div> </div>
                    <div class="tarot-card-container" style="top:-2px; left:-2px; transform:translateZ(-1px)"> <div class="card-face card-back"></div> </div>
                    <div class="tarot-card-container" style="top:-4px; left:-4px; transform:translateZ(-2px)"> <div class="card-face card-back"></div> </div>
                    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:200px; text-align:center; color:white; font-weight:bold; text-shadow:0 2px 4px black; pointer-events:none">TAP TO SHUFFLE</div>
                 </div>
             `;
            document.getElementById('tarot-reading-area').style.display = 'none';
            document.getElementById('btn-reveal-tarot').style.display = 'none';
        }
        const translations = {
            en: {
                app_name: "DEEP COSMOS",
                menu_chart: "Natal Chart", menu_daily: "Daily & Weekly", menu_social: "Social Analysis",
                menu_synastry: "Love Match", menu_draconic: "Draconic Soul", menu_hours: "Time Mastery",
                footer: "Synced with NASA",
                chart_title: "Natal Chart Calculator", chart_subtitle: "NASA Precision Engines",
                label_date: "Birth Date", label_time: "Birth Time", label_lat: "Latitude", label_lon: "Longitude", label_lang: "Language / Dil",
                btn_calc: "Generate Analysis",
                daily_title: "Cosmic Forecast", daily_subtitle: "NASA Synchronized Transits",
                graph_title: "7-Day Energy Forecast", daily_intel: "Daily Intel", daily_advice: "Daily Advice",
                social_title: "Social Synergy", social_subtitle: "Group Dynamics & Elemental Balance",
                soc_add_title: "Add Member", btn_add: "Add Person", soc_placeholder: "Add members to see analysis",
                btn_match: "Check Compatibility",
                match_res: "COMPATIBILITY", match_desc: "A strong karmic link detected between the two dates.",
                draconic_wait: "To view Draconic chart, first calculate your Natal Chart.",
                hours_wait: "Run Natal Chart to determine location-based hours.",
                hours_title: "Today's Power Hours", h_sun: "Sun Hour", h_success: "(Success)", h_mars: "Mars Hour", h_action: "(Action)",
                p_pos: "Planetary Positions", t_rising: "Rising Sign", drac_title: "Soul Contract (Draconic)",
                draconic_subtitle: "Your Higher Self / Soul's Purpose",
                draconic_sun_label: "Higher Self Sun",
                career_title: "Career Path"
            },
            tr: {
                app_name: "DERƒ∞N KOZMOS",
                menu_chart: "Doƒüum Haritasƒ±", menu_daily: "G√ºnl√ºk & Haftalƒ±k", menu_social: "Sosyal Analiz",
                menu_synastry: "A≈ük Uyumu", menu_draconic: "Drakonik Ruh", menu_hours: "Zaman Y√∂netimi",
                footer: "NASA ile Senkronize",
                chart_title: "Doƒüum Haritasƒ±", chart_subtitle: "NASA Hassas Motorlarƒ±",
                label_date: "Doƒüum Tarihi", label_time: "Doƒüum Saati", label_lat: "Enlem", label_lon: "Boylam", label_lang: "Dil / Language", label_place: "Doƒüum Yeri",
                btn_calc: "Analizi Olu≈ütur",
                daily_title: "Kozmik Tahmin", daily_subtitle: "E≈üzamanlƒ± NASA Transitleri",
                graph_title: "7-G√ºnl√ºk Enerji Tahmini", daily_intel: "G√ºnl√ºk ƒ∞stihbarat", daily_advice: "G√ºnl√ºk Tavsiye",
                social_title: "Sosyal Sinerji", social_subtitle: "Grup Dinamikleri ve Element Dengesi",
                soc_add_title: "√úye Ekle", btn_add: "Ki≈üi Ekle", soc_placeholder: "Analiz i√ßin √ºye ekleyin",
                menu_career: "Kariyer Yolu",
                btn_match: "Uyumu Kontrol Et",
                match_res: "UYUM SKORU", match_desc: "ƒ∞ki tarih arasƒ±nda g√º√ßl√º bir karmik baƒü tespit edildi.",
                draconic_wait: "Drakonik haritayƒ± g√∂rmek i√ßin √∂nce Doƒüum Haritasƒ±nƒ± hesaplayƒ±n.",
                hours_wait: "Saatleri g√∂rmek i√ßin Doƒüum Haritasƒ±nƒ± √ßalƒ±≈ütƒ±rƒ±n.",
                hours_title: "G√ºn√ºn G√º√ß Saatleri", h_sun: "G√ºne≈ü Saati", h_success: "(Ba≈üarƒ±)", h_mars: "Mars Saati", h_action: "(Eylem)",
                p_pos: "Gezegen Konumlarƒ±", t_rising: "Y√ºkselen Bur√ß", drac_title: "Ruh S√∂zle≈ümesi (Drakonik)",
                draconic_subtitle: "Y√ºksek Benliƒüiniz / Ruhsal Amacƒ±nƒ±z",
                draconic_sun_label: "Y√ºksek Benlik G√ºne≈üi",
                career_title: "Kariyer Yolu"
            }
        };

        const draconicInterpretations = {
            en: {
                Aries: "Your soul has signed a contract to be a pioneer. In this lifetime, your higher self demands that you learn courage, independence, and self-assertion. You are here to break old cycles and start new paths. The challenges you face are meant to forge your identity and teach you that it is safe to be powerful and direct.",
                Taurus: "The soul purpose here is grounded in finding peace and specialized worth. You agreed to learn the lessons of stability, nature, and self-sufficiency. Your higher self wants you to build something lasting and to understand the spiritual value of the material world without becoming attached to it.",
                Gemini: "Your soul contract involves becoming a messenger. You are here to connect people, ideas, and realms. Your higher self thrives on curiosity and adaptability. The lesson is to find truth amidst chaos and to communicate it clearly, bridging the gap between dualities.",
                Cancer: "You are here to master the art of nurturing and emotional intelligence. Your soul contract is tied to ancestry, home, and the mother archetype. You must learn to give support without losing yourself, and to find a sense of belonging within your own heart rather than external places.",
                Leo: "A contract of self-expression and leadership. Your higher self wants you to shine, create, and lead from the heart. The lesson is to cultivate ego in a healthy way‚Äîrecognizing your own divinity so you can recognize it in others. You are here to bring warmth and joy.",
                Virgo: "Your soul chose a path of service and refinement. In this incarnation, you are refining your spirit through details, healing, and practical assistance. The goal is not perfectionism, but purity of intent and the understanding that the sacred is found in the ordinary.",
                Libra: "The soul contract of harmony. You are here to master relationships and balance. Your higher self seeks to unite opposites and create beauty. The lesson is to find peace without compromising your own truth, learning that true harmony comes from inner equilibrium.",
                Scorpio: "A powerful contract of transformation. You agreed to dive deep into the mysteries of life, death, and rebirth. Your higher self demands authenticity and power. You are here to heal the shadow self and to help others navigate their darkest transits.",
                Sagittarius: "Your soul is a seeker of truth. The contract involves exploring, teaching, and expanding horizons. You are here to find wisdom in diversity and to maintain faith even in darkness. Your higher self urges you to remain free and to share your optimistic vision.",
                Capricorn: "You have signed a contract of mastery and responsibility. Your soul wants you to build structures that support society. The lesson is about integrity, discipline, and managing power. You are here to leave a legacy and to learn that true authority comes from within.",
                Aquarius: "The soul purpose of the rebel and innovator. You are here to disrupt stagnant systems and bring future consciousness to the present. Your higher self values freedom and humanity. The lesson is to belong to the collective while remaining uniquely yourself.",
                Pisces: "A contract of spiritual transcendence. You are here to dissolve boundaries and learn unconditional love. Your higher self is connected to the divine source. The challenges involve staying grounded while navigating deep spiritual waters and practicing compassion."
            },
            tr: {
                Aries: "Ruhunuz bir √∂nc√º olmak i√ßin s√∂zle≈üme imzaladƒ±. Bu ya≈üamda, y√ºksek benliƒüiniz sizden cesaret, baƒüƒ±msƒ±zlƒ±k ve kendini ortaya koymayƒ± √∂ƒürenmenizi talep ediyor. Eski d√∂ng√ºleri kƒ±rmak ve yeni yollar ba≈ülatmak i√ßin buradasƒ±nƒ±z. Kar≈üƒ±la≈ütƒ±ƒüƒ±nƒ±z zorluklar kimliƒüinizi ≈üekillendirmek ve g√º√ßl√º olmanƒ±n g√ºvenli olduƒüunu √∂ƒüretmek i√ßindir.",
                Taurus: "Ruhsal amacƒ±nƒ±z huzuru ve √∂zdeƒüerinizi bulmakta yatar. ƒ∞stikrar, doƒüa ve kendi kendine yetme derslerini √∂ƒürenmeyi kabul ettiniz. Y√ºksek benliƒüiniz kalƒ±cƒ± bir ≈üey in≈üa etmenizi ve maddi d√ºnyaya baƒülanmadan onun ruhsal deƒüerini anlamanƒ±zƒ± istiyor.",
                Gemini: "Ruh s√∂zle≈ümeniz bir haberci olmayƒ± i√ßerir. ƒ∞nsanlarƒ±, fikirleri ve alemleri birbirine baƒülamak i√ßin buradasƒ±nƒ±z. Y√ºksek benliƒüiniz merak ve uyum yeteneƒüi ile beslenir. Dersiniz, kaosun i√ßinde ger√ßeƒüi bulmak ve onu net bir ≈üekilde ileterek ikilikler arasƒ±nda k√∂pr√º kurmaktƒ±r.",
                Cancer: "Besleme sanatƒ±nda ve duygusal zekada ustala≈ümak i√ßin buradasƒ±nƒ±z. Ruh s√∂zle≈ümeniz atalar, ev ve anne arketipi ile baƒülantƒ±lƒ±dƒ±r. Kendinizi kaybetmeden destek vermeyi ve aidiyet duygusunu dƒ±≈ü yerlerde deƒüil, kendi kalbinizde bulmayƒ± √∂ƒürenmelisiniz.",
                Leo: "Kendini ifade etme ve liderlik s√∂zle≈ümesi. Y√ºksek benliƒüiniz parlamanƒ±zƒ±, yaratmanƒ±zƒ± ve kalpten y√∂netmenizi istiyor. Ders, egoyu saƒülƒ±klƒ± bir ≈üekilde geli≈ütirmektir; kendi ilahiliƒüinizi tanƒ±yarak ba≈ükalarƒ±ndakini de tanƒ±yabilirsiniz. Sƒ±caklƒ±k ve ne≈üe getirmek i√ßin buradasƒ±nƒ±z.",
                Virgo: "Ruhunuz hizmet ve arƒ±nma yolunu se√ßti. Bu enkarnasyonda, detaylar, ≈üifa ve pratik yardƒ±m yoluyla ruhunuzu inceltiyorsunuz. Ama√ß m√ºkemmeliyet√ßilik deƒüil, niyetin saflƒ±ƒüƒ± ve kutsal olanƒ±n sƒ±radan olanda bulunduƒüunu anlamaktƒ±r.",
                Libra: "Uyum s√∂zle≈ümesi. ƒ∞li≈ükilerde ve dengede ustala≈ümak i√ßin buradasƒ±nƒ±z. Y√ºksek benliƒüiniz zƒ±tlƒ±klarƒ± birle≈ütirmeyi ve g√ºzellik yaratmayƒ± ama√ßlar. Ders, kendi ger√ßeƒüinizden √∂d√ºn vermeden barƒ±≈üƒ± bulmak ve ger√ßek uyumun i√ßsel dengeden geldiƒüini √∂ƒürenmektir.",
                Scorpio: "G√º√ßl√º bir d√∂n√º≈ü√ºm s√∂zle≈ümesi. Ya≈üam, √∂l√ºm ve yeniden doƒüu≈üun gizemlerine dalmayƒ± kabul ettiniz. Y√ºksek benliƒüiniz √∂zg√ºnl√ºk ve g√º√ß talep ediyor. G√∂lge benliƒüi iyile≈ütirmek ve ba≈ükalarƒ±nƒ±n en karanlƒ±k ge√ßi≈ülerinde onlara rehberlik etmek i√ßin buradasƒ±nƒ±z.",
                Sagittarius: "Ruhunuz bir hakikat arayƒ±cƒ±sƒ±dƒ±r. S√∂zle≈üme ke≈üfetmeyi, √∂ƒüretmeyi ve ufuklarƒ± geni≈ületmeyi i√ßerir. √áe≈üitlilikte bilgeliƒüi bulmak ve karanlƒ±kta bile inancƒ±nƒ±zƒ± korumak i√ßin buradasƒ±nƒ±z. Y√ºksek benliƒüiniz √∂zg√ºr kalmanƒ±zƒ± ve iyimser vizyonunuzu payla≈ümanƒ±zƒ± istiyor.",
                Capricorn: "Ustalƒ±k ve sorumluluk s√∂zle≈ümesi imzaladƒ±nƒ±z. Ruhunuz toplumu destekleyen yapƒ±lar in≈üa etmenizi istiyor. Ders d√ºr√ºstl√ºk, disiplin ve g√ºc√º y√∂netmekle ilgilidir. Bir miras bƒ±rakmak ve ger√ßek otoritenin i√ßeriden geldiƒüini √∂ƒürenmek i√ßin buradasƒ±nƒ±z.",
                Aquarius: "Asi ve yenilik√ßinin ruhsal amacƒ±. Durgun sistemleri bozmak ve gelecek bilincini ≈üimdiki zamana ta≈üƒ±mak i√ßin buradasƒ±nƒ±z. Y√ºksek benliƒüiniz √∂zg√ºrl√ºƒüe ve insanlƒ±ƒüa deƒüer verir. Ders, kolektife ait olurken aynƒ± zamanda benzersiz bir ≈üekilde kendiniz kalmaktƒ±r.",
                Pisces: "Ruhsal a≈ükƒ±nlƒ±k s√∂zle≈ümesi. Sƒ±nƒ±rlarƒ± √ß√∂zmek ve ko≈üulsuz sevgiyi √∂ƒürenmek i√ßin buradasƒ±nƒ±z. Y√ºksek benliƒüiniz ilahi kaynakla baƒülantƒ±lƒ±dƒ±r. Zorluklar, derin ruhsal sularda gezinirken ve ≈üefkat uygularken ayaklarƒ± yere basmayƒ± i√ßerir."
            }
        };

        const elementDescriptions = {
            en: {
                Fire: "This group is driven by passion, action, and enthusiasm. Decisions are made quickly, often on impulse. You inspire each other to take risks, but may struggle with patience or details. A high-energy squad!",
                Earth: "A grounded, practical, and reliable group. You value stability, tangible results, and common sense. While you may move slowly, you build things that last. Financially and structurally sound.",
                Air: "Communication is the lifeblood of this group. You love debating ideas, socializing, and exploring new concepts. It's a very intellectual and buzz-filled environment, though sometimes lacking emotional depth.",
                Water: "This group shares a deep emotional bond. Intuition, empathy, and feelings guide your interactions. You protect each other and understand unspoken moods, but can be prone to drama or mood swings."
            },
            tr: {
                Fire: "Bu grup tutku, eylem ve heyecanla y√∂netiliyor. Kararlar hƒ±zlƒ± ve genellikle d√ºrt√ºsel alƒ±nƒ±r. Birbirinizi risk almaya te≈üvik edersiniz, ancak sabƒ±r veya detaylarda zorlanabilirsiniz. Y√ºksek enerjili bir ekip!",
                Earth: "Ayaklarƒ± yere basan, pratik ve g√ºvenilir bir grup. ƒ∞stikrarƒ±, somut sonu√ßlarƒ± ve saƒüduyuyu √∂nemsersiniz. Biraz yava≈ü hareket edebilirsiniz ama kalƒ±cƒ± i≈üler ba≈üarƒ±rsƒ±nƒ±z. Maddi ve yapƒ±sal olarak saƒülam.",
                Air: "ƒ∞leti≈üim bu grubun can damarƒ±dƒ±r. Fikirleri tartƒ±≈ümayƒ±, sosyalle≈ümeyi ve yeni kavramlarƒ± ke≈üfetmeyi seversiniz. √áok entelekt√ºel ve hareketli bir ortamdƒ±r, ancak bazen duygusal derinlikten yoksun olabilir.",
                Water: "Bu grup derin bir duygusal baƒü payla≈üƒ±r. Sezgi, empati ve hisler etkile≈üimlerinize y√∂n verir. Birbirinizi korur ve s√∂ylenmemi≈ü ruh hallerini anlarsƒ±nƒ±z, ancak drama veya ruh hali deƒüi≈üimlerine yatkƒ±n olabilirsiniz."
            }
        };

        const astroTerms = {
            en: { Sun: "Sun", Moon: "Moon", Mercury: "Mercury", Venus: "Venus", Mars: "Mars", Jupiter: "Jupiter", Saturn: "Saturn", Uranus: "Uranus", Neptune: "Neptune", Pluto: "Pluto", 'North Node': "North Node", Aries: "Aries", Taurus: "Taurus", Gemini: "Gemini", Cancer: "Cancer", Leo: "Leo", Virgo: "Virgo", Libra: "Libra", Scorpio: "Scorpio", Sagittarius: "Sagittarius", Capricorn: "Capricorn", Aquarius: "Aquarius", Pisces: "Pisces" },
            tr: { Sun: "G√ºne≈ü", Moon: "Ay", Mercury: "Merk√ºr", Venus: "Ven√ºs", Mars: "Mars", Jupiter: "J√ºpiter", Saturn: "Sat√ºrn", Uranus: "Uran√ºs", Neptune: "Nept√ºn", Pluto: "Pl√ºton", 'North Node': "Kuzey Ay D√ºƒü√ºm√º", Aries: "Ko√ß", Taurus: "Boƒüa", Gemini: "ƒ∞kizler", Cancer: "Yenge√ß", Leo: "Aslan", Virgo: "Ba≈üak", Libra: "Terazi", Scorpio: "Akrep", Sagittarius: "Yay", Capricorn: "Oƒülak", Aquarius: "Kova", Pisces: "Balƒ±k" }
        };

        let currentData = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('draconic-res').innerHTML = translations['tr'].draconic_wait;
            document.getElementById('hours-res').innerHTML = translations['tr'].hours_wait;
            // Force Turkish Init
            changeLang('tr');
        });

        function changeLang(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });

            const activeView = document.querySelector('.view[style*="block"]');
            if (activeView) {
                if (activeView.id === 'view-daily') loadDaily();
                if (activeView.id === 'view-chart' && currentData) renderChart(currentData);
                if (activeView.id === 'view-draconic') renderDraconic(currentData);
                if (activeView.id === 'view-hours') renderHours(currentData);
                if (activeView.id === 'view-social') analyzeGroup();
                // Dynamic Career Refresh
                if (activeView.id === 'view-career') loadCareer();
            }

            if (lang === 'tr') {
                if (document.getElementById('soc-name')) document.getElementById('soc-name').placeholder = "ƒ∞sim";
            } else {
                if (document.getElementById('soc-name')) document.getElementById('soc-name').placeholder = "Name";
            }
        }

        function nav(view, el) {
            document.querySelectorAll('.view').forEach(e => e.style.display = 'none');
            document.getElementById('view-' + view).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');

            if (view === 'daily') loadDaily();
            if (view === 'draconic') renderDraconic(currentData);
            if (view === 'hours') renderHours(currentData);
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        // --- CALCULATOR ---
        async function calcChart() {
            const btn = document.querySelector('#view-chart button');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'NASA Engine Running...';
            document.getElementById('loader-chart').style.display = 'block';
            document.getElementById('res-chart').style.display = 'none';

            try {
                const res = await fetch('/api/calculate-chart/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: document.getElementById('date').value,
                        time: document.getElementById('time').value,
                        lat: document.getElementById('lat').value,
                        lon: document.getElementById('lon').value,
                        lang: document.getElementById('lang').value
                    })
                });
                const data = await res.json();

                if (data.error) {
                    alert("Engine Error: " + data.error);
                } else {
                    currentData = data;
                    renderChart(data);
                    if (currentUser) saveProfileToBackend();
                }
            } catch (e) { alert("Network/Server Error: " + e); }

            document.getElementById('loader-chart').style.display = 'none';
            btn.innerHTML = originalText;
        }

        function renderChart(data) {
            const el = document.getElementById('res-chart');
            el.style.display = 'block';
            const lang = document.getElementById('lang').value;
            const t = translations[lang];
            const terms = astroTerms[lang];

            // Translate Sun Sign
            let sunSign = data.meta?.sun_sign || "Unknown";
            if (terms[sunSign]) sunSign = terms[sunSign];

            // Translate Rising Sign
            let risingSign = data.meta?.rising_sign || "Unknown";
            if (terms[risingSign]) risingSign = terms[risingSign];

            let html = `<div class="glass-card" style="text-align:center">
                <div style="font-size:0.9rem; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.6); margin-bottom:5px">${lang === 'tr' ? 'G√ºne≈ü Burcu' : 'Sun Sign'}</div>
                <h2 style="font-size:3rem; color:var(--accent); margin-bottom:15px; line-height:1">${sunSign}</h2>
                
                <div style="margin-bottom:15px; font-size:0.85rem; color:var(--gold); opacity:0.9">
                     <i class="fas fa-map-marker-alt"></i> Timezone: ${data.meta?.local_timezone || 'LMT'}
                </div>

                <div style="background:rgba(255,255,255,0.1); padding:10px 20px; border-radius:30px; display:inline-block">
                     <span style="opacity:0.8">${t.t_rising}:</span> 
                     <span style="color:var(--gold); font-weight:bold; font-size:1.2rem; margin-left:5px">${risingSign}</span>
                </div>
                
                <div style="display:flex; justify-content:center; gap:20px; margin-top:20px">
                    <span>üíé ${data.meta?.lucky_stone || "-"}</span>
                    <span>üé® ${data.meta?.lucky_color || "-"}</span>
                </div>
            </div>`;

            html += `<div class="glass-card"><h3>${t.p_pos}</h3>`;
            if (data.planets) {
                data.planets.forEach(p => {
                    const pName = terms[p.name] || p.name;
                    const sName = terms[p.sign] || p.sign;
                    const title = lang === 'tr' ? `${sName} Burcunda ${pName}` : `${pName} in ${sName}`;

                    // Smart Selection of Interpretations
                    let text = p.interpretation || "";
                    if (p.interpretations && p.interpretations[lang]) {
                        text = p.interpretations[lang];
                    }

                    html += `<div class="planet-row"><div class="planet-icon">${p.name[0]}</div><div><h4 style="color:white">${title}</h4><p style="font-size:0.9rem; color:rgba(255,255,255,0.7); line-height:1.6; margin-top:5px">${text}</p></div></div>`;
                });
            }
            html += `</div>`;
            el.innerHTML = html;
        }

        // --- DRACONIC RENDER ---
        // Draconic Soul Keywords
        const draconicKeywords = {
            en: { Sun: "Core Soul Essence", Moon: "Emotional Karma", Mercury: "Spiritual Mind", Venus: "Higher Values", Mars: "Spiritual Drive", Jupiter: "Soul Wisdom", Saturn: "Karmic Responsibility", Uranus: "Soul Awakening", Neptune: "Divine Connection", Pluto: "Soul Power", 'North Node': "Destiny Path" },
            tr: { Sun: "Ruhun √ñz√º", Moon: "Duygusal Karma", Mercury: "Ruhsal Zihin", Venus: "Y√ºksek Deƒüerler", Mars: "Ruhsal D√ºrt√º", Jupiter: "Ruhsal Bilgelik", Saturn: "Karmik Sorumluluk", Uranus: "Ruhsal Uyanƒ±≈ü", Neptune: "ƒ∞lahi Baƒülantƒ±", Pluto: "Ruhsal G√º√ß", 'North Node': "Kader Yolu" }
        };

        function renderDraconic(data) {
            const div = document.getElementById('draconic-res');
            const lang = document.getElementById('lang').value;
            const t = translations[lang];
            const terms = astroTerms[lang];

            if (!data || !data.meta || !data.meta.draconic_chart || data.meta.draconic_chart.length === 0) {
                div.innerHTML = t.draconic_wait;
                return;
            }

            // Find Draconic Sun
            const dSun = data.meta.draconic_chart.find(p => p.name === 'Sun');
            const rawSign = dSun ? dSun.sign : "Aries";
            const signTranslated = terms[rawSign] || rawSign;
            const text = draconicInterpretations[lang][rawSign] || "Interpretation not found.";

            let html = `
             <div class="glass-card" style="border-left: 4px solid var(--accent); animation: fadeIn 0.4s; background: linear-gradient(to right, rgba(233,69,96,0.1), transparent)">
                <h2 style="color:var(--accent); font-size:1.8rem; margin-bottom:5px; text-transform:uppercase; letter-spacing:1px">${t.drac_title}</h2>
                <h3 style="color:white; margin-bottom:15px; font-weight:300; opacity:0.9">${t.draconic_sun_label}: <span style="color:var(--gold); font-weight:600">${signTranslated}</span></h3>
                <p style="font-size:1.1rem; line-height:1.8; color:rgba(255,255,255,0.9); text-align:justify; padding-right:10px">${text}</p>
             </div>
             `;

            html += `<div class="glass-card">
                <h3 style="margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px">${t.p_pos} (Draconic)</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px">`;

            data.meta.draconic_chart.forEach(p => {
                const pName = terms[p.name] || p.name;
                const sName = terms[p.sign] || p.sign;
                const keyword = draconicKeywords[lang][p.name] || "";

                // Smart Text Selection
                let planetText = p.interpretation || "No details available.";
                if (p.interpretations && p.interpretations[lang]) {
                    planetText = p.interpretations[lang];
                }

                html += `
                 <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:15px; cursor:pointer; transition:all 0.3s; position:relative; overflow:hidden" 
                      onclick="this.querySelector('.details').style.display = this.querySelector('.details').style.display === 'block' ? 'none' : 'block'; this.style.background = this.style.background.includes('0.1') ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.1)'">
                    
                    <div style="display:flex; align-items:center">
                        <div class="planet-icon" style="background:linear-gradient(135deg, var(--gradient-mid), var(--primary)); width:50px; height:50px; font-size:1.2rem; border:1px solid rgba(255,255,255,0.1); margin-right:15px; display:flex; align-items:center; justify-content:center; border-radius:50%; color:var(--gold)">${p.name[0]}</div>
                        <div style="flex:1">
                            <div style="font-size:0.75rem; color:var(--accent); text-transform:uppercase; letter-spacing:1px; margin-bottom:4px; opacity:0.8">${keyword}</div>
                            <div style="font-size:1.1rem; font-weight:600; color:white; margin-bottom:2px">${pName}</div>
                            <div style="font-size:0.95rem; color:rgba(255,255,255,0.6)">${sName}</div>
                        </div>
                        <div style="color:rgba(255,255,255,0.3)"><i class="fas fa-chevron-down"></i></div>
                    </div>

                    <div class="details" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.95rem; line-height:1.6; color:rgba(255,255,255,0.8); animation: fadeIn 0.3s">
                        ${planetText}
                    </div>
                 </div>`;
            });
            html += `</div></div>`;

            div.innerHTML = html;
        }

        function renderHours(data) {
            const div = document.getElementById('hours-res');
            const lang = document.getElementById('lang').value;
            const t = translations[lang];

            // --- Fallback Generator (Client Side) ---
            // Triggers if backend data is missing/empty to ensure UI never stuck on Loading
            if (!data || !Array.isArray(data) || data.length === 0) {
                console.warn("Using Client-Side Fallback for Planetary Hours");
                data = [];
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; // 0=Sun in JS? No, 0=Sun in JS Date.getDay()
                // Chaldean: Sat, Jup, Mar, Sun, Ven, Mer, Moo
                const chaldean = ['Saturn', 'Jupiter', 'Mars', 'Sun', 'Venus', 'Mercury', 'Moon'];
                const dayRulers = ['Sun', 'Moon', 'Mars', 'Mercury', 'Jupiter', 'Venus', 'Saturn']; // 0=Sun...

                const todayIdx = new Date().getDay(); // 0=Sun, 1=Mon...
                const startRuler = dayRulers[todayIdx];
                const startIdx = chaldean.indexOf(startRuler);

                for (let i = 0; i < 24; i++) {
                    const h = i;
                    const ruler = chaldean[(startIdx + i) % 7];
                    // Simple 06:00 Sunrise Assumption
                    const sTime = (h + 6) % 24;
                    const eTime = (h + 7) % 24;
                    data.push({
                        start: `${sTime < 10 ? '0' + sTime : sTime}:00`,
                        end: `${eTime < 10 ? '0' + eTime : eTime}:00`,
                        ruler: ruler
                    });
                }
            }

            const hourMeanings = {
                en: { Sun: "Success & Visibility", Moon: "Emotions & Family", Mercury: "Communication & Trade", Venus: "Love & Creativity", Mars: "Action & Courage", Jupiter: "Growth & Wealth", Saturn: "Focus & Discipline" },
                tr: { Sun: "Ba≈üarƒ± & G√∂r√ºn√ºrl√ºk", Moon: "Duygular & Aile", Mercury: "ƒ∞leti≈üim & Ticaret", Venus: "A≈ük & Yaratƒ±cƒ±lƒ±k", Mars: "Eylem & Cesaret", Jupiter: "B√ºy√ºme & Zenginlik", Saturn: "Odak & Disiplin" }
            };

            const icons = { Sun: '‚òÄÔ∏è', Moon: 'üåô', Mercury: '‚òøÔ∏è', Venus: '‚ôÄÔ∏è', Mars: '‚ôÇÔ∏è', Jupiter: '‚ôÉ', Saturn: '‚ôÑ' };
            const colors = { Sun: '#FFD700', Moon: '#C0C0C0', Mercury: '#87CEEB', Venus: '#FF69B4', Mars: '#FF4500', Jupiter: '#800080', Saturn: '#4B0082' };

            const planetDetails = {
                en: {
                    Sun: "The Hour of the Sun is perfect for professional ambition, asking for promotions, public speaking, and vitality works. Your charisma is naturally high.",
                    Moon: "The Hour of the Moon favors domestic activities, cooking, emotional bonding, and rest. A great time for introspection and family.",
                    Mercury: "The Hour of Mercury is the best time for sending emails, studying code, signing contracts, and short trips. Communication flows easily.",
                    Venus: "The Hour of Venus enhances romance, social gatherings, art, and beauty treatments. Indulge in life's pleasures and creative hobbies.",
                    Mars: "The Hour of Mars provides raw energy for workouts, tackling difficult tasks, and confronting challenges. Avoid arguments, channel the fire.",
                    Jupiter: "The Hour of Jupiter brings luck, wealth, and wisdom. Ideal for financial planning, learning new skills, and expansive thinking.",
                    Saturn: "The Hour of Saturn supports discipline, organization, and long-term planning. Good for tedious tasks requiring patience and focus."
                },
                tr: {
                    Sun: "G√ºne≈ü Saati kariyer hedefleri, terfi istemek, sunum yapmak ve otorite fig√ºrleriyle g√∂r√º≈ümek i√ßin m√ºkemmeldir. Karizmanƒ±z y√ºksektir.",
                    Moon: "Ay Saati ev i≈üleri, yemek pi≈üirmek, aileyle vakit ge√ßirmek ve dinlenmek i√ßin uygundur. Duygusal baƒülar ve i√ße d√∂n√º≈ü i√ßin harikadƒ±r.",
                    Mercury: "Merk√ºr Saati mail atmak, kod yazmak, anla≈üma imzalamak ve eƒüitim i√ßin en verimli zamandƒ±r. ƒ∞leti≈üim akƒ±cƒ±dƒ±r.",
                    Venus: "Ven√ºs Saati romantik bulu≈ümalar, sanatsal aktiviteler, alƒ±≈üveri≈ü ve bakƒ±m i√ßin idealdir. Keyifli anlarƒ±n tadƒ±nƒ± √ßƒ±karƒ±n.",
                    Mars: "Mars Saati spor yapmak, zorlu i≈üleri bitirmek ve cesaret gerektiren adƒ±mlar atmak i√ßin enerji verir. Tartƒ±≈ümalardan ka√ßƒ±nƒ±n.",
                    Jupiter: "J√ºpiter Saati ≈üans, bereket ve bilgelik getirir. Yatƒ±rƒ±m planlamak, yeni bir ≈üeyler √∂ƒürenmek ve vizyon √ßizmek i√ßin en iyi saattir.",
                    Saturn: "Sat√ºrn Saati disiplin, d√ºzenleme ve odaklanma gerektiren i≈üler i√ßin en iyisidir. Sabƒ±r isteyen projeleri bu saatte halledin."
                }
            };

            let html = `<div style="display:flex; flex-direction:column; gap:10px; animation:fadeIn 0.5s">`;

            const now = new Date();

            data.forEach((h, index) => {
                const planet = h.ruler;
                const meaning = hourMeanings[lang][planet] || "";
                const detail = planetDetails[lang][planet] || "";
                const uid = `ph-detail-${index}`;

                // Parse Time with Fail-safe
                const [sH, sM] = h.start.split(':').map(Number);
                const [eH, eM] = h.end.split(':').map(Number);

                let sDate = new Date(); sDate.setHours(sH, sM || 0, 0);
                let eDate = new Date(); eDate.setHours(eH, eM || 0, 0);

                // Handle late night crossing
                if (eDate <= sDate) eDate.setDate(eDate.getDate() + 1);

                // Relaxed "Active" check
                const isActive = (now >= sDate && now < eDate);

                const style = isActive
                    ? `background:linear-gradient(90deg, rgba(233,69,96,0.3), rgba(0,0,0,0)); border-left:4px solid var(--accent); padding:15px; margin-left:-5px; box-shadow:0 0 15px rgba(233,69,96,0.2)`
                    : `background:rgba(255,255,255,0.05); padding:12px; border-left:4px solid ${colors[planet] || '#fff'}`;

                html += `
                <div class="glass-card" 
                     onclick="document.getElementById('${uid}').style.display = document.getElementById('${uid}').style.display==='none'?'block':'none'; this.querySelector('.fa-chevron-down').style.transform = document.getElementById('${uid}').style.display==='none' ? 'rotate(0deg)' : 'rotate(180deg)';"
                     style="${style}; cursor:pointer; transition:all 0.3s">
                    
                    <div style="display:flex; align-items:center; justify-content:space-between">
                        <div style="display:flex; align-items:center; gap:15px">
                            <div style="font-family:'Courier New', monospace; font-size:1.1rem; opacity:0.8; width:110px; flex-shrink:0">${h.start} - ${h.end}</div>
                            <div style="font-size:1.5rem; width:30px; text-align:center">${icons[planet] || '‚≠ê'}</div>
                            <div>
                                <div style="font-weight:bold; font-size:1rem; color:white">${planet} ${lang === 'tr' ? 'Saati' : 'Hour'}</div>
                                <div style="font-size:0.8rem; color:${colors[planet]}; opacity:0.9; letter-spacing:0.5px; text-transform:uppercase">${meaning}</div>
                            </div>
                        </div>
                        ${isActive ? `<div style="background:var(--accent); color:white; padding:4px 10px; border-radius:20px; font-size:0.7rem; font-weight:bold; margin-right:10px; animation:pulse 2s infinite">NOW</div>` : ''}
                        <div style="opacity:0.5"><i class="fas fa-chevron-down" style="transition:transform 0.3s"></i></div>
                    </div>

                    <div id="${uid}" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.95rem; line-height:1.6; color:rgba(255,255,255,0.8); animation: fadeIn 0.3s">
                        ${detail}
                    </div>

                </div>`;
            });

            html += `</div>`;
            div.innerHTML = html;
        }

        // --- SYNASTRY ---
        // --- SYNASTRY ---
        async function calcSynastry() {
            const btn = document.querySelector('#view-synastry button');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Calculating...';

            const date1 = document.getElementById('date').value;
            const date2 = document.getElementById('syn-date').value;
            const lang = document.getElementById('lang').value;
            const t = translations[lang];

            try {
                const res = await fetch('/api/calculate-synastry/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date1, time1: "12:00", date2, time2: "12:00", lang })
                });
                const data = await res.json();
                const resDiv = document.getElementById('syn-res');
                const terms = astroTerms[lang];

                // Advanced Grouping
                const groups = {
                    'Soul Connection': [], 'Attraction': [], 'Communication': [], 'Challenges': []
                };

                let lovePoints = 0;
                let commPoints = 0;

                if (data.aspects) {
                    data.aspects.forEach(a => {
                        // Map backend themes to display groups
                        let target = 'Communication';
                        if (a.theme === 'Attraction' || a.is_romance) target = 'Attraction';
                        if (a.category === 'Tension' || a.category === 'Conflict') target = 'Challenges';
                        if (a.theme === 'Growth' || (a.is_romance && a.category === 'Harmony')) target = 'Soul Connection';

                        groups[target].push(a);

                        // Points
                        if (target === 'Attraction' || target === 'Soul Connection') lovePoints++;
                        if (target === 'Communication') commPoints++;
                    });
                }

                // Strength Calculation
                const loveStrength = Math.min(100, lovePoints * 20 + 20);
                const commStrength = Math.min(100, commPoints * 25 + 20);

                const aspectTerms = {
                    en: { Conjunction: "Conjunction", Opposition: "Opposition", Square: "Square", Trine: "Trine", Sextile: "Sextile" },
                    tr: { Conjunction: "Kavu≈üum", Opposition: "Kar≈üƒ±t", Square: "Kare", Trine: "√ú√ßgen", Sextile: "Sekstil" }
                };

                // Helper for Lists
                const renderList = (list, icon) => {
                    if (!list.length) return `<div style="opacity:0.6; font-size:0.9rem; font-style:italic">${lang === 'tr' ? '√ñnemli a√ßƒ± bulunamadƒ±.' : 'No major aspects found.'}</div>`;

                    return list.map((a, idx) => {
                        const p1 = terms[a.p1] || a.p1;
                        const p2 = terms[a.p2] || a.p2;
                        const typeVal = aspectTerms[lang][a.type] || a.type;
                        const uid = `syn-item-${Math.random().toString(36).substr(2, 9)}`;

                        return `
                        <div style="background:rgba(255,255,255,0.03); border-radius:8px; margin-bottom:8px; overflow:hidden; transition:background 0.3s">
                            <div onclick="const d=document.getElementById('${uid}'); const c=this.querySelector('.fa-chevron-down'); if(d.style.display==='none'){d.style.display='block'; c.style.transform='rotate(180deg)'; this.parentElement.style.background='rgba(255,255,255,0.08)'}else{d.style.display='none'; c.style.transform='rotate(0deg)'; this.parentElement.style.background='rgba(255,255,255,0.03)'}" 
                                 style="padding:10px 12px; cursor:pointer; display:flex; align-items:center; justify-content:space-between">
                                <div style="display:flex; align-items:center; gap:10px; font-size:0.95rem">
                                    <span style="color:var(--accent); font-size:1.1rem">${icon}</span>
                                    <span><b>${p1}</b> ${typeVal} <b>${p2}</b></span>
                                </div>
                                <i class="fas fa-chevron-down" style="font-size:0.8rem; opacity:0.5; transition:transform 0.3s"></i>
                            </div>
                            <div id="${uid}" style="display:none; padding:12px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.9rem; line-height:1.6; color:rgba(255,255,255,0.9)">
                                ${a.interpretation || 'No detail available.'}
                            </div>
                        </div>`;
                    }).join('');
                };

                let html = `
                <div style="animation:fadeIn 0.5s">
                    <!-- Score Card -->
                    <div class="glass-card" style="text-align:center; padding:30px; border-bottom: 4px solid var(--accent)">
                        <h4 style="letter-spacing:3px; opacity:0.8; margin-bottom:10px">${lang === 'tr' ? 'UYUM SKORU' : 'COMPATIBILITY SCORE'}</h4>
                        <div style="font-size:5rem; font-weight:800; color:var(--accent); line-height:1; margin-bottom:10px; text-shadow:0 0 20px rgba(233,69,96,0.3)">${data.score}%</div>
                        <p style="font-size:1.3rem; font-style:italic; opacity:0.9; max-width:600px; margin:0 auto">"${data.summary}"</p>
                    </div>

                    <!-- Meters -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px">
                         <div class="glass-card" style="padding:15px">
                            <h4 style="margin-bottom:10px"><i class="fas fa-heart" style="color:#e91e63"></i> ${lang === 'tr' ? 'Romantik √áekim' : 'Romantic Attraction'}</h4>
                            <div style="background:rgba(255,255,255,0.1); border-radius:10px; height:10px; width:100%"><div style="width:${loveStrength}%; background:#e91e63; height:100%; border-radius:10px; transition:width 1s"></div></div>
                            <div style="text-align:right; font-size:0.8rem; margin-top:5px; opacity:0.8">${loveStrength > 70 ? (lang === 'tr' ? '√áok G√º√ßl√º' : 'Very Strong') : (lang === 'tr' ? 'Orta Seviye' : 'Moderate')}</div>
                         </div>
                         <div class="glass-card" style="padding:15px">
                            <h4 style="margin-bottom:10px"><i class="fas fa-comments" style="color:#03a9f4"></i> ${lang === 'tr' ? 'ƒ∞leti≈üim' : 'Communication'}</h4>
                            <div style="background:rgba(255,255,255,0.1); border-radius:10px; height:10px; width:100%"><div style="width:${commStrength}%; background:#03a9f4; height:100%; border-radius:10px; transition:width 1s"></div></div>
                            <div style="text-align:right; font-size:0.8rem; margin-top:5px; opacity:0.8">${commStrength > 70 ? (lang === 'tr' ? 'Akƒ±≈ükan' : 'Fluid') : (lang === 'tr' ? 'Geli≈ütirilebilir' : 'Needs Work')}</div>
                         </div>
                    </div>

                    <!-- Detailed Analysis Categories -->
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-top:20px">
                        
                        <!-- Soul Connection -->
                        <div class="glass-card">
                            <h3 style="color:#9c27b0; margin-bottom:15px"><i class="fas fa-infinity"></i> ${lang === 'tr' ? 'Ruhsal Baƒü' : 'Soul Connection'}</h3>
                            ${renderList(groups['Soul Connection'], '‚ú®')}
                            <p style="font-size:0.85rem; opacity:0.7; margin-top:10px; line-height:1.4">
                                ${lang === 'tr' ? 'Bu a√ßƒ±lar ili≈ükinin kadersel ve derin y√∂n√ºn√º g√∂sterir. Uzun vadeli baƒüƒ±n temelidir.' : 'These aspects indicate the karmic and deep nature of the relationship. The foundation of a long-term bond.'}
                            </p>
                        </div>

                        <!-- Attraction -->
                        <div class="glass-card">
                            <h3 style="color:#e91e63; margin-bottom:15px"><i class="fas fa-fire"></i> ${lang === 'tr' ? 'Tutku & √áekim' : 'Passion & Attraction'}</h3>
                            ${renderList(groups['Attraction'], 'üî•')}
                             <p style="font-size:0.85rem; opacity:0.7; margin-top:10px; line-height:1.4">
                                ${lang === 'tr' ? 'Fiziksel ve romantik enerjinin kaynaƒüƒ±. ƒ∞li≈ükinin heyecanƒ±nƒ± belirler.' : 'The source of physical and romantic energy. Determines the excitement of the relationship.'}
                            </p>
                        </div>

                        <!-- Challenges -->
                        <div class="glass-card">
                            <h3 style="color:#ff9800; margin-bottom:15px"><i class="fas fa-exclamation-circle"></i> ${lang === 'tr' ? 'Geli≈üim Alanlarƒ±' : 'Challenges'}</h3>
                            ${renderList(groups['Challenges'], '‚ö†Ô∏è')}
                             <p style="font-size:0.85rem; opacity:0.7; margin-top:10px; line-height:1.4">
                                ${lang === 'tr' ? 'Bu alanlar ili≈ükinin dersleridir. Sabƒ±r ve anlayƒ±≈üla a≈üƒ±ldƒ±ƒüƒ±nda baƒüƒ± g√º√ßlendirir.' : 'These are the lessons of the relationship. When overcome with patience, they strengthen the bond.'}
                            </p>
                        </div>

                    </div>
                </div>`;

                resDiv.innerHTML = html;
            } catch (e) { alert("Error: " + e); }
            btn.innerHTML = originalText;
        }

        // --- SOCIAL ---
        let members = [];
        async function addMember() {
            const nameInp = document.getElementById('soc-name');
            const dateInp = document.getElementById('soc-date');
            if (!nameInp.value || !dateInp.value) return alert("Enter name and date");
            const btn = document.querySelector('#view-social button');
            const originalText = btn.innerHTML; btn.innerHTML = '...';

            try {
                const res = await fetch('/api/calculate-chart/', { method: 'POST', body: JSON.stringify({ date: dateInp.value, time: "12:00", lat: 41.0, lon: 28.0, lang: document.getElementById('lang').value }) });
                const data = await res.json();
                if (data.error) alert(data.error);
                else { members.push({ name: nameInp.value, dominants: data.meta.dominants }); renderMembers(); analyzeGroup(); nameInp.value = ""; }
            } catch (e) { }
            btn.innerHTML = originalText;
        }
        function renderMembers() {
            const list = document.getElementById('member-list'); list.innerHTML = "";
            members.forEach((m, i) => list.innerHTML += `<div class="planet-row"><div class="planet-icon"><i class="fas fa-user"></i></div><div style="flex:1">${m.name}</div><i class="fas fa-trash" style="color:#ff4444; cursor:pointer" onclick="removeMember(${i})"></i></div>`);
        }
        function removeMember(i) { members.splice(i, 1); renderMembers(); analyzeGroup(); }
        function analyzeGroup() {
            const resDiv = document.getElementById('social-res');
            const lang = document.getElementById('lang').value;
            const t = translations[lang];

            if (members.length === 0) { resDiv.innerHTML = `<p style="opacity:0.6; font-style:italic">${t.soc_placeholder}</p>`; return; }

            // 1. Calculate Element Totals & Individual Roles
            let totals = { Fire: 0, Earth: 0, Air: 0, Water: 0 };
            const roles = [];

            members.forEach(m => {
                if (m.dominants) {
                    totals.Fire += m.dominants.Fire || 0;
                    totals.Earth += m.dominants.Earth || 0;
                    totals.Air += m.dominants.Air || 0;
                    totals.Water += m.dominants.Water || 0;

                    // Assign Role
                    const pMax = Math.max(m.dominants.Fire, m.dominants.Earth, m.dominants.Air, m.dominants.Water);
                    let role = "Member";
                    if (pMax === m.dominants.Fire) role = lang === 'tr' ? '√ñnc√º (Ate≈ü)' : 'The Spark (Fire)';
                    else if (pMax === m.dominants.Earth) role = lang === 'tr' ? 'Kurucu (Toprak)' : 'The Builder (Earth)';
                    else if (pMax === m.dominants.Air) role = lang === 'tr' ? 'Fikirci (Hava)' : 'The Thinker (Air)';
                    else if (pMax === m.dominants.Water) role = lang === 'tr' ? 'Duygusal Baƒü (Su)' : 'The Heart (Water)';
                    roles.push({ name: m.name, role: role });
                }
            });

            const totalScore = totals.Fire + totals.Earth + totals.Air + totals.Water;
            if (totalScore === 0) return;
            const pct = (v) => Math.round((v / totalScore) * 100);

            // 2. Identify Dominant & Weakest
            const sortedElements = Object.entries(totals).sort((a, b) => b[1] - a[1]);
            const domElement = sortedElements[0][0];
            const weakElement = sortedElements[3][0];

            // 3. Vibe Analysis
            let vibeTitle = "";
            let vibeDesc = "";

            // Complex Vibe Logic
            if (domElement === 'Fire') {
                vibeTitle = lang === 'tr' ? "Y√ºksek Enerji & Eylem" : "High Voltage & Action";
                vibeDesc = lang === 'tr' ? "Bu grup yerinde duramaz! Macera, risk ve ba≈ülatma enerjisi √ßok y√ºksek." : "This group is unstoppable! High energy for adventure, risk-taking, and starting new things.";
            } else if (domElement === 'Earth') {
                vibeTitle = lang === 'tr' ? "Saƒülam & √úretken" : "Solid & Productive";
                vibeDesc = lang === 'tr' ? "Ayaklarƒ± yere basan bir ekip. Somut sonu√ßlar ve finansal ba≈üarƒ± odaklƒ±." : "A grounded team focused on tangible results, stability, and financial success.";
            } else if (domElement === 'Air') {
                vibeTitle = lang === 'tr' ? "Zeka & ƒ∞leti≈üim" : "Intellectual & Social";
                vibeDesc = lang === 'tr' ? "Fikirler havada u√ßu≈üuyor. Sohbet hi√ß bitmez, s√ºrekli yeni planlar yapƒ±lƒ±r." : "Ideas are flowing non-stop. Endless conversation and constant new planning.";
            } else { // Water
                vibeTitle = lang === 'tr' ? "Derin Baƒülar & Empati" : "Deep Bonds & Empathy";
                vibeDesc = lang === 'tr' ? "Birbirini hisseden bir aile gibi. Duygusal destek ve sezgiler √∂n planda." : "Like a family that feels each other. Emotional support and intuition are the priority.";
            }

            // Warning
            let warning = "";
            if (totals[weakElement] < totalScore * 0.15) { // If less than 15%
                if (weakElement === 'Fire') warning = lang === 'tr' ? "‚ö†Ô∏è Eksik Ate≈ü: Harekete ge√ßmekte zorlanabilirsiniz." : "‚ö†Ô∏è Low Fire: You might struggle to take action.";
                if (weakElement === 'Earth') warning = lang === 'tr' ? "‚ö†Ô∏è Eksik Toprak: Planlarƒ± somutla≈ütƒ±rmak zor olabilir." : "‚ö†Ô∏è Low Earth: Hard to make plans reality.";
                if (weakElement === 'Air') warning = lang === 'tr' ? "‚ö†Ô∏è Eksik Hava: ƒ∞leti≈üim kopukluklarƒ± ya≈üanabilir." : "‚ö†Ô∏è Low Air: Communication might get stuck.";
                if (weakElement === 'Water') warning = lang === 'tr' ? "‚ö†Ô∏è Eksik Su: Duygusal baƒülar zayƒ±f kalabilir." : "‚ö†Ô∏è Low Water: Emotional depth might be lacking.";
            }

            // 4. Render Rich Dashboard
            let html = `
            <div style="animation:fadeIn 0.5s">
                <div class="glass-card" style="background:linear-gradient(135deg, rgba(233,69,96,0.1), rgba(26,26,46,0.8)); border:1px solid var(--accent)">
                    <h2 style="color:var(--gold); text-transform:uppercase; letter-spacing:2px; font-size:1rem; margin-bottom:5px">${lang === 'tr' ? 'GRUP AURASI' : 'GROUP AURA'}</h2>
                    <h1 style="font-size:2.2rem; margin-bottom:10px">${vibeTitle}</h1>
                    <p style="font-size:1.1rem; line-height:1.6; opacity:0.9">${vibeDesc}</p>
                    ${warning ? `<div style="background:rgba(255,200,0,0.15); color:#ffd700; padding:10px; border-radius:8px; margin-top:15px; font-size:0.9rem"><i class="fas fa-exclamation-triangle"></i> ${warning}</div>` : ''}
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px">
                    <div class="glass-card">
                        <h3 style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px">${lang === 'tr' ? 'Element Dengesi' : 'Elemental Balance'}</h3>
                        <div style="display:flex; flex-direction:column; gap:10px">
                            <div><span style="color:#e25822">üî• Fire</span> <div style="width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:4px"><div style="width:${pct(totals.Fire)}%; background:#e25822; height:100%; border-radius:4px"></div></div></div>
                            <div><span style="color:#bada55">üåø Earth</span> <div style="width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:4px"><div style="width:${pct(totals.Earth)}%; background:#bada55; height:100%; border-radius:4px"></div></div></div>
                            <div><span style="color:#a4dcf5">üí® Air</span> <div style="width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:4px"><div style="width:${pct(totals.Air)}%; background:#a4dcf5; height:100%; border-radius:4px"></div></div></div>
                            <div><span style="color:#1ca3ec">üíß Water</span> <div style="width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:4px"><div style="width:${pct(totals.Water)}%; background:#1ca3ec; height:100%; border-radius:4px"></div></div></div>
                        </div>
                    </div>

                    <div class="glass-card">
                        <h3 style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px">${lang === 'tr' ? 'Kozmik Roller' : 'Cosmic Roles'}</h3>
                        <div style="display:flex; flex-direction:column; gap:10px">
                            ${roles.map(r => `
                                <div style="display:flex; align-items:center; gap:10px">
                                    <div style="width:30px; height:30px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center"><i class="fas fa-user-astronaut"></i></div>
                                    <div>
                                        <div style="font-weight:bold">${r.name}</div>
                                        <div style="font-size:0.8rem; color:var(--accent)">${r.role}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>`;

            resDiv.innerHTML = html;
        }

        // DAILY
        let chartInstance = null;
        async function loadDaily() {
            const lang = document.getElementById('lang').value;

            try {
                // No date param, defaults to Now (Today -> Future)
                const wRes = await fetch(`/api/weekly-forecast/?lang=${lang}`);
                const wData = await wRes.json();

                // Chart
                const ctx = document.getElementById('weeklyChart').getContext('2d');
                if (chartInstance) chartInstance.destroy();

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: wData.forecast.map(d => d.day),
                        datasets: [
                            { label: lang === 'tr' ? 'Genel' : 'General', data: wData.forecast.map(d => d.score), borderColor: '#E94560', backgroundColor: 'rgba(233,69,96,0.1)', tension: 0.4, fill: true },
                            { label: lang === 'tr' ? 'A≈ük' : 'Love', data: wData.forecast.map(d => d.love), borderColor: '#d63384', borderDash: [5, 5], tension: 0.4, fill: false },
                            { label: lang === 'tr' ? 'Kariyer' : 'Career', data: wData.forecast.map(d => d.career), borderColor: '#FFD700', borderDash: [2, 2], tension: 0.4, fill: false }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { labels: { color: 'white' } } },
                        scales: { y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { grid: { display: false } } }
                    }
                });

                // Fortune List
                const listDiv = document.getElementById('daily-list');
                let listHtml = "";
                wData.forecast.forEach(d => {
                    let scoreColor = '#E94560';
                    if (d.score > 70) scoreColor = '#4caf50';
                    if (d.score > 40 && d.score <= 70) scoreColor = '#FFD700';

                    listHtml += `
                    <div style="display:flex; gap:15px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); align-items:center">
                        <div style="text-align:center; min-width:60px">
                            <div style="font-size:0.9rem; opacity:0.7">${d.day.split(' ')[0]}</div>
                            <div style="font-size:1.2rem; font-weight:bold">${d.day.split(' ')[1]}</div>
                        </div>
                        <div style="flex:1">
                            <div style="font-size:1rem; margin-bottom:4px; color:rgba(255,255,255,0.9)">${d.comment}</div>
                            <div style="display:flex; gap:10px; font-size:0.8rem; opacity:0.6">
                                <span>‚ù§Ô∏è ${d.love}%</span> <span>üíº ${d.career}%</span>
                            </div>
                        </div>
                        <div style="font-size:1.5rem; font-weight:bold; color:${scoreColor}">${d.score}</div>
                    </div>`;
                });
                listDiv.innerHTML = listHtml;

                // Daily Tip (Generic)
                const dRes = await fetch(`/api/daily-planner/?lang=${lang}`);
                const dData = await dRes.json();
                document.getElementById('daily-text').innerText = dData.daily_summary || "";

                // Render Real Planetary Hours
                if (dData.hours && typeof renderHours === 'function') {
                    renderHours(dData.hours);
                }
            } catch (e) { console.error(e); }
        }

        // ==========================================
        // DYNAMIC LOCATION SELECTOR (API)
        // ==========================================

        // ==========================================
        // DYNAMIC LOCATION SELECTOR (API)
        // ==========================================

        async function loadCountries() {
            const lang = document.getElementById('lang').value;
            const cSel = document.getElementById('loc-country');
            cSel.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch('/api/countries/');
                const data = await res.json();

                if (data.countries) {
                    let html = `<option value="">${lang === 'tr' ? '√úlke Se√ßiniz' : 'Select Country'}</option>`;
                    data.countries.forEach(c => {
                        const selected = (c.code === 'TR') ? 'selected' : '';
                        html += `<option value="${c.code}" ${selected}>${c.name}</option>`;
                    });
                    cSel.innerHTML = html;
                    cSel.value = "TR";
                    loadProvinces(); // Changed from loadCities
                }
            } catch (e) {
                console.error(e);
                cSel.innerHTML = '<option value="">Error</option>';
            }
        }

        async function loadProvinces() {
            const lang = document.getElementById('lang').value;
            const code = document.getElementById('loc-country').value;
            const pSel = document.getElementById('loc-province');
            const cSel = document.getElementById('loc-city');

            // Reset City
            cSel.innerHTML = `<option value="">${lang === 'tr' ? '√ñnce ƒ∞l Se√ßiniz...' : 'Select Province First...'}</option>`;

            if (!code) {
                pSel.style.display = 'none';
                return;
            }

            pSel.innerHTML = '<option value="">Loading...</option>';
            pSel.style.display = 'block'; // Show it

            try {
                const res = await fetch(`/api/provinces/?code=${code}`);
                const data = await res.json();

                // If we have provinces
                if (data.provinces && data.provinces.length > 0) {
                    let html = `<option value="">${lang === 'tr' ? 'ƒ∞l Se√ßiniz' : 'Select Province'}</option>`;
                    data.provinces.forEach(p => {
                        html += `<option value="${p.code}">${p.name}</option>`;
                    });
                    pSel.innerHTML = html;
                    pSel.style.display = 'block';
                } else {
                    // No provinces found (flat country?), hide province sel and load cities directly
                    pSel.style.display = 'none';
                    pSel.innerHTML = '<option value="">-</option>';
                    loadCities();
                }
            } catch (e) {
                console.error(e);
                pSel.style.display = 'none';
                // Fallback to loading cities directly if province fetch fails?
                loadCities();
            }
        }

        async function loadCities() {
            const lang = document.getElementById('lang').value;
            const countryCode = document.getElementById('loc-country').value;
            const provinceCode = document.getElementById('loc-province').value;
            const citySel = document.getElementById('loc-city');

            if (!countryCode) return;

            // If Province is visible but not selected, wait
            const pSel = document.getElementById('loc-province');
            if (pSel.style.display !== 'none' && !provinceCode) {
                citySel.innerHTML = `<option value="">${lang === 'tr' ? '≈ûehir/ƒ∞l√ße Se√ßiniz' : 'Select City/District'}</option>`;
                return;
            }

            citySel.innerHTML = '<option value="">Loading...</option>';

            try {
                // Fetch cities, passing admin_code if available
                let url = `/api/cities/?code=${countryCode}`;
                if (provinceCode) {
                    url += `&admin_code=${provinceCode}`;
                }

                const res = await fetch(url);
                const data = await res.json();

                if (data.cities) {
                    let html = `<option value="">${lang === 'tr' ? 'ƒ∞l√ße Se√ßiniz' : 'Select District'}</option>`;
                    data.cities.forEach(c => {
                        html += `<option value="${c.lat},${c.lon}">${c.name}</option>`;
                    });
                    citySel.innerHTML = html;
                }
            } catch (e) {
                console.error(e);
                citySel.innerHTML = '<option value="">Error</option>';
            }
        }

        function setCityCoords() {
            const val = document.getElementById('loc-city').value;
            if (val) {
                const [lat, lon] = val.split(',');
                document.getElementById('lat').value = lat;
                document.getElementById('lon').value = lon;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCountries();
        });
    </script>

    <!-- AUTH LOGIC SCRIPT -->
    <script>
        let isRegistering = false;
        let currentUser = null;

        // Auto Check on Load
        document.addEventListener('DOMContentLoaded', () => {
            loadRegCountries();
            checkAuth();
        });

        async function checkAuth() {
            try {
                const res = await fetch('/api/check-auth/');
                const data = await res.json();

                if (data.authenticated) {
                    // SHOW APP
                    document.getElementById('landing-root').style.display = 'none';
                    document.getElementById('app-root').style.display = 'flex';

                    currentUser = data.username;
                    updateAuthUI(true, data.username);
                    document.getElementById('auth-modal').style.display = 'none';

                    if (data.is_superuser) {
                        document.getElementById('admin-nav-item').style.display = 'flex';
                    }

                    // Auto-Fill & Lock Profile Data
                    if (data.profile) {
                        const dateEl = document.getElementById('date');
                        const timeEl = document.getElementById('time');
                        const latEl = document.getElementById('lat');
                        const lonEl = document.getElementById('lon');

                        if (data.profile.date) {
                            dateEl.value = data.profile.date;
                            dateEl.disabled = true;
                            dateEl.style.opacity = '0.7';
                        }
                        if (data.profile.time) {
                            timeEl.value = data.profile.time;
                            timeEl.disabled = true;
                            timeEl.style.opacity = '0.7';
                        }
                        if (data.profile.lat) {
                            latEl.value = data.profile.lat;
                            latEl.disabled = true;
                            latEl.style.opacity = '0.7';
                        }
                        if (data.profile.lon) {
                            lonEl.value = data.profile.lon;
                            lonEl.disabled = true;
                            lonEl.style.opacity = '0.7';
                        }

                        // Lock Location
                        document.getElementById('main-loc-container').style.display = 'none';
                        const lockedInput = document.getElementById('locked-loc-input');

                        lockedInput.style.display = 'block';
                        lockedInput.value = data.profile.place || (data.profile.lat ? `${data.profile.lat}, ${data.profile.lon}` : "Location Unknown");
                    }
                } else {
                    // SHOW LANDING
                    document.getElementById('landing-root').style.display = 'flex';
                    document.getElementById('app-root').style.display = 'none';

                    updateAuthUI(false);
                    loadDailyHoroscopes(); // Fetch data
                }
            } catch (e) { console.error("Auth check failed", e); }
        }



        async function loadDailyHoroscopes() {
            try {
                const lang = document.getElementById('lang').value;
                const container = document.getElementById('horo-grid');
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';

                const res = await fetch(`/api/daily-horoscopes/?lang=${lang}`);
                const data = await res.json();

                if (!data.horoscopes) return;

                container.innerHTML = data.horoscopes.map((h, i) => `
                    <div class="horo-card" onclick="toggleHoro(this)">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <div style="font-size:1.5rem; font-weight:bold; color:var(--text)">${h.sign}</div>
                            <div style="font-size:2rem; filter:drop-shadow(0 0 10px var(--accent))">${h.mood}</div>
                        </div>
                        <div style="font-size:0.8rem; opacity:0.6; margin-top:5px">${h.date} - G√ºnl√ºk Yorum</div>
                        
                        <div class="horo-content">
                            <p>${h.text}</p>
                            <div style="margin-top:15px; text-align:right">
                                <button onclick="event.stopPropagation(); startLoginProcess()" 
                                        style="background:transparent; border:1px solid var(--accent); color:var(--accent); padding:5px 15px; border-radius:20px; cursor:pointer; font-size:0.8rem">
                                    Daha Fazlasƒ± ƒ∞√ßin Giri≈ü Yap <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (e) { console.error(e); }
        }

        function toggleHoro(el) {
            // Uncollapse others
            document.querySelectorAll('.horo-card.active').forEach(c => {
                if (c !== el) {
                    c.classList.remove('active');
                    c.querySelector('.horo-content').style.display = 'none';
                }
            });

            el.classList.toggle('active');
            const content = el.querySelector('.horo-content');
            content.style.display = el.classList.contains('active') ? 'block' : 'none';

            // Smoother scroll if needed
            if (el.classList.contains('active')) {
                el.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }

        // Modal Controls (ROBUST IMPLEMENTATION)
        // Modal Controls (ROBUST IMPLEMENTATION)
        function openAuthModal() {
            const modal = document.getElementById('auth-modal');
            if (modal) {
                // Force Reset Styles
                modal.style.display = 'flex';
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'auto';

                // Initialize Tabs
                switchAuthTab('login');

                // Load Location Data if needed
                if (typeof loadRegCountries === 'function') {
                    const cSel = document.getElementById('reg-country');
                    if (cSel && cSel.options.length <= 1) loadRegCountries();
                }

                // Pre-fill Date/Time from Landing Inputs
                const mainDate = document.getElementById('date');
                const mainTime = document.getElementById('time');
                if (mainDate && document.getElementById('auth-date')) document.getElementById('auth-date').value = mainDate.value;
                if (mainTime && document.getElementById('auth-time')) document.getElementById('auth-time').value = mainTime.value;
            }
        }
        // Auth Logic Removed - Handled by Landing Page


        function updateAuthUI(isLoggedIn, name) {
            const btnLogin = document.getElementById('btn-login-trig');
            const btnLogout = document.getElementById('btn-logout-trig');
            const userDisplay = document.getElementById('user-display');

            if (isLoggedIn) {
                btnLogin.style.display = 'none';
                btnLogout.style.display = 'flex';
                userDisplay.innerHTML = `<i class="fas fa-user-circle"></i> ${name}`;
                userDisplay.style.display = 'block';
            } else {
                btnLogin.style.display = 'flex';
                btnLogout.style.display = 'none';
                userDisplay.style.display = 'none';
            }
        }

        // Duplicate scripts removed to ensure stability
        async function doLogout() {
            await fetch('/api/logout/');
            location.reload();
        }

        // Auto-Save Hook: Call this after successful chart calculation
        async function saveProfileToBackend() {
            if (!currentUser) return; // Only for logged in users

            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;

            // Try to find place name
            let placeName = "Unknown";
            const citySel = document.getElementById('loc-city');
            if (citySel && citySel.options.length > 0 && citySel.selectedIndex >= 0) {
                placeName = citySel.options[citySel.selectedIndex].text;
            }

            try {
                await fetch('/api/update-profile/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, time, lat, lon, place: placeName })
                });
                console.log("Profile auto-saved.");
            } catch (e) { console.error("Save failed", e); }
        }
    </script>

</body>

</html>