{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{% static 'astrology/favicon.png' %}?v=2">
    <link rel="shortcut icon" type="image/png" href="{% static 'astrology/favicon.png' %}?v=2">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTRO | Deep Cosmos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0F0C29;
            --gradient-start: #0F0C29;
            --gradient-mid: #302B63;
            --gradient-end: #24243E;
            --accent: #E94560;
            --gold: #FFD700;
            --text: #EEEEEE;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-mid), var(--gradient-end));
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3 {
            font-family: 'Cinzel', serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: rgba(15, 12, 41, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            padding: 2rem;
            position: fixed;
            height: 100vh;
            transition: transform 0.3s;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 1.8rem;
            color: var(--gold);
            margin-bottom: 3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .nav-item:hover,
        .nav-item.active {
            background: linear-gradient(90deg, rgba(233, 69, 96, 0.2), transparent);
            color: var(--text);
            border-left: 3px solid var(--accent);
        }

        .main {
            margin-left: 280px;
            flex: 1;
            padding: 3rem;
        }

        .glass-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .btn {
            background: var(--accent);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(233, 69, 96, 0.4);
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-bottom: 1rem;
            font-family: 'Outfit';
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main {
                margin-left: 0;
                padding: 1.5rem;
            }

            .mobile-toggle {
                display: block;
            }
        }

        .mobile-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 101;
            background: var(--accent);
            padding: 10px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .planet-row {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .planet-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .planet-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            margin-right: 15px;
        }

        /* TAROT STYLES */
        #view-tarot {
            background: radial-gradient(circle at center, #1a0b2e 0%, #0F0C29 100%);
            min-height: 100vh;
            /* Increased height */
            border-radius: 20px;
            position: relative;
            overflow: visible;
            /* Changed from hidden to allow floating elements if needed */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 80px 40px;
            /* More top padding */
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.8);
        }

        .tarot-table {
            width: 100%;
            height: 400px;
            /* Increased height */
            perspective: 1200px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            /* Align top to give space below */
            position: relative;
            margin-bottom: 50px;
            margin-top: 50px;
        }

        /* Card Card */
        .tarot-card-container {
            width: 100px;
            height: 170px;
            position: absolute;
            transform-style: preserve-3d;
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
            border-radius: 12px;
        }

        .tarot-card-container:hover {
            transform: translateY(-20px) scale(1.05) rotateZ(2deg);
            z-index: 100 !important;
            box-shadow: 0 0 20px var(--gold);
        }

        .tarot-card-container.flipped {
            transform: rotateY(180deg) !important;
            z-index: 50 !important;
            /* Removed scale and translate to keep them in slots */
        }

        /* Layout for selected cards */
        .selected-slot {
            transition: all 0.5s;
        }

        /* Front & Back */
        .card-face {
            width: 100%;
            height: 100%;
            position: absolute;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow: hidden;
        }

        .card-back {
            background: linear-gradient(135deg, #111, #222);
            border: 2px solid var(--gold);
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.8);
        }

        .card-back::before {
            content: '';
            position: absolute;
            top: 5px;
            bottom: 5px;
            left: 5px;
            right: 5px;
            border: 1px dashed rgba(255, 215, 0, 0.3);
            border-radius: 8px;
        }

        .card-back::after {
            content: 'ðŸ”®';
            font-size: 2.5rem;
            filter: drop-shadow(0 0 5px var(--gold));
            opacity: 0.8;
        }

        .card-front {
            background: linear-gradient(180deg, #fff, #f4e4bc);
            color: #111;
            transform: rotateY(180deg);
            border: 4px solid #fff;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            font-family: 'Cinzel', serif;
        }

        .card-art {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .card-title {
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 5px;
            padding: 0 5px;
            letter-spacing: 1px;
        }

        .line-clamp-editorial {
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>

<body>

    <!-- Top Modal Removed -->
    <!-- LANDING PAGE REMOVED (Moved to landing.html) -->


    <div class="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>

    <div class="app-container" id="app-root" style="display:flex">
        <!-- SIDEBAR -->
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <i class="fas fa-star-and-crescent"></i> <span data-i18n="app_name">DEEP COSMOS</span>
            </div>

            <div class="nav-item active" onclick="nav('chart', this)">
                <i class="fas fa-globe-europe"></i> <span data-i18n="menu_chart">Natal Chart</span>
            </div>
            <div class="nav-item" onclick="nav('daily', this)">
                <i class="fas fa-calendar-day"></i> <span data-i18n="menu_daily">Daily & Weekly</span>
            </div>
            <div class="nav-item" onclick="nav('social', this)">
                <i class="fas fa-users"></i> <span data-i18n="menu_social">Social Analysis</span>
            </div>

            <!-- RESTORED LOVE MATCH -->
            <div class="nav-item" onclick="nav('synastry', this)">
                <i class="fas fa-heart"></i> <span data-i18n="menu_synastry">Love Match</span>
            </div>

            <!-- SIDEBAR ITEM -->
            <div class="nav-item" onclick="nav('career', this)">
                <i class="fas fa-briefcase"></i> <span data-i18n="menu_career">Career Path</span>
            </div>



            <div class="nav-item" onclick="nav('tarot', this)"
                style="border: 1px solid var(--accent); background: rgba(233,69,96,0.1)">
                <i class="fas fa-hat-wizard"></i> <span style="color:var(--gold); font-weight:bold">Tarot Room</span>
            </div>
            <div class="nav-item" onclick="nav('draconic', this)">
                <i class="fas fa-dragon"></i> <span data-i18n="menu_draconic">Draconic Soul</span>
            </div>
            <div class="nav-item" onclick="nav('hours', this)">
                <i class="fas fa-hourglass-half"></i> <span data-i18n="menu_hours">Planetary Hours</span>
            </div>

            <!-- ADMIN LINK -->
            <div id="admin-nav-item" class="nav-item" onclick="window.open('/api/custom-admin/', '_blank')"
                style="display: {% if user.is_superuser %}flex{% else %}none{% endif %}; border: 1px solid #E94560; background: rgba(233,69,96,0.2); color: #E94560">
                <i class="fas fa-satellite-dish"></i> <span>Kozmik Panel</span>
            </div>

            <!-- EDITOR LINK -->
            <div id="editor-nav-item" class="nav-item" onclick="window.location.href='/editorial/'"
                style="display: {% if user.is_superuser %}flex{% else %}none{% endif %}; border: 1px solid var(--gold); background: rgba(255, 215, 0, 0.1); color: var(--gold)">
                <i class="fas fa-feather-alt"></i> <span>EditÃ¶r Paneli</span>
            </div>

            <!-- GLOBAL LANGUAGE SELECTOR -->
            <div style="margin-top:auto; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1)">
                <label style="color:rgba(255,255,255,0.5); font-size:0.8rem; display:block; margin-bottom:8px"
                    data-i18n="label_lang">Dil / Language</label>
                <select id="lang" onchange="changeLang(this.value)"
                    style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:8px; cursor:pointer">
                    <option value="tr" selected>TÃ¼rkÃ§e ðŸ‡¹ðŸ‡·</option>
                    <option value="en">English ðŸ‡ºðŸ‡¸</option>
                </select>
            </div>


            <div style="margin-top:10px; font-size:0.8rem; color:rgba(255,255,255,0.4)">
                App v4.6 | <span data-i18n="footer">Synced with NASA</span>
            </div>
        </nav>

        <!-- MAIN -->
        <main class="main" style="position:relative">
            <!-- AUTH WIDGET -->
            <div id="auth-widget"
                style="position:absolute; top:20px; right:20px; z-index:900; display:flex; gap:10px; align-items:center">
                <div id="user-display" style="font-weight:bold; color:var(--gold); display:block"><i
                        class="fas fa-user-circle"></i> {{ user.username }}</div>
                <button id="btn-logout-trig" onclick="doLogout()" class="btn"
                    style="display:flex; background:rgba(255,100,100,0.2); width:40px; justify-content:center; padding:10px">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>


            <!-- AUTH MODAL REMOVED -->


            <!-- CHART -->
            <section id="view-chart" class="view animate-in">
                <h1 style="font-size:2.5rem; margin-bottom:0.5rem" data-i18n="chart_title">Natal Chart Calculator</h1>
                <p style="color:rgba(255,255,255,0.6); margin-bottom:2rem" data-i18n="chart_subtitle">NASA Precision
                    Engines</p>
                <div class="glass-card">
                    <!-- LOCATION SELECTOR -->
                    <div style="margin-bottom:20px; text-align:left">
                        <label id="loc-label"
                            style="color:var(--gold); font-size:0.9rem; margin-bottom:5px; display:block">
                            <i class="fas fa-map-marker-alt"></i> <span data-i18n="label_place">Birth Place</span>
                        </label>
                        {% if profile %}
                        <!-- Read-Only Mode for Registered Users -->
                        <div id="main-loc-container" style="display:none">
                            <!-- Hidden Selectors just in case JS needs them? No, we use locked input -->
                            <input type="hidden" id="loc-city">
                        </div>
                        <input type="text" id="locked-loc-input" class="glass-input" disabled
                            value="{{ profile.birth_place }}"
                            style="display:block; width:100%; margin-top:5px; opacity:0.8; cursor:not-allowed; background:rgba(255,255,255,0.05); color:var(--text); border:1px solid var(--border)">
                        {% else %}
                        <!-- Guest Mode -->
                        <div id="main-loc-container" style="display:flex; gap:10px; flex-wrap:wrap">
                            <select id="loc-country" class="glass-input" style="flex:1; min-width:120px"
                                onchange="loadProvinces()">
                                <option value="">Loading...</option>
                            </select>
                            <select id="loc-province" class="glass-input" style="flex:1; min-width:120px; display:none;"
                                onchange="loadCities()">
                                <option value="">Province...</option>
                            </select>
                            <select id="loc-city" class="glass-input" style="flex:1; min-width:120px"
                                onchange="setCityCoords()">
                                <option value="">City/District...</option>
                            </select>
                        </div>
                        <input type="text" id="locked-loc-input" class="glass-input" disabled
                            style="display:none; width:100%; margin-top:5px; opacity:0.8; cursor:not-allowed">
                        {% endif %}
                    </div>

                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
                        <div>
                            <label data-i18n="label_date">Birth Date</label>
                            <input type="text" id="date"
                                value="{{ profile.birth_date|date:'Y/m/d'|default:'1990/01/01' }}" {% if profile %}readonly style="opacity:0.7; cursor:not-allowed" {% endif %} placeholder="YYYY/MM/DD">
                                
                        </div>
                        <div>
                            <label data-i18n="label_time">Birth Time</label> 
                            <input type="text" id="time" value="{{ profile.birth_time|time:'H:i'|default:'12:00' }}" {% if profile %}readonly style="opacity:0.7; cursor:not-allowed" {% endif %}>
                                

                            <!-- Unknown time checkbox removed as per user request -->
                        </div>
                        <!-- Coordinates (Auto-filled) -->
                        <div>
                            <label data-i18n="label_lat">Latitude</label>
                            <input type="number" id="lat" value="{{ profile.lat|default:'41.0082' }}" {% if profile %}readonly style="opacity:0.7; cursor:not-allowed" {% endif %}>
                                
                        </div>
                        <div>
                            <label data-i18n="label_lon">Longitude</label>
                            <input type="number" id="lon" value="{{ profile.lon|default:'28.9784' }}" {% if profile %}readonly style="opacity:0.7; cursor:not-allowed" {% endif %}>
                                
                        </div>
                    </div>

                    <div id="tz-display"
                        style="margin-top:10px; font-size:0.85rem; color:var(--accent); font-style:italic; display:none">
                        <i class="fas fa-clock"></i> Targeted Timezone: <span id="tz-name">Auto</span>
                    </div>

                    <button class="btn" onclick="calcChart()" style="margin-top:20px"><i class="fas fa-bolt"></i> <span
                            data-i18n="btn_calc">Generate Analysis</span></button>
                    <div id="loader-chart" style="display:none; margin-top:20px; color:var(--accent)">Running NASA
                        Engines...</div>
                </div>
                <div id="res-chart" style="display:none"></div>
            </section>

            <!-- DAILY -->
            <section id="view-daily" class="view animate-in" style="display:none">
                <div style="margin-bottom:1rem">
                    <h1 style="font-size:2.5rem; margin:0" data-i18n="daily_title">Cosmic Forecast</h1>
                    <p style="color:rgba(255,255,255,0.6); margin-top:5px" data-i18n="daily_subtitle">Your 7-Day Fortune
                        Outlook</p>
                </div>

                <!-- Weekly Editorial Removed from Dashboard -->

                <div class="glass-card">
                    <h3 style="color:var(--gold); display:flex; justify-content:space-between">
                        <span><i class="fas fa-chart-line"></i> <span data-i18n="graph_title">7-Day Energy
                                Forecast</span></span>
                        <span style="font-size:0.8rem; opacity:0.6">Fortune Teller Mode</span>
                    </h3>
                    <div style="height:300px; margin-top:20px"><canvas id="weeklyChart"></canvas></div>
                </div>

                <h3 style="margin:20px 0; color:var(--accent); letter-spacing:1px">DAILY FORTUNE</h3>
                <div id="daily-list" class="glass-card"
                    style="border:none; background:transparent; padding:0; box-shadow:none">
                    <!-- Dynamic Items -->
                </div>

                <div id="daily-content" class="glass-card" style="border-left: 4px solid var(--accent)">
                    <h3><i class="fas fa-satellite-dish"></i> <span data-i18n="daily_intel">Daily Intel</span></h3>
                    <div id="daily-text" style="font-size:1.1rem; line-height:1.6; margin-top:10px">Loading...</div>
                </div>
            </section>

            <!-- SOCIAL -->
            <section id="view-social" class="view animate-in" style="display:none">
                <h1 style="font-size:2.5rem; margin-bottom:0.5rem" data-i18n="social_title">Social Synergy</h1>
                <div style="display:flex; gap:20px; flex-wrap:wrap">
                    <div style="flex:1; min-width:300px">
                        <div class="glass-card">
                            <h3 data-i18n="soc_add_title">Add Member</h3>
                            <input type="text" id="soc-name" placeholder="Name">
                            <input type="text" id="soc-date" value="1995/05/05">
                            <button class="btn" onclick="addMember()" data-i18n="btn_add">Add Person</button>
                        </div>
                        <div id="member-list"></div>
                    </div>
                    <div style="flex:1; min-width:300px">
                        <div class="glass-card" id="social-res" style="text-align:center">
                            <p data-i18n="soc_placeholder">Add members to see analysis</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SYNASTRY -->
            <section id="view-synastry" class="view animate-in" style="display:none">
                <h1 data-i18n="menu_synastry">Love Match</h1>
                <div class="glass-card">
                    <div style="display:flex; gap:20px; align-items:center;">
                        <div><label>Partner Date</label><input type="text" id="syn-date" value="1992/02/14"></div>
                        <button class="btn" onclick="calcSynastry()" style="height:fit-content; margin-top:10px"
                            data-i18n="btn_match">Check Match</button>
                    </div>
                    <div id="syn-res" style="margin-top:20px;"></div>
                </div>
            </section>

            <!-- DRACONIC -->
            <section id="view-draconic" class="view animate-in" style="display:none">
                <h1 data-i18n="menu_draconic">Draconic Soul Chart</h1>
                <p style="color:rgba(255,255,255,0.6)" data-i18n="draconic_subtitle">Your Higher Self / Soul's Purpose
                </p>
                <div id="draconic-res" class="glass-card"></div>
            </section>

            <!-- HOURS -->
            <section id="view-hours" class="view animate-in" style="display:none">
                <h1 data-i18n="menu_hours">Planetary Hours</h1>
                <p style="color:rgba(255,255,255,0.6)">Optimize your daily schedule</p>
                <div id="hours-res" class="glass-card"></div>
            </section>

            <!-- TAROT ROOM (Correctly Placed) -->
            <div id="view-tarot" class="view" style="display:none">
                <div style="max-width:800px; margin:0 auto; text-align:center">
                    <h2
                        style="color:var(--gold); margin-bottom:10px; font-size:2.5rem; text-shadow:0 0 10px rgba(255,215,0,0.5)">
                        Mystic Tarot</h2>
                    <p style="opacity:0.7; margin-bottom:40px; font-size:1.1rem">Focus on your question, clear your
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:30px">
                        <button id="tab-tarot-shuffle" class="btn" style="padding:10px 20px; font-size:0.9rem"
                            onclick="setTarotMode('shuffle')">Kart SeÃ§</button>
                        <button id="tab-tarot-manual" class="btn"
                            style="padding:10px 20px; font-size:0.9rem; background:transparent; border:1px solid var(--border)"
                            onclick="setTarotMode('manual')">KartlarÄ± Gir</button>
                    </div>

                    <div id="tarot-manual-panel" style="display:none; max-width:500px; margin:0 auto"
                        class="animate-in">
                        <div class="glass-card">
                            <div id="manual-card-inputs"></div>
                            <button class="btn" onclick="revealManualTarot()" style="margin-top:20px">Yorumla</button>
                        </div>
                    </div>

                    <div id="tarot-table" class="tarot-table">
                        <!-- Deck Pile -->
                        <div id="tarot-deck-pile"
                            style="position:relative; width:100px; height:170px; cursor:pointer; margin:0 auto"
                            onclick="startTarot()">
                            <div class="tarot-card-container" style="top:0; left:0; transform:translateZ(0px)">
                                <div class="card-face card-back"></div>
                            </div>
                            <div class="tarot-card-container" style="top:-2px; left:-2px; transform:translateZ(-1px)">
                                <div class="card-face card-back"></div>
                            </div>
                            <div class="tarot-card-container" style="top:-4px; left:-4px; transform:translateZ(-2px)">
                                <div class="card-face card-back"></div>
                            </div>
                            <div
                                style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:200px; text-align:center; color:white; font-weight:bold; text-shadow:0 2px 4px black; pointer-events:none">
                                TAP TO SHUFFLE</div>
                        </div>
                    </div>
                </div>

                <!-- Slots -->
                <div id="tarot-slots"
                    style="display:flex; gap:20px; margin-bottom:30px; min-height:180px; justify-content:center; flex-wrap:wrap">
                    <div id="slot-0" class="selected-slot"
                        style="width:100px; height:170px; border:2px dashed rgba(255,255,255,0.2); border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.5; font-size:0.8rem">
                        <span>PAST</span><i class="fas fa-history" style="margin-top:5px"></i>
                    </div>
                    <div id="slot-1" class="selected-slot"
                        style="width:100px; height:170px; border:2px dashed rgba(255,255,255,0.2); border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.5; font-size:0.8rem">
                        <span>PRESENT</span><i class="fas fa-hourglass-half" style="margin-top:5px"></i>
                    </div>
                    <div id="slot-2" class="selected-slot"
                        style="width:100px; height:170px; border:2px dashed rgba(255,255,255,0.2); border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.5; font-size:0.8rem">
                        <span>FUTURE</span><i class="fas fa-rocket" style="margin-top:5px"></i>
                    </div>
                </div>

                <div style="text-align:center; margin-bottom:30px">
                    <button id="btn-reveal-tarot" class="btn"
                        style="display:none; background:var(--gold); color:black; font-weight:800; animation:pulse 1s infinite; font-size:1.2rem; padding:15px 40px"
                        onclick="revealTarot()">REVEAL DESTINY</button>
                </div>

                <div id="tarot-reading-area" class="reading-area"
                    style="display:none; padding-bottom:50px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px">
                </div>
                <div style="margin-top:20px; cursor:pointer; opacity:0.5; font-size:0.9rem; text-align:center"
                    onclick="resetTarot()"><i class="fas fa-redo"></i> Reset Table</div>
            </div>
            <!-- CAREER VIEW RE-INSERTED CORRECTLY -->
            <section id="view-career" class="view animate-in" style="display:none">
                <h1 data-i18n="menu_career">Career Path</h1>
                <p style="color:rgba(255,255,255,0.6)" data-i18n="career_subtitle">Deep Professional Analysis</p>

                <div class="glass-card" id="career-input-card">
                    <p data-i18n="career_prompt" style="font-size:1.1rem; margin-bottom:15px">Please calculate your
                        Natal Chart first to unlock your Career Analysis.</p>
                    <button class="btn" onclick="nav('chart', document.querySelectorAll('.nav-item')[0])"
                        data-i18n="btn_goto_chart">Go to Chart</button>
                </div>

                <div id="career-res" style="display:none; flex-direction: column; gap:20px;">
                    <!-- Content injected via JS -->
                </div>
            </section>

            <!-- RECTIFICATION VIEW -->
            <section id="view-rectification" class="view animate-in" style="display:none">
                <h1 style="color:var(--gold)" data-i18n="rectify_title">Find Your Ascendant</h1>
                <p style="color:rgba(255,255,255,0.7); margin-bottom:20px" data-i18n="rectify_subtitle">Professional
                    Birth Time Rectification</p>

                <div class="glass-card">
                    <p style="margin-bottom:20px; line-height:1.6">
                        <i class="fas fa-info-circle"></i> <span data-i18n="rectify_info">If you don't know your birth
                            time, we can reverse-engineer it using "Transits". The planets were in specific positions
                            during major events in your life. By matching these events to the angles of the chart, we
                            can find the most probable birth time.</span>
                    </p>

                    <h3 style="margin-bottom:15px; color:var(--accent)" data-i18n="rectify_step1">1. Confirm Birth Date
                    </h3>
                    <input type="text" id="rect-date" placeholder="YYYY/MM/DD">

                    <h3 style="margin:20px 0 10px 0; color:var(--accent)" data-i18n="rectify_step2">2. Major Life Events
                    </h3>
                    <p style="font-size:0.9rem; margin-bottom:10px" data-i18n="rectify_ev_instr">Add at least 3 major
                        events (Marriage, Child Birth, Graduation, Moving, loss, etc.)</p>

                    <div id="event-list">
                        <!-- Initial rows handled by JS or fallback -->
                        <!-- Clearing static rows as we want JS to manage them or we can keep them but the JS addEventRow uses English default unless we init with JS. 
                              Let's keep them empty and let a subsequent script call addEventRow 3 times, or just leave one blank row.
                              Actually, removing them makes the file smaller and cleaner, and I can call addEventRow() 3 times on init.
                          -->
                    </div>
                    <button class="btn" style="background:rgba(255,255,255,0.1); font-size:0.8rem"
                        onclick="addEventRow()" data-i18n="rectify_btn_add">+ Add Another Event</button>

                    <div style="margin-top:30px; text-align:center">
                        <button class="btn" onclick="startRectification()" style="padding:15px 40px; font-size:1.1rem"
                            data-i18n="rectify_btn_find"><i class="fas fa-search"></i> Find True Time</button>
                    </div>

                    <div id="rect-overlay" style="display:none; margin-top:20px; color:var(--gold); text-align:center">
                        <p data-i18n="rectify_scanning">Scanning 24 hours (144 timestamps)...</p>
                        <i class="fas fa-satellite fa-spin" style="font-size:2rem; margin-top:10px"></i>
                    </div>
                </div>

                <div id="rect-results" style="display:none; margin-top:30px">
                    <!-- Results -->
                </div>
            </section>
        </main>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // RECTIFICATION LOGIC
        function toggleUnknownTime() {
            if (document.getElementById('unknown-time').checked) {
                nav('rectification');
                document.getElementById('rect-date').value = document.getElementById('date').value;

                // Initialize with 3 rows if empty
                const list = document.getElementById('event-list');
                if (list && list.children.length === 0) {
                    addEventRow(); addEventRow(); addEventRow();
                }

                // Uncheck to reset state if they go back
                document.getElementById('unknown-time').checked = false;
            }
        }

        function addEventRow() {
            const lang = document.getElementById('lang').value;
            let options = `
                <option value="marriage">Marriage</option>
                <option value="child_birth">Child Birth</option>
                <option value="career_change">Career Jump</option>
                <option value="relocation">Relocation</option>
                <option value="accident">Accident/Surgery</option>
                <option value="loss">Loss/Death</option>
            `;

            if (lang === 'tr') {
                options = `
                <option value="marriage">Evlilik</option>
                <option value="child_birth">Ã‡ocuk DoÄŸumu</option>
                <option value="career_change">Kariyer SÄ±Ã§ramasÄ±</option>
                <option value="relocation">TaÅŸÄ±nma</option>
                <option value="accident">Kaza/Ameliyat</option>
                <option value="loss">KayÄ±p/Vefat</option>
                `;
            }

            const div = document.createElement('div');
            div.className = 'event-row';
            div.style = 'display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap';
            div.innerHTML = `
                <select class="glass-input event-type" style="flex:1; min-width:120px">
                   ${options}
                </select>
                <input type="text" class="glass-input event-date" placeholder="YYYY/MM/DD" style="flex:1; min-width:120px">
            `;
            document.getElementById('event-list').appendChild(div);
        }

        async function startRectification() {
            const resultsDiv = document.getElementById('rect-results');
            const loader = document.getElementById('rect-overlay');
            const lang = document.getElementById('lang').value;
            const t = translations[lang];

            loader.style.display = 'block';
            resultsDiv.style.display = 'none';

            const date = document.getElementById('rect-date').value;
            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;

            const events = [];
            document.querySelectorAll('.event-row').forEach(row => {
                const type = row.querySelector('.event-type').value;
                const d = row.querySelector('.event-date').value;
                if (d && d.length > 5) events.push({ type, date: d });
            });

            if (events.length === 0) {
                alert(lang === 'tr' ? "LÃ¼tfen en az bir olay tarihi girin." : "Please add at least one event date.");
                loader.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/api/rectify-time/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, lat, lon, events, lang })
                });
                const data = await response.json();

                loader.style.display = 'none';
                resultsDiv.style.display = 'block';

                if (data.candidates && data.candidates.length > 0) {
                    let html = `<h2 style="color:var(--gold); margin-bottom:20px">${t.rectify_res_title}</h2>`;

                    data.candidates.forEach((c, index) => {
                        const risingLabel = lang === 'tr' ? 'YÃ¼kselen' : 'Rising';
                        const ptsLabel = lang === 'tr' ? 'Puan' : 'Pts';

                        html += `
                        <div class="glass-card" style="border-left: 4px solid ${index === 0 ? 'var(--gold)' : 'rgba(255,255,255,0.2)'}">
                            <div style="display:flex; justify-content:space-between; align-items:center">
                                <h3 style="font-size:1.5rem">${c.time} <span style="font-size:1rem; opacity:0.7">(${c.asc_sign} ${risingLabel})</span></h3>
                                <div style="background:var(--accent); padding:5px 10px; border-radius:10px; font-weight:bold">${c.score} ${ptsLabel}</div>
                            </div>
                            <div style="margin-top:10px; font-size:0.9rem; opacity:0.8">
                                <strong>${t.rectify_evid}</strong>
                                <ul style="margin-top:5px; padding-left:20px">
                                    ${c.hits.slice(0, 5).map(h => `<li>${h}</li>`).join('')}
                                </ul>
                            </div>
                            <button class="btn" style="margin-top:10px; font-size:0.8rem; padding:8px 20px" 
                                onclick="applyRectifiedTime('${c.time}')">${t.rectify_use_btn}</button>
                        </div>`;
                    });

                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `<div class="glass-card">${t.rectify_no_match}</div>`;
                }

            } catch (e) {
                console.error(e);
                loader.style.display = 'none';
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = t.rectify_error;
            }
        }

        function applyRectifiedTime(time) {
            document.getElementById('time').value = time;
            document.getElementById('date').value = document.getElementById('rect-date').value;
            nav('chart', document.querySelectorAll('.nav-item')[0]);
            // Optional: Auto calc
            // calcChart();
        }

        // ... (Existing variables)

        // CAREER LOGIC
        async function loadCareer() {
            if (!currentData) {
                document.getElementById('career-input-card').style.display = 'block';
                document.getElementById('career-res').style.display = 'none';
                return;
            }
            document.getElementById('career-input-card').style.display = 'none';
            const resDiv = document.getElementById('career-res');
            resDiv.style.display = 'flex';
            resDiv.innerHTML = '<div style="color:var(--accent)">Analyzing Career Path...</div>';

            try {
                const date = document.getElementById('date').value;
                const time = document.getElementById('time').value;
                const lat = document.getElementById('lat').value;
                const lon = document.getElementById('lon').value;
                const lang = document.getElementById('lang').value;

                const response = await fetch('/api/career-analysis/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, time, lat, lon, lang })
                });
                const data = await response.json();

                if (data.analysis) {
                    const text = data.analysis[lang] || data.analysis['en'];

                    const t_mc = lang === 'tr' ? 'Tepe NoktasÄ± & StatÃ¼' : 'Midheaven & Status';
                    const t_sat = lang === 'tr' ? 'SatÃ¼rn & YapÄ±' : 'Saturn & Structure';
                    const t_fore = lang === 'tr' ? 'AylÄ±k Tahmin' : 'Monthly Forecast';

                    // Split sections if possible or render rich HTML
                    resDiv.innerHTML = `
                        <div class="glass-card animate-in" style="border-left:4px solid var(--gold)">
                            <h2 style="color:var(--gold)"><i class="fas fa-crown"></i> ${t_mc}</h2>
                            <div style="margin-top:15px; line-height:1.8; font-size:1.05rem">
                               ${text.split('<br>')[0]}
                            </div>
                        </div>
                        <div class="glass-card animate-in" style="border-left:4px solid var(--accent)">
                            <h2 style="color:var(--accent)"><i class="fas fa-mountain"></i> ${t_sat}</h2>
                            <div style="margin-top:15px; line-height:1.8; font-size:1.05rem">
                               ${text.split('<br>')[1] || ''}
                            </div>
                        </div>
                        <div class="glass-card animate-in" style="background: linear-gradient(135deg, rgba(233,69,96,0.1), rgba(0,0,0,0.3))">
                             <h2 style="color:#fff"><i class="fas fa-meteor"></i> ${t_fore}</h2>
                             <div style="margin-top:15px; line-height:1.8; font-size:1.1rem; font-style:italic">
                               ${text.split('<br>')[2] || ''}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                resDiv.innerHTML = 'Error loading career data.';
                console.error(e);
            }
        }

        // Navigation Interceptor
        const originalNav = window.nav || function (id, el) { };
        window.nav = function (id, el) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // Show new
            if (el) el.classList.add('active');
            const view = document.getElementById('view-' + id);
            if (view) view.style.display = 'block';
            if (id === 'tarot') document.getElementById('view-tarot').style.display = 'flex';

            // Trigger Loaders
            if (id === 'career') loadCareer();
            if (id === 'draconic') renderDraconic(currentData);
            if (id === 'hours') renderHours(currentData);
            if (id === 'daily') loadDaily();
            if (id === 'social') analyzeGroup();
        };


        /* TAROT LOGIC */
        let tarotState = 'deck'; // deck, spread, selected, revealed
        let selectedTarotCards = [];
        let fetchedTarotData = []; // Cards
        let fetchedTarotResponse = null; // Full Response

        // MANUAL TAROT LOGIC
        // We will fetch full deck via API if needed or use fetchedTarotData structure if we expose it.
        // But simpler: just add a new endpoint or use existing logic if we can get the master list.
        // Actually, we can fetch the deck from a new light endpoint or just hardcode the 78 structure on client?
        // Since user wants "all cards", fetching 78 cards metadata is better to avoid massive JS file.
        // Let's assume we add an endpoint "/api/tarot-deck/" or just embed it.

        // Since I can't easily add a new view endpoint without editing views again, 
        // and I just edited views, I should have added a "get_deck" view. 
        // But for now, I will use a Client-Side list of JUST names/ids for the dropdown.
        // Wait, the user said "sanki daha Ã§ok kart vardÄ±". 
        // I should probably fetch it.
        // But let's build the list dynamically if possible.
        // No, simplest is to define the list here. I'll paste the 78 items. It is large but robust.

        const tarotDeckList = [
            { id: "fool", tr: "Deli (Joker)", en: "The Fool" },
            { id: "magician", tr: "BÃ¼yÃ¼cÃ¼", en: "The Magician" },
            { id: "high_priestess", tr: "Azize", en: "The High Priestess" },
            { id: "empress", tr: "Ä°mparatoriÃ§e", en: "The Empress" },
            { id: "emperor", tr: "Ä°mparator", en: "The Emperor" },
            { id: "hierophant", tr: "Aziz", en: "The Hierophant" },
            { id: "lovers", tr: "AÅŸÄ±klar", en: "The Lovers" },
            { id: "chariot", tr: "SavaÅŸ ArabasÄ±", en: "The Chariot" },
            { id: "strength", tr: "GÃ¼Ã§", en: "Strength" },
            { id: "hermit", tr: "ErmiÅŸ", en: "The Hermit" },
            { id: "wheel_of_fortune", tr: "Kader Ã‡arkÄ±", en: "Wheel of Fortune" },
            { id: "justice", tr: "Adalet", en: "Justice" },
            { id: "hanged_man", tr: "AsÄ±lan Adam", en: "The Hanged Man" },
            { id: "death", tr: "Ã–lÃ¼m", en: "Death" },
            { id: "temperance", tr: "Denge", en: "Temperance" },
            { id: "devil", tr: "Åžeytan", en: "The Devil" },
            { id: "tower", tr: "YÄ±kÄ±lan Kule", en: "The Tower" },
            { id: "star", tr: "YÄ±ldÄ±z", en: "The Star" },
            { id: "moon", tr: "Ay", en: "The Moon" },
            { id: "sun", tr: "GÃ¼neÅŸ", en: "The Sun" },
            { id: "judgement", tr: "Mahkeme", en: "Judgement" },
            { id: "world", tr: "DÃ¼nya", en: "The World" },
            // CUPS
            { id: "ace_cups", tr: "Kupa AsÄ±", en: "Ace of Cups" },
            { id: "two_cups", tr: "Kupa Ä°kilisi", en: "Two of Cups" },
            { id: "three_cups", tr: "Kupa ÃœÃ§lÃ¼sÃ¼", en: "Three of Cups" },
            { id: "four_cups", tr: "Kupa DÃ¶rtlÃ¼sÃ¼", en: "Four of Cups" },
            { id: "five_cups", tr: "Kupa BeÅŸlisi", en: "Five of Cups" },
            { id: "six_cups", tr: "Kupa AltÄ±lÄ±sÄ±", en: "Six of Cups" },
            { id: "seven_cups", tr: "Kupa Yedilisi", en: "Seven of Cups" },
            { id: "eight_cups", tr: "Kupa Sekizlisi", en: "Eight of Cups" },
            { id: "nine_cups", tr: "Kupa Dokuzlusu", en: "Nine of Cups" },
            { id: "ten_cups", tr: "Kupa Onlusu", en: "Ten of Cups" },
            { id: "page_cups", tr: "Kupa Prensi", en: "Page of Cups" },
            { id: "knight_cups", tr: "Kupa ÅžÃ¶valyesi", en: "Knight of Cups" },
            { id: "queen_cups", tr: "Kupa KraliÃ§esi", en: "Queen of Cups" },
            { id: "king_cups", tr: "Kupa KralÄ±", en: "King of Cups" },
            // WANDS
            { id: "ace_wands", tr: "DeÄŸnek AsÄ±", en: "Ace of Wands" },
            { id: "two_wands", tr: "DeÄŸnek Ä°kilisi", en: "Two of Wands" },
            { id: "three_wands", tr: "DeÄŸnek ÃœÃ§lÃ¼sÃ¼", en: "Three of Wands" },
            { id: "four_wands", tr: "DeÄŸnek DÃ¶rtlÃ¼sÃ¼", en: "Four of Wands" },
            { id: "five_wands", tr: "DeÄŸnek BeÅŸlisi", en: "Five of Wands" },
            { id: "six_wands", tr: "DeÄŸnek AltÄ±lÄ±sÄ±", en: "Six of Wands" },
            { id: "seven_wands", tr: "DeÄŸnek Yedilisi", en: "Seven of Wands" },
            { id: "eight_wands", tr: "DeÄŸnek Sekizlisi", en: "Eight of Wands" },
            { id: "nine_wands", tr: "DeÄŸnek Dokuzlusu", en: "Nine of Wands" },
            { id: "ten_wands", tr: "DeÄŸnek Onlusu", en: "Ten of Wands" },
            { id: "page_wands", tr: "DeÄŸnek Prensi", en: "Page of Wands" },
            { id: "knight_wands", tr: "DeÄŸnek ÅžÃ¶valyesi", en: "Knight of Wands" },
            { id: "queen_wands", tr: "DeÄŸnek KraliÃ§esi", en: "Queen of Wands" },
            { id: "king_wands", tr: "DeÄŸnek KralÄ±", en: "King of Wands" },
            // SWORDS
            { id: "ace_swords", tr: "KÄ±lÄ±Ã§ AsÄ±", en: "Ace of Swords" },
            { id: "two_swords", tr: "KÄ±lÄ±Ã§ Ä°kilisi", en: "Two of Swords" },
            { id: "three_swords", tr: "KÄ±lÄ±Ã§ ÃœÃ§lÃ¼sÃ¼", en: "Three of Swords" },
            { id: "four_swords", tr: "KÄ±lÄ±Ã§ DÃ¶rtlÃ¼sÃ¼", en: "Four of Swords" },
            { id: "five_swords", tr: "KÄ±lÄ±Ã§ BeÅŸlisi", en: "Five of Swords" },
            { id: "six_swords", tr: "KÄ±lÄ±Ã§ AltÄ±lÄ±sÄ±", en: "Six of Swords" },
            { id: "seven_swords", tr: "KÄ±lÄ±Ã§ Yedilisi", en: "Seven of Swords" },
            { id: "eight_swords", tr: "KÄ±lÄ±Ã§ Sekizlisi", en: "Eight of Swords" },
            { id: "nine_swords", tr: "KÄ±lÄ±Ã§ Dokuzlusu", en: "Nine of Swords" },
            { id: "ten_swords", tr: "KÄ±lÄ±Ã§ Onlusu", en: "Ten of Swords" },
            { id: "page_swords", tr: "KÄ±lÄ±Ã§ Prensi", en: "Page of Swords" },
            { id: "knight_swords", tr: "KÄ±lÄ±Ã§ ÅžÃ¶valyesi", en: "Knight of Swords" },
            { id: "queen_swords", tr: "KÄ±lÄ±Ã§ KraliÃ§esi", en: "Queen of Swords" },
            { id: "king_swords", tr: "KÄ±lÄ±Ã§ KralÄ±", en: "King of Swords" },
            // PENTACLES
            { id: "ace_pentacles", tr: "TÄ±lsÄ±m AsÄ±", en: "Ace of Pentacles" },
            { id: "two_pentacles", tr: "TÄ±lsÄ±m Ä°kilisi", en: "Two of Pentacles" },
            { id: "three_pentacles", tr: "TÄ±lsÄ±m ÃœÃ§lÃ¼sÃ¼", en: "Three of Pentacles" },
            { id: "four_pentacles", tr: "TÄ±lsÄ±m DÃ¶rtlÃ¼sÃ¼", en: "Four of Pentacles" },
            { id: "five_pentacles", tr: "TÄ±lsÄ±m BeÅŸlisi", en: "Five of Pentacles" },
            { id: "six_pentacles", tr: "TÄ±lsÄ±m AltÄ±lÄ±sÄ±", en: "Six of Pentacles" },
            { id: "seven_pentacles", tr: "TÄ±lsÄ±m Yedilisi", en: "Seven of Pentacles" },
            { id: "eight_pentacles", tr: "TÄ±lsÄ±m Sekizlisi", en: "Eight of Pentacles" },
            { id: "nine_pentacles", tr: "TÄ±lsÄ±m Dokuzlusu", en: "Nine of Pentacles" },
            { id: "ten_pentacles", tr: "TÄ±lsÄ±m Onlusu", en: "Ten of Pentacles" },
            { id: "page_pentacles", tr: "TÄ±lsÄ±m Prensi", en: "Page of Pentacles" },
            { id: "knight_pentacles", tr: "TÄ±lsÄ±m ÅžÃ¶valyesi", en: "Knight of Pentacles" },
            { id: "queen_pentacles", tr: "TÄ±lsÄ±m KraliÃ§esi", en: "Queen of Pentacles" },
            { id: "king_pentacles", tr: "TÄ±lsÄ±m KralÄ±", en: "King of Pentacles" }
        ];

        function setTarotMode(mode) {
            const shuffleBtn = document.getElementById('tab-tarot-shuffle');
            const manualBtn = document.getElementById('tab-tarot-manual');
            const tableFn = document.getElementById('tarot-table');
            const tableSlots = document.getElementById('tarot-slots');
            const manualPanel = document.getElementById('tarot-manual-panel');
            const readingArea = document.getElementById('tarot-reading-area');
            const btnReveal = document.getElementById('btn-reveal-tarot');

            readingArea.style.display = 'none';
            btnReveal.style.display = 'none'; // Ensure main reveal btn is hidden

            if (mode === 'shuffle') {
                shuffleBtn.style.background = 'var(--accent)';
                manualBtn.style.background = 'transparent';

                tableFn.style.display = 'block';
                tableSlots.style.display = 'flex';
                manualPanel.style.display = 'none';

                resetTarot();
            } else {
                shuffleBtn.style.background = 'transparent';
                manualBtn.style.background = 'var(--accent)';

                tableFn.style.display = 'none';
                tableSlots.style.display = 'none';
                manualPanel.style.display = 'block';

                initManualTarot();
            }
        }

        function initManualTarot() {
            const container = document.getElementById('manual-card-inputs');
            const lang = document.getElementById('lang').value;
            const labels = lang === 'tr' ? ['GeÃ§miÅŸ', 'Åžimdi', 'Gelecek'] : ['Past', 'Present', 'Future'];
            const ph = lang === 'tr' ? 'Kart SeÃ§iniz...' : 'Select Card...';

            let html = '';
            labels.forEach((label, i) => {
                html += `
                <div style="margin-bottom:15px">
                    <label style="color:var(--gold); font-size:0.9rem">${label}</label>
                    <div style="display:flex; gap:10px">
                        <select id="m-card-${i}" class="glass-input" style="flex:1; background:rgba(0,0,0,0.5)">
                            <option value="">${ph}</option>
                            ${tarotDeckList.map(c => `<option value="${c.id}">${lang === 'tr' ? c.tr : c.en}</option>`).join('')}
                        </select>
                        <div style="display:flex; align-items:center; gap:5px">
                            <input type="checkbox" id="m-rev-${i}">
                            <label for="m-rev-${i}" style="font-size:0.8rem">Rev</label>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        async function revealManualTarot() {
            const cards = [];
            for (let i = 0; i < 3; i++) {
                const sel = document.getElementById(`m-card-${i}`);
                const id = sel.value;
                const rev = document.getElementById(`m-rev-${i}`).checked;
                if (!id) {
                    alert(document.getElementById('lang').value === 'tr' ? "LÃ¼tfen 3 kartÄ± da seÃ§iniz." : "Please select all 3 cards.");
                    return;
                }
                cards.push({ id: id, reversed: rev });
            }

            const btn = document.querySelector('#tarot-manual-panel button');
            const oldText = btn.innerText;
            btn.innerText = 'Analyzing...';
            btn.disabled = true;

            const lang = document.getElementById('lang').value;

            try {
                const res = await fetch('/api/draw-tarot/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cards: cards, lang: lang })
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`Server ${res.status}: ${errText.substring(0, 100)}`);
                }

                const data = await res.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                fetchedTarotResponse = data;
                fetchedTarotData = data.cards;

                document.getElementById('tarot-manual-panel').style.display = 'none';

                const readingArea = document.getElementById('tarot-reading-area');
                readingArea.style.display = 'grid';
                readingArea.innerHTML = '';

                displayTarotCards();

            } catch (e) {
                console.error(e);
                alert("Hata: " + e.message);
            }

            btn.innerText = oldText;
            btn.disabled = false;
        }

        function displayTarotCards() {
            const readingArea = document.getElementById('tarot-reading-area');
            readingArea.innerHTML = '';

            if (!fetchedTarotData || fetchedTarotData.length === 0) return;

            // Simple 3-Upper Cards Display for Manual Mode (Static)
            let topCardsHtml = '<div style="display:flex; justify-content:center; gap:20px; margin-bottom:30px; flex-wrap:wrap">';
            fetchedTarotData.forEach(data => {
                topCardsHtml += `
                    <div class="tarot-card-container flipped" style="position:relative; width:100px; height:170px; margin:0">
                        <div class="card-face card-front ${data.is_reversed ? 'reversed' : ''}" style="transform: rotateY(0deg)">
                            <div class="card-title" style="font-size:0.6rem; color:#333">${data.name}</div>
                            <div class="card-art" style="color:${data.color}; font-size:2.5rem; margin:5px 0">
                                ${data.element === 'Fire' ? 'ðŸ”¥' : data.element === 'Water' ? 'ðŸ’§' : data.element === 'Air' ? 'ðŸŒªï¸' : 'ðŸŒ¿'}
                            </div>
                            <div style="font-size:0.5rem; text-transform:uppercase; letter-spacing:1px; color:#555">${data.position}</div>
                        </div>
                    </div>
                `;
            });
            topCardsHtml += '</div>';
            readingArea.innerHTML += topCardsHtml;

            // Detailed Interpretations
            fetchedTarotData.forEach((data, i) => {
                readingArea.innerHTML += `
                    <div class="glass-card animate-in" style="text-align:left; animation-delay:${i * 0.2}s">
                         <h3 style="color:${data.color}; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px">
                            <i class="fas ${data.position === 'Past' || data.position === 'GeÃ§miÅŸ' ? 'fa-history' : data.position === 'Present' || data.position === 'Åžimdi' ? 'fa-hourglass-half' : 'fa-rocket'}"></i> 
                            ${data.position}: ${data.name} <span style="font-size:0.7em; opacity:0.7">${data.is_reversed ? '(Reversed)' : ''}</span>
                         </h3>
                         <p style="line-height:1.6; font-size:1rem">${data.meaning}</p>
                    </div>
                 `;
            });

            // Synthesis
            if (fetchedTarotResponse && fetchedTarotResponse.wish) {
                const summaryHtml = `
                    <div class="glass-card animate-in" style="grid-column: 1 / -1; margin-top:30px; border:2px solid ${fetchedTarotResponse.wish.score >= 0 ? 'var(--gold)' : '#ff4444'}; background:linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,0,10,0.8)); animation-delay:0.8s">
                        <h2 style="color:${fetchedTarotResponse.wish.score >= 0 ? 'var(--gold)' : '#ff6666'}; text-align:center; margin-bottom:15px; font-size:1.8rem; text-shadow:0 0 10px rgba(0,0,0,0.5)">
                            <i class="fas fa-magic"></i> ${fetchedTarotResponse.wish.title}
                        </h2>
                        <p style="font-size:1.2rem; line-height:1.6; text-align:center; margin-bottom:20px; font-style:italic; color:#fff">"${fetchedTarotResponse.wish.text}"</p>
                        <hr style="border-color:rgba(255,255,255,0.1); margin-bottom:20px">
                        <h3 style="color:var(--text); margin-bottom:10px; text-transform:uppercase; letter-spacing:2px; font-size:1rem"><i class="fas fa-align-left"></i> ${document.getElementById('lang').value === 'tr' ? 'Kozmik Ã–zet' : 'Cosmic Synthesis'}</h3>
                        <p style="opacity:0.9; line-height:1.8; text-align:justify; font-size:1.1rem">${fetchedTarotResponse.synthesis}</p>
                    </div>
                 `;
                readingArea.innerHTML += summaryHtml;

                // Scroll to view
                setTimeout(() => {
                    const area = document.getElementById('view-tarot');
                    area.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        }


        async function startTarot() {
            if (tarotState !== 'deck') return;

            const table = document.getElementById('tarot-table');
            table.innerHTML = ''; // Clear pile

            // 1. Fetch Data silently
            const lang = document.getElementById('lang').value;
            try {
                const res = await fetch(`/api/draw-tarot/?lang=${lang}`);
                const data = await res.json();
                fetchedTarotResponse = data; // Store full
                if (data.cards) fetchedTarotData = data.cards; // Keep for compatibility
            } catch (e) { console.error("Tarot Fetch Error", e); }

            // 2. Generate Spread (22 Cards Arc)
            const total = 22;
            const center = window.innerWidth < 768 ? 150 : 300;

            for (let i = 0; i < total; i++) {
                const card = document.createElement('div');
                card.className = 'tarot-card-container';
                card.innerHTML = `<div class="card-face card-back"></div><div class="card-face card-front"></div>`;

                // Initial: Center
                card.style.left = '50%';
                card.style.top = '50%';
                card.style.transform = 'translate(-50%, -50%)';
                card.style.transitionDelay = `${i * 0.05}s`;

                card.onclick = () => selectTarotCard(card, i);

                table.appendChild(card);

                // Spread Animation
                setTimeout(() => {
                    const angle = -60 + (i * (120 / total)); // -60 to +60 deg
                    const radius = 450; // Wider
                    const x = Math.sin(angle * Math.PI / 180) * radius;
                    const y = Math.cos(angle * Math.PI / 180) * radius * 0.2; // Much flatter (0.2) to avoid overlap

                    // Shift UP by 60px to clear slots
                    card.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px - 60px)) rotate(${angle}deg)`;
                }, 100);
            }
            tarotState = 'spread';
            document.getElementById('tarot-slots').style.opacity = '1';
        }

        function selectTarotCard(el, index) {
            if (tarotState !== 'spread' || selectedTarotCards.length >= 3) return;
            if (el.classList.contains('picked')) return;

            const slotIndex = selectedTarotCards.length;
            selectedTarotCards.push(index);
            el.classList.add('picked');

            // Move to Slot (Physical DOM Move)
            const slot = document.getElementById(`slot-${slotIndex}`);

            // Clear slot placeholder (Past, Present icons)
            slot.innerHTML = '';
            slot.appendChild(el);

            // Reset Card Styles to fit container
            el.style.position = 'relative';
            el.style.top = '0';
            el.style.left = '0';
            el.style.transform = 'none';
            el.style.width = '100%';
            el.style.height = '100%';
            el.style.margin = '0';
            el.style.pointerEvents = 'none'; // Lock it
            el.style.zIndex = '10';

            // Remove Slot Styling
            slot.style.opacity = '1';
            slot.style.border = 'none';

            if (selectedTarotCards.length === 3) {
                document.getElementById('btn-reveal-tarot').style.display = 'inline-block';
            }
        }

        async function revealTarot() {
            const readingArea = document.getElementById('tarot-reading-area');
            readingArea.innerHTML = '';
            readingArea.style.display = 'grid';
            document.getElementById('btn-reveal-tarot').style.display = 'none';

            // Emergency Data Check
            if (!fetchedTarotData || fetchedTarotData.length < 3) {
                console.warn("Tarot data missing, attempting refetch...");
                const lang = document.getElementById('lang').value;
                try {
                    const res = await fetch(`/api/draw-tarot/?lang=${lang}`);
                    const data = await res.json();
                    fetchedTarotResponse = data;
                    if (data.cards) fetchedTarotData = data.cards;
                } catch (e) {
                    alert("The stars are clouded. Please try again.");
                    return;
                }
            }

            const pickedEls = document.querySelectorAll('.tarot-card-container.picked');

            pickedEls.forEach((el, i) => {
                const data = fetchedTarotData[i];
                if (!data) return;

                // 1. Flip Animation IN PLACE
                setTimeout(() => {
                    el.classList.add('flipped');
                    // Update Front Content
                    const front = el.querySelector('.card-front');
                    if (data.is_reversed) front.classList.add('reversed');

                    front.innerHTML = `
                        <div class="card-title" style="font-size:0.6rem; color:#333">${data.name}</div>
                        <div class="card-art" style="color:${data.color}; font-size:2.5rem; margin:5px 0">${data.element === 'Fire' ? 'ðŸ”¥' : data.element === 'Water' ? 'ðŸ’§' : data.element === 'Air' ? 'ðŸŒªï¸' : 'ðŸŒ¿'}</div>
                        <div style="font-size:0.5rem; text-transform:uppercase; letter-spacing:1px; color:#555">${data.position}</div>
                     `;
                }, i * 600);

                // 2. Add description below
                setTimeout(() => {
                    readingArea.innerHTML += `
                        <div class="glass-card animate-in" style="text-align:left">
                             <h3 style="color:${data.color}; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px">
                                <i class="fas ${data.position === 'Past' ? 'fa-history' : data.position === 'Present' ? 'fa-hourglass-half' : 'fa-rocket'}"></i> 
                                ${data.position}: ${data.name} <span style="font-size:0.7em; opacity:0.7">${data.is_reversed ? '(Reversed)' : ''}</span>
                             </h3>
                             <p style="line-height:1.6; font-size:1rem">${data.meaning}</p>
                        </div>
                     `;
                }, 2000 + (i * 600));
            });

            // 3. Add Synthesis & Outcome
            setTimeout(() => {
                if (fetchedTarotResponse && fetchedTarotResponse.wish) {
                    const summaryHtml = `
                        <div class="glass-card animate-in" style="grid-column: 1 / -1; margin-top:30px; border:2px solid ${fetchedTarotResponse.wish.score >= 0 ? 'var(--gold)' : '#ff4444'}; background:linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,0,10,0.8))">
                            <h2 style="color:${fetchedTarotResponse.wish.score >= 0 ? 'var(--gold)' : '#ff6666'}; text-align:center; margin-bottom:15px; font-size:1.8rem; text-shadow:0 0 10px rgba(0,0,0,0.5)">
                                <i class="fas fa-magic"></i> ${fetchedTarotResponse.wish.title}
                            </h2>
                            <p style="font-size:1.2rem; line-height:1.6; text-align:center; margin-bottom:20px; font-style:italic; color:#fff">"${fetchedTarotResponse.wish.text}"</p>
                            <hr style="border-color:rgba(255,255,255,0.1); margin-bottom:20px">
                            <h3 style="color:var(--text); margin-bottom:10px; text-transform:uppercase; letter-spacing:2px; font-size:1rem"><i class="fas fa-align-left"></i> ${document.getElementById('lang').value === 'tr' ? 'Kozmik Ã–zet' : 'Cosmic Synthesis'}</h3>
                            <p style="opacity:0.9; line-height:1.8; text-align:justify; font-size:1.1rem">${fetchedTarotResponse.synthesis}</p>
                        </div>
                     `;
                    readingArea.innerHTML += summaryHtml;
                    setTimeout(() => {
                        const area = document.getElementById('view-tarot');
                    }, 100);
                }
            }, 4000);
        }

        function resetTarot() {
            tarotState = 'deck';
            selectedTarotCards = [];
            document.getElementById('tarot-table').innerHTML = `
                 <div id="tarot-deck-pile" style="position:relative; width:100px; height:170px; cursor:pointer" onclick="startTarot()">
                    <div class="tarot-card-container" style="top:0; left:0; transform:translateZ(0px)"> <div class="card-face card-back"></div> </div>
                    <div class="tarot-card-container" style="top:-2px; left:-2px; transform:translateZ(-1px)"> <div class="card-face card-back"></div> </div>
                    <div class="tarot-card-container" style="top:-4px; left:-4px; transform:translateZ(-2px)"> <div class="card-face card-back"></div> </div>
                    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:200px; text-align:center; color:white; font-weight:bold; text-shadow:0 2px 4px black; pointer-events:none">TAP TO SHUFFLE</div>
                 </div>
             `;
            document.getElementById('tarot-reading-area').style.display = 'none';
            document.getElementById('btn-reveal-tarot').style.display = 'none';
        }
        const translations = {
            en: {
                app_name: "DEEP COSMOS",
                menu_chart: "Natal Chart", menu_daily: "Daily & Weekly", menu_social: "Social Analysis",
                menu_synastry: "Love Match", menu_draconic: "Draconic Soul", menu_hours: "Time Mastery",
                footer: "Synced with NASA",
                chart_title: "Natal Chart Calculator", chart_subtitle: "NASA Precision Engines",
                label_date: "Birth Date", label_time: "Birth Time", label_unknown: "I don't know my birth time", label_lat: "Latitude", label_lon: "Longitude", label_lang: "Language / Dil",
                btn_calc: "Generate Analysis",
                daily_title: "Cosmic Forecast", daily_subtitle: "NASA Synchronized Transits",
                graph_title: "7-Day Energy Forecast", daily_intel: "Daily Intel", daily_advice: "Daily Advice",
                social_title: "Social Synergy", social_subtitle: "Group Dynamics & Elemental Balance",
                daily_comment: "Daily Comment", daily_login_more: "Login for More",
                soc_add_title: "Add Member", btn_add: "Add Person", soc_placeholder: "Add members to see analysis",
                btn_match: "Check Compatibility",
                match_res: "COMPATIBILITY", match_desc: "A strong karmic link detected between the two dates.",
                draconic_wait: "To view Draconic chart, first calculate your Natal Chart.",
                hours_wait: "Run Natal Chart to determine location-based hours.",
                hours_title: "Today's Power Hours", h_sun: "Sun Hour", h_success: "(Success)", h_mars: "Mars Hour", h_action: "(Action)",
                p_pos: "Planetary Positions", t_rising: "Rising Sign", drac_title: "Soul Contract (Draconic)",
                draconic_subtitle: "Your Higher Self / Soul's Purpose",
                draconic_sun_label: "Higher Self Sun",
                career_title: "Career Path",
                rectify_title: "Find Your Ascendant",
                rectify_subtitle: "Professional Birth Time Rectification",
                rectify_info: "If you don't know your birth time, we can reverse-engineer it using 'Transits'. The planets were in specific positions during major events in your life. By matching these events to the angles of the chart, we can find the most probable birth time.",
                rectify_step1: "1. Confirm Birth Date",
                rectify_step2: "2. Major Life Events",
                rectify_ev_instr: "Add at least 3 major events (Marriage, Child Birth, Graduation, Moving, loss, etc.)",
                rectify_btn_add: "+ Add Another Event",
                rectify_btn_find: "Find True Time",
                rectify_scanning: "Scanning 24 hours...",
                rectify_res_title: "Most Probable Times",
                rectify_evid: "Evidence:",
                rectify_use_btn: "Use This Time",
                rectify_no_match: "No strong matches found. Try adding more events or checking the dates.",
                rectify_error: "Error calculating. Please try again."
            },
            tr: {
                app_name: "DERÄ°N KOZMOS",
                menu_chart: "DoÄŸum HaritasÄ±", menu_daily: "GÃ¼nlÃ¼k & HaftalÄ±k", menu_social: "Sosyal Analiz",
                menu_synastry: "AÅŸk Uyumu", menu_draconic: "Drakonik Ruh", menu_hours: "Zaman YÃ¶netimi",
                footer: "NASA ile Senkronize",
                chart_title: "DoÄŸum HaritasÄ±", chart_subtitle: "NASA Hassas MotorlarÄ±",
                label_date: "DoÄŸum Tarihi", label_time: "DoÄŸum Saati", label_unknown: "DoÄŸum saatimi bilmiyorum", label_lat: "Enlem", label_lon: "Boylam", label_lang: "Dil / Language", label_place: "DoÄŸum Yeri",
                btn_calc: "Analizi OluÅŸtur",
                daily_title: "Kozmik Tahmin", daily_subtitle: "EÅŸzamanlÄ± NASA Transitleri",
                graph_title: "7-GÃ¼nlÃ¼k Enerji Tahmini", daily_intel: "GÃ¼nlÃ¼k Ä°stihbarat", daily_advice: "GÃ¼nlÃ¼k Tavsiye",
                daily_comment: "GÃ¼nlÃ¼k Yorum", daily_login_more: "Daha FazlasÄ± Ä°Ã§in GiriÅŸ Yap",
                social_title: "Sosyal Sinerji", social_subtitle: "Grup Dinamikleri ve Element Dengesi",
                soc_add_title: "Ãœye Ekle", btn_add: "KiÅŸi Ekle", soc_placeholder: "Analiz iÃ§in Ã¼ye ekleyin",
                menu_career: "Kariyer Yolu",
                btn_match: "Uyumu Kontrol Et",
                match_res: "UYUM SKORU", match_desc: "Ä°ki tarih arasÄ±nda gÃ¼Ã§lÃ¼ bir karmik baÄŸ tespit edildi.",
                draconic_wait: "Drakonik haritayÄ± gÃ¶rmek iÃ§in Ã¶nce DoÄŸum HaritasÄ±nÄ± hesaplayÄ±n.",
                hours_wait: "Saatleri gÃ¶rmek iÃ§in DoÄŸum HaritasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n.",
                hours_title: "GÃ¼nÃ¼n GÃ¼Ã§ Saatleri", h_sun: "GÃ¼neÅŸ Saati", h_success: "(BaÅŸarÄ±)", h_mars: "Mars Saati", h_action: "(Eylem)",
                p_pos: "Gezegen KonumlarÄ±", t_rising: "YÃ¼kselen BurÃ§", drac_title: "Ruh SÃ¶zleÅŸmesi (Drakonik)",
                draconic_subtitle: "YÃ¼ksek BenliÄŸiniz / Ruhsal AmacÄ±nÄ±z",
                draconic_sun_label: "YÃ¼ksek Benlik GÃ¼neÅŸi",
                career_title: "Kariyer Yolu",
                rectify_title: "YÃ¼kselen Burcunu Bul",
                rectify_subtitle: "Profesyonel DoÄŸum Saati DoÄŸrulama",
                rectify_info: "DoÄŸum saatinizi tam olarak bilmiyorsanÄ±z, 'Transitler' kullanarak onu tersten hesaplayabiliriz. Gezegenler hayatÄ±nÄ±zdaki Ã¶nemli olaylar sÄ±rasÄ±nda belirli konumlardaydÄ±. Bu olaylarÄ± haritanÄ±n kilit noktalarÄ±yla eÅŸleÅŸtirerek en olasÄ± doÄŸum saatini bulabiliriz.",
                rectify_step1: "1. DoÄŸum Tarihini DoÄŸrula",
                rectify_step2: "2. Ã–nemli Hayat OlaylarÄ±",
                rectify_ev_instr: "En az 3 Ã¶nemli olay ekle (Evlilik, Ã‡ocuk, Mezuniyet, TaÅŸÄ±nma, KayÄ±p vb.)",
                rectify_btn_add: "+ BaÅŸka Olay Ekle",
                rectify_btn_find: "DoÄŸru Saati Bul",
                rectify_scanning: "24 saat taranÄ±yor...",
                rectify_res_title: "En OlasÄ± Saatler",
                rectify_evid: "KanÄ±tlar:",
                rectify_use_btn: "Bu Saati Kullan",
                rectify_no_match: "GÃ¼Ã§lÃ¼ bir eÅŸleÅŸme bulunamadÄ±. LÃ¼tfen daha fazla olay ekleyin veya tarihleri kontrol edin.",
                rectify_error: "Hesaplama hatasÄ±. LÃ¼tfen tekrar deneyin."
            }
        };

        const draconicInterpretations = {
            en: {
                Aries: "Your soul has signed a contract to be a pioneer. In this lifetime, your higher self demands that you learn courage, independence, and self-assertion. You are here to break old cycles and start new paths. The challenges you face are meant to forge your identity and teach you that it is safe to be powerful and direct.",
                Taurus: "The soul purpose here is grounded in finding peace and specialized worth. You agreed to learn the lessons of stability, nature, and self-sufficiency. Your higher self wants you to build something lasting and to understand the spiritual value of the material world without becoming attached to it.",
                Gemini: "Your soul contract involves becoming a messenger. You are here to connect people, ideas, and realms. Your higher self thrives on curiosity and adaptability. The lesson is to find truth amidst chaos and to communicate it clearly, bridging the gap between dualities.",
                Cancer: "You are here to master the art of nurturing and emotional intelligence. Your soul contract is tied to ancestry, home, and the mother archetype. You must learn to give support without losing yourself, and to find a sense of belonging within your own heart rather than external places.",
                Leo: "A contract of self-expression and leadership. Your higher self wants you to shine, create, and lead from the heart. The lesson is to cultivate ego in a healthy wayâ€”recognizing your own divinity so you can recognize it in others. You are here to bring warmth and joy.",
                Virgo: "Your soul chose a path of service and refinement. In this incarnation, you are refining your spirit through details, healing, and practical assistance. The goal is not perfectionism, but purity of intent and the understanding that the sacred is found in the ordinary.",
                Libra: "The soul contract of harmony. You are here to master relationships and balance. Your higher self seeks to unite opposites and create beauty. The lesson is to find peace without compromising your own truth, learning that true harmony comes from inner equilibrium.",
                Scorpio: "A powerful contract of transformation. You agreed to dive deep into the mysteries of life, death, and rebirth. Your higher self demands authenticity and power. You are here to heal the shadow self and to help others navigate their darkest transits.",
                Sagittarius: "Your soul is a seeker of truth. The contract involves exploring, teaching, and expanding horizons. You are here to find wisdom in diversity and to maintain faith even in darkness. Your higher self urges you to remain free and to share your optimistic vision.",
                Capricorn: "You have signed a contract of mastery and responsibility. Your soul wants you to build structures that support society. The lesson is about integrity, discipline, and managing power. You are here to leave a legacy and to learn that true authority comes from within.",
                Aquarius: "The soul purpose of the rebel and innovator. You are here to disrupt stagnant systems and bring future consciousness to the present. Your higher self values freedom and humanity. The lesson is to belong to the collective while remaining uniquely yourself.",
                Pisces: "A contract of spiritual transcendence. You are here to dissolve boundaries and learn unconditional love. Your higher self is connected to the divine source. The challenges involve staying grounded while navigating deep spiritual waters and practicing compassion."
            },
            tr: {
                Aries: "Ruhunuz bir Ã¶ncÃ¼ olmak iÃ§in sÃ¶zleÅŸme imzaladÄ±. Bu yaÅŸamda, yÃ¼ksek benliÄŸiniz sizden cesaret, baÄŸÄ±msÄ±zlÄ±k ve kendini ortaya koymayÄ± Ã¶ÄŸrenmenizi talep ediyor. Eski dÃ¶ngÃ¼leri kÄ±rmak ve yeni yollar baÅŸlatmak iÃ§in buradasÄ±nÄ±z. KarÅŸÄ±laÅŸtÄ±ÄŸÄ±nÄ±z zorluklar kimliÄŸinizi ÅŸekillendirmek ve gÃ¼Ã§lÃ¼ olmanÄ±n gÃ¼venli olduÄŸunu Ã¶ÄŸretmek iÃ§indir.",
                Taurus: "Ruhsal amacÄ±nÄ±z huzuru ve Ã¶zdeÄŸerinizi bulmakta yatar. Ä°stikrar, doÄŸa ve kendi kendine yetme derslerini Ã¶ÄŸrenmeyi kabul ettiniz. YÃ¼ksek benliÄŸiniz kalÄ±cÄ± bir ÅŸey inÅŸa etmenizi ve maddi dÃ¼nyaya baÄŸlanmadan onun ruhsal deÄŸerini anlamanÄ±zÄ± istiyor.",
                Gemini: "Ruh sÃ¶zleÅŸmeniz bir haberci olmayÄ± iÃ§erir. Ä°nsanlarÄ±, fikirleri ve alemleri birbirine baÄŸlamak iÃ§in buradasÄ±nÄ±z. YÃ¼ksek benliÄŸiniz merak ve uyum yeteneÄŸi ile beslenir. Dersiniz, kaosun iÃ§inde gerÃ§eÄŸi bulmak ve onu net bir ÅŸekilde ileterek ikilikler arasÄ±nda kÃ¶prÃ¼ kurmaktÄ±r.",
                Cancer: "Besleme sanatÄ±nda ve duygusal zekada ustalaÅŸmak iÃ§in buradasÄ±nÄ±z. Ruh sÃ¶zleÅŸmeniz atalar, ev ve anne arketipi ile baÄŸlantÄ±lÄ±dÄ±r. Kendinizi kaybetmeden destek vermeyi ve aidiyet duygusunu dÄ±ÅŸ yerlerde deÄŸil, kendi kalbinizde bulmayÄ± Ã¶ÄŸrenmelisiniz.",
                Leo: "Kendini ifade etme ve liderlik sÃ¶zleÅŸmesi. YÃ¼ksek benliÄŸiniz parlamanÄ±zÄ±, yaratmanÄ±zÄ± ve kalpten yÃ¶netmenizi istiyor. Ders, egoyu saÄŸlÄ±klÄ± bir ÅŸekilde geliÅŸtirmektir; kendi ilahiliÄŸinizi tanÄ±yarak baÅŸkalarÄ±ndakini de tanÄ±yabilirsiniz. SÄ±caklÄ±k ve neÅŸe getirmek iÃ§in buradasÄ±nÄ±z.",
                Virgo: "Ruhunuz hizmet ve arÄ±nma yolunu seÃ§ti. Bu enkarnasyonda, detaylar, ÅŸifa ve pratik yardÄ±m yoluyla ruhunuzu inceltiyorsunuz. AmaÃ§ mÃ¼kemmeliyetÃ§ilik deÄŸil, niyetin saflÄ±ÄŸÄ± ve kutsal olanÄ±n sÄ±radan olanda bulunduÄŸunu anlamaktÄ±r.",
                Libra: "Uyum sÃ¶zleÅŸmesi. Ä°liÅŸkilerde ve dengede ustalaÅŸmak iÃ§in buradasÄ±nÄ±z. YÃ¼ksek benliÄŸiniz zÄ±tlÄ±klarÄ± birleÅŸtirmeyi ve gÃ¼zellik yaratmayÄ± amaÃ§lar. Ders, kendi gerÃ§eÄŸinizden Ã¶dÃ¼n vermeden barÄ±ÅŸÄ± bulmak ve gerÃ§ek uyumun iÃ§sel dengeden geldiÄŸini Ã¶ÄŸrenmektir.",
                Scorpio: "GÃ¼Ã§lÃ¼ bir dÃ¶nÃ¼ÅŸÃ¼m sÃ¶zleÅŸmesi. YaÅŸam, Ã¶lÃ¼m ve yeniden doÄŸuÅŸun gizemlerine dalmayÄ± kabul ettiniz. YÃ¼ksek benliÄŸiniz Ã¶zgÃ¼nlÃ¼k ve gÃ¼Ã§ talep ediyor. GÃ¶lge benliÄŸi iyileÅŸtirmek ve baÅŸkalarÄ±nÄ±n en karanlÄ±k geÃ§iÅŸlerinde onlara rehberlik etmek iÃ§in buradasÄ±nÄ±z.",
                Sagittarius: "Ruhunuz bir hakikat arayÄ±cÄ±sÄ±dÄ±r. SÃ¶zleÅŸme keÅŸfetmeyi, Ã¶ÄŸretmeyi ve ufuklarÄ± geniÅŸletmeyi iÃ§erir. Ã‡eÅŸitlilikte bilgeliÄŸi bulmak ve karanlÄ±kta bile inancÄ±nÄ±zÄ± korumak iÃ§in buradasÄ±nÄ±z. YÃ¼ksek benliÄŸiniz Ã¶zgÃ¼r kalmanÄ±zÄ± ve iyimser vizyonunuzu paylaÅŸmanÄ±zÄ± istiyor.",
                Capricorn: "UstalÄ±k ve sorumluluk sÃ¶zleÅŸmesi imzaladÄ±nÄ±z. Ruhunuz toplumu destekleyen yapÄ±lar inÅŸa etmenizi istiyor. Ders dÃ¼rÃ¼stlÃ¼k, disiplin ve gÃ¼cÃ¼ yÃ¶netmekle ilgilidir. Bir miras bÄ±rakmak ve gerÃ§ek otoritenin iÃ§eriden geldiÄŸini Ã¶ÄŸrenmek iÃ§in buradasÄ±nÄ±z.",
                Aquarius: "Asi ve yenilikÃ§inin ruhsal amacÄ±. Durgun sistemleri bozmak ve gelecek bilincini ÅŸimdiki zamana taÅŸÄ±mak iÃ§in buradasÄ±nÄ±z. YÃ¼ksek benliÄŸiniz Ã¶zgÃ¼rlÃ¼ÄŸe ve insanlÄ±ÄŸa deÄŸer verir. Ders, kolektife ait olurken aynÄ± zamanda benzersiz bir ÅŸekilde kendiniz kalmaktÄ±r.",
                Pisces: "Ruhsal aÅŸkÄ±nlÄ±k sÃ¶zleÅŸmesi. SÄ±nÄ±rlarÄ± Ã§Ã¶zmek ve koÅŸulsuz sevgiyi Ã¶ÄŸrenmek iÃ§in buradasÄ±nÄ±z. YÃ¼ksek benliÄŸiniz ilahi kaynakla baÄŸlantÄ±lÄ±dÄ±r. Zorluklar, derin ruhsal sularda gezinirken ve ÅŸefkat uygularken ayaklarÄ± yere basmayÄ± iÃ§erir."
            }
        };

        const elementDescriptions = {
            en: {
                Fire: "This group is driven by passion, action, and enthusiasm. Decisions are made quickly, often on impulse. You inspire each other to take risks, but may struggle with patience or details. A high-energy squad!",
                Earth: "A grounded, practical, and reliable group. You value stability, tangible results, and common sense. While you may move slowly, you build things that last. Financially and structurally sound.",
                Air: "Communication is the lifeblood of this group. You love debating ideas, socializing, and exploring new concepts. It's a very intellectual and buzz-filled environment, though sometimes lacking emotional depth.",
                Water: "This group shares a deep emotional bond. Intuition, empathy, and feelings guide your interactions. You protect each other and understand unspoken moods, but can be prone to drama or mood swings."
            },
            tr: {
                Fire: "Bu grup tutku, eylem ve heyecanla yÃ¶netiliyor. Kararlar hÄ±zlÄ± ve genellikle dÃ¼rtÃ¼sel alÄ±nÄ±r. Birbirinizi risk almaya teÅŸvik edersiniz, ancak sabÄ±r veya detaylarda zorlanabilirsiniz. YÃ¼ksek enerjili bir ekip!",
                Earth: "AyaklarÄ± yere basan, pratik ve gÃ¼venilir bir grup. Ä°stikrarÄ±, somut sonuÃ§larÄ± ve saÄŸduyuyu Ã¶nemsersiniz. Biraz yavaÅŸ hareket edebilirsiniz ama kalÄ±cÄ± iÅŸler baÅŸarÄ±rsÄ±nÄ±z. Maddi ve yapÄ±sal olarak saÄŸlam.",
                Air: "Ä°letiÅŸim bu grubun can damarÄ±dÄ±r. Fikirleri tartÄ±ÅŸmayÄ±, sosyalleÅŸmeyi ve yeni kavramlarÄ± keÅŸfetmeyi seversiniz. Ã‡ok entelektÃ¼el ve hareketli bir ortamdÄ±r, ancak bazen duygusal derinlikten yoksun olabilir.",
                Water: "Bu grup derin bir duygusal baÄŸ paylaÅŸÄ±r. Sezgi, empati ve hisler etkileÅŸimlerinize yÃ¶n verir. Birbirinizi korur ve sÃ¶ylenmemiÅŸ ruh hallerini anlarsÄ±nÄ±z, ancak drama veya ruh hali deÄŸiÅŸimlerine yatkÄ±n olabilirsiniz."
            }
        };

        const astroTerms = {
            en: { Sun: "Sun", Moon: "Moon", Mercury: "Mercury", Venus: "Venus", Mars: "Mars", Jupiter: "Jupiter", Saturn: "Saturn", Uranus: "Uranus", Neptune: "Neptune", Pluto: "Pluto", 'North Node': "North Node", Aries: "Aries", Taurus: "Taurus", Gemini: "Gemini", Cancer: "Cancer", Leo: "Leo", Virgo: "Virgo", Libra: "Libra", Scorpio: "Scorpio", Sagittarius: "Sagittarius", Capricorn: "Capricorn", Aquarius: "Aquarius", Pisces: "Pisces" },
            tr: { Sun: "GÃ¼neÅŸ", Moon: "Ay", Mercury: "MerkÃ¼r", Venus: "VenÃ¼s", Mars: "Mars", Jupiter: "JÃ¼piter", Saturn: "SatÃ¼rn", Uranus: "UranÃ¼s", Neptune: "NeptÃ¼n", Pluto: "PlÃ¼ton", 'North Node': "Kuzey Ay DÃ¼ÄŸÃ¼mÃ¼", Aries: "KoÃ§", Taurus: "BoÄŸa", Gemini: "Ä°kizler", Cancer: "YengeÃ§", Leo: "Aslan", Virgo: "BaÅŸak", Libra: "Terazi", Scorpio: "Akrep", Sagittarius: "Yay", Capricorn: "OÄŸlak", Aquarius: "Kova", Pisces: "BalÄ±k" }
        };

        let currentData = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('draconic-res').innerHTML = translations['tr'].draconic_wait;
            document.getElementById('hours-res').innerHTML = translations['tr'].hours_wait;
            // Force Turkish Init
            changeLang('tr');
        });

        function changeLang(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });

            const activeView = document.querySelector('.view[style*="block"]');
            if (activeView) {
                if (activeView.id === 'view-daily') loadDaily();
                if (activeView.id === 'view-chart' && currentData) renderChart(currentData);
                if (activeView.id === 'view-draconic') renderDraconic(currentData);
                if (activeView.id === 'view-hours') renderHours(currentData);
                if (activeView.id === 'view-social') analyzeGroup();
                // Dynamic Career Refresh
                if (activeView.id === 'view-career') loadCareer();
            }

            if (lang === 'tr') {
                if (document.getElementById('soc-name')) document.getElementById('soc-name').placeholder = "Ä°sim";
            } else {
                if (document.getElementById('soc-name')) document.getElementById('soc-name').placeholder = "Name";
            }
        }

        function nav(view, el) {
            document.querySelectorAll('.view').forEach(e => e.style.display = 'none');
            document.getElementById('view-' + view).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');

            if (view === 'daily') loadDaily();
            if (view === 'draconic') renderDraconic(currentData);
            if (view === 'hours') renderHours(currentData);
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        // --- CALCULATOR ---
        async function calcChart() {
            const btn = document.querySelector('#view-chart button');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'NASA Engine Running...';
            document.getElementById('loader-chart').style.display = 'block';
            document.getElementById('res-chart').style.display = 'none';

            try {
                const res = await fetch('/api/calculate-chart/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: document.getElementById('date').value,
                        time: document.getElementById('time').value,
                        lat: document.getElementById('lat').value,
                        lon: document.getElementById('lon').value,
                        lang: document.getElementById('lang').value
                    })
                });
                const data = await res.json();

                if (data.error) {
                    alert("Engine Error: " + data.error);
                } else {
                    currentData = data;
                    renderChart(data);
                    if (currentUser) saveProfileToBackend();
                }
            } catch (e) { alert("Network/Server Error: " + e); }

            document.getElementById('loader-chart').style.display = 'none';
            btn.innerHTML = originalText;
        }

        function renderChart(data) {
            const el = document.getElementById('res-chart');
            el.style.display = 'block';
            const lang = document.getElementById('lang').value;
            const t = translations[lang];
            const terms = astroTerms[lang];

            // Translate Sun Sign
            let sunSign = data.meta?.sun_sign || "Unknown";
            if (terms[sunSign]) sunSign = terms[sunSign];

            // Translate Rising Sign
            let risingSign = data.meta?.rising_sign || "Unknown";
            if (terms[risingSign]) risingSign = terms[risingSign];

            let html = `<div class="glass-card" style="text-align:center">
                <div style="font-size:0.9rem; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.6); margin-bottom:5px">${lang === 'tr' ? 'GÃ¼neÅŸ Burcu' : 'Sun Sign'}</div>
                <h2 style="font-size:3rem; color:var(--accent); margin-bottom:15px; line-height:1">${sunSign}</h2>
                
                <div style="margin-bottom:15px; font-size:0.85rem; color:var(--gold); opacity:0.9">
                     <i class="fas fa-map-marker-alt"></i> Timezone: ${data.meta?.local_timezone || 'LMT'}
                </div>

                <div style="background:rgba(255,255,255,0.1); padding:10px 20px; border-radius:30px; display:inline-block">
                     <span style="opacity:0.8">${t.t_rising}:</span> 
                     <span style="color:var(--gold); font-weight:bold; font-size:1.2rem; margin-left:5px">${risingSign}</span>
                </div>
                
                <div style="display:flex; justify-content:center; gap:20px; margin-top:20px">
                    <span>ðŸ’Ž ${data.meta?.lucky_stone || "-"}</span>
                    <span>ðŸŽ¨ ${data.meta?.lucky_color || "-"}</span>
                </div>
            </div>`;

            html += `<div class="glass-card"><h3>${t.p_pos}</h3>`;
            if (data.planets) {
                data.planets.forEach(p => {
                    const pName = terms[p.name] || p.name;
                    const sName = terms[p.sign] || p.sign;
                    const title = lang === 'tr' ? `${sName} Burcunda ${pName}` : `${pName} in ${sName}`;

                    // Smart Selection of Interpretations
                    let text = p.interpretation || "";
                    if (p.interpretations && p.interpretations[lang]) {
                        text = p.interpretations[lang];
                    }

                    html += `<div class="planet-row"><div class="planet-icon">${p.name[0]}</div><div><h4 style="color:white">${title}</h4><p style="font-size:0.9rem; color:rgba(255,255,255,0.7); line-height:1.6; margin-top:5px">${text}</p></div></div>`;
                });
            }
            html += `</div>`;
            el.innerHTML = html;
        }

        // --- DRACONIC RENDER ---
        // Draconic Soul Keywords
        const draconicKeywords = {
            en: { Sun: "Core Soul Essence", Moon: "Emotional Karma", Mercury: "Spiritual Mind", Venus: "Higher Values", Mars: "Spiritual Drive", Jupiter: "Soul Wisdom", Saturn: "Karmic Responsibility", Uranus: "Soul Awakening", Neptune: "Divine Connection", Pluto: "Soul Power", 'North Node': "Destiny Path" },
            tr: { Sun: "Ruhun Ã–zÃ¼", Moon: "Duygusal Karma", Mercury: "Ruhsal Zihin", Venus: "YÃ¼ksek DeÄŸerler", Mars: "Ruhsal DÃ¼rtÃ¼", Jupiter: "Ruhsal Bilgelik", Saturn: "Karmik Sorumluluk", Uranus: "Ruhsal UyanÄ±ÅŸ", Neptune: "Ä°lahi BaÄŸlantÄ±", Pluto: "Ruhsal GÃ¼Ã§", 'North Node': "Kader Yolu" }
        };

        function renderDraconic(data) {
            const div = document.getElementById('draconic-res');
            const lang = document.getElementById('lang').value;
            const t = translations[lang];
            const terms = astroTerms[lang];

            if (!data || !data.meta || !data.meta.draconic_chart || data.meta.draconic_chart.length === 0) {
                div.innerHTML = t.draconic_wait;
                return;
            }

            // Find Draconic Sun
            const dSun = data.meta.draconic_chart.find(p => p.name === 'Sun');
            const rawSign = dSun ? dSun.sign : "Aries";
            const signTranslated = terms[rawSign] || rawSign;
            const text = draconicInterpretations[lang][rawSign] || "Interpretation not found.";

            let html = `
             <div class="glass-card" style="border-left: 4px solid var(--accent); animation: fadeIn 0.4s; background: linear-gradient(to right, rgba(233,69,96,0.1), transparent)">
                <h2 style="color:var(--accent); font-size:1.8rem; margin-bottom:5px; text-transform:uppercase; letter-spacing:1px">${t.drac_title}</h2>
                <h3 style="color:white; margin-bottom:15px; font-weight:300; opacity:0.9">${t.draconic_sun_label}: <span style="color:var(--gold); font-weight:600">${signTranslated}</span></h3>
                <p style="font-size:1.1rem; line-height:1.8; color:rgba(255,255,255,0.9); text-align:justify; padding-right:10px">${text}</p>
             </div>
             `;

            html += `<div class="glass-card">
                <h3 style="margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px">${t.p_pos} (Draconic)</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px">`;

            data.meta.draconic_chart.forEach(p => {
                const pName = terms[p.name] || p.name;
                const sName = terms[p.sign] || p.sign;
                const keyword = draconicKeywords[lang][p.name] || "";

                // Smart Text Selection
                let planetText = p.interpretation || "No details available.";
                if (p.interpretations && p.interpretations[lang]) {
                    planetText = p.interpretations[lang];
                }

                html += `
                 <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:15px; cursor:pointer; transition:all 0.3s; position:relative; overflow:hidden" 
                      onclick="this.querySelector('.details').style.display = this.querySelector('.details').style.display === 'block' ? 'none' : 'block'; this.style.background = this.style.background.includes('0.1') ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.1)'">
                    
                    <div style="display:flex; align-items:center">
                        <div class="planet-icon" style="background:linear-gradient(135deg, var(--gradient-mid), var(--primary)); width:50px; height:50px; font-size:1.2rem; border:1px solid rgba(255,255,255,0.1); margin-right:15px; display:flex; align-items:center; justify-content:center; border-radius:50%; color:var(--gold)">${p.name[0]}</div>
                        <div style="flex:1">
                            <div style="font-size:0.75rem; color:var(--accent); text-transform:uppercase; letter-spacing:1px; margin-bottom:4px; opacity:0.8">${keyword}</div>
                            <div style="font-size:1.1rem; font-weight:600; color:white; margin-bottom:2px">${pName}</div>
                            <div style="font-size:0.95rem; color:rgba(255,255,255,0.6)">${sName}</div>
                        </div>
                        <div style="color:rgba(255,255,255,0.3)"><i class="fas fa-chevron-down"></i></div>
                    </div>

                    <div class="details" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.95rem; line-height:1.6; color:rgba(255,255,255,0.8); animation: fadeIn 0.3s">
                        ${planetText}
                    </div>
                 </div>`;
            });
            html += `</div></div>`;

            div.innerHTML = html;
        }

        function renderHours(data) {
            const div = document.getElementById('hours-res');
            const lang = document.getElementById('lang').value;
            const t = translations[lang];

            // --- Fallback Generator (Client Side) ---
            // Triggers if backend data is missing/empty to ensure UI never stuck on Loading
            if (!data || !Array.isArray(data) || data.length === 0) {
                console.warn("Using Client-Side Fallback for Planetary Hours");
                data = [];
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; // 0=Sun in JS? No, 0=Sun in JS Date.getDay()
                // Chaldean: Sat, Jup, Mar, Sun, Ven, Mer, Moo
                const chaldean = ['Saturn', 'Jupiter', 'Mars', 'Sun', 'Venus', 'Mercury', 'Moon'];
                const dayRulers = ['Sun', 'Moon', 'Mars', 'Mercury', 'Jupiter', 'Venus', 'Saturn']; // 0=Sun...

                const todayIdx = new Date().getDay(); // 0=Sun, 1=Mon...
                const startRuler = dayRulers[todayIdx];
                const startIdx = chaldean.indexOf(startRuler);

                for (let i = 0; i < 24; i++) {
                    const h = i;
                    const ruler = chaldean[(startIdx + i) % 7];
                    // Simple 06:00 Sunrise Assumption
                    const sTime = (h + 6) % 24;
                    const eTime = (h + 7) % 24;
                    data.push({
                        start: `${sTime < 10 ? '0' + sTime : sTime}:00`,
                        end: `${eTime < 10 ? '0' + eTime : eTime}:00`,
                        ruler: ruler
                    });
                }
            }

            const hourMeanings = {
                en: { Sun: "Success & Visibility", Moon: "Emotions & Family", Mercury: "Communication & Trade", Venus: "Love & Creativity", Mars: "Action & Courage", Jupiter: "Growth & Wealth", Saturn: "Focus & Discipline" },
                tr: { Sun: "BaÅŸarÄ± & GÃ¶rÃ¼nÃ¼rlÃ¼k", Moon: "Duygular & Aile", Mercury: "Ä°letiÅŸim & Ticaret", Venus: "AÅŸk & YaratÄ±cÄ±lÄ±k", Mars: "Eylem & Cesaret", Jupiter: "BÃ¼yÃ¼me & Zenginlik", Saturn: "Odak & Disiplin" }
            };

            const icons = { Sun: 'â˜€ï¸', Moon: 'ðŸŒ™', Mercury: 'â˜¿ï¸', Venus: 'â™€ï¸', Mars: 'â™‚ï¸', Jupiter: 'â™ƒ', Saturn: 'â™„' };
            const colors = { Sun: '#FFD700', Moon: '#C0C0C0', Mercury: '#87CEEB', Venus: '#FF69B4', Mars: '#FF4500', Jupiter: '#800080', Saturn: '#4B0082' };

            const planetDetails = {
                en: {
                    Sun: "The Hour of the Sun is perfect for professional ambition, asking for promotions, public speaking, and vitality works. Your charisma is naturally high.",
                    Moon: "The Hour of the Moon favors domestic activities, cooking, emotional bonding, and rest. A great time for introspection and family.",
                    Mercury: "The Hour of Mercury is the best time for sending emails, studying code, signing contracts, and short trips. Communication flows easily.",
                    Venus: "The Hour of Venus enhances romance, social gatherings, art, and beauty treatments. Indulge in life's pleasures and creative hobbies.",
                    Mars: "The Hour of Mars provides raw energy for workouts, tackling difficult tasks, and confronting challenges. Avoid arguments, channel the fire.",
                    Jupiter: "The Hour of Jupiter brings luck, wealth, and wisdom. Ideal for financial planning, learning new skills, and expansive thinking.",
                    Saturn: "The Hour of Saturn supports discipline, organization, and long-term planning. Good for tedious tasks requiring patience and focus."
                },
                tr: {
                    Sun: "GÃ¼neÅŸ Saati kariyer hedefleri, terfi istemek, sunum yapmak ve otorite figÃ¼rleriyle gÃ¶rÃ¼ÅŸmek iÃ§in mÃ¼kemmeldir. KarizmanÄ±z yÃ¼ksektir.",
                    Moon: "Ay Saati ev iÅŸleri, yemek piÅŸirmek, aileyle vakit geÃ§irmek ve dinlenmek iÃ§in uygundur. Duygusal baÄŸlar ve iÃ§e dÃ¶nÃ¼ÅŸ iÃ§in harikadÄ±r.",
                    Mercury: "MerkÃ¼r Saati mail atmak, kod yazmak, anlaÅŸma imzalamak ve eÄŸitim iÃ§in en verimli zamandÄ±r. Ä°letiÅŸim akÄ±cÄ±dÄ±r.",
                    Venus: "VenÃ¼s Saati romantik buluÅŸmalar, sanatsal aktiviteler, alÄ±ÅŸveriÅŸ ve bakÄ±m iÃ§in idealdir. Keyifli anlarÄ±n tadÄ±nÄ± Ã§Ä±karÄ±n.",
                    Mars: "Mars Saati spor yapmak, zorlu iÅŸleri bitirmek ve cesaret gerektiren adÄ±mlar atmak iÃ§in enerji verir. TartÄ±ÅŸmalardan kaÃ§Ä±nÄ±n.",
                    Jupiter: "JÃ¼piter Saati ÅŸans, bereket ve bilgelik getirir. YatÄ±rÄ±m planlamak, yeni bir ÅŸeyler Ã¶ÄŸrenmek ve vizyon Ã§izmek iÃ§in en iyi saattir.",
                    Saturn: "SatÃ¼rn Saati disiplin, dÃ¼zenleme ve odaklanma gerektiren iÅŸler iÃ§in en iyisidir. SabÄ±r isteyen projeleri bu saatte halledin."
                }
            };

            let html = `<div style="display:flex; flex-direction:column; gap:10px; animation:fadeIn 0.5s">`;

            const now = new Date();

            data.forEach((h, index) => {
                const planet = h.ruler;
                const meaning = hourMeanings[lang][planet] || "";
                const detail = planetDetails[lang][planet] || "";
                const uid = `ph-detail-${index}`;

                // Parse Time with Fail-safe
                const [sH, sM] = h.start.split(':').map(Number);
                const [eH, eM] = h.end.split(':').map(Number);

                let sDate = new Date(); sDate.setHours(sH, sM || 0, 0);
                let eDate = new Date(); eDate.setHours(eH, eM || 0, 0);

                // Handle late night crossing
                if (eDate <= sDate) eDate.setDate(eDate.getDate() + 1);

                // Relaxed "Active" check
                const isActive = (now >= sDate && now < eDate);

                const style = isActive
                    ? `background:linear-gradient(90deg, rgba(233,69,96,0.3), rgba(0,0,0,0)); border-left:4px solid var(--accent); padding:15px; margin-left:-5px; box-shadow:0 0 15px rgba(233,69,96,0.2)`
                    : `background:rgba(255,255,255,0.05); padding:12px; border-left:4px solid ${colors[planet] || '#fff'}`;

                html += `
                <div class="glass-card" 
                     onclick="document.getElementById('${uid}').style.display = document.getElementById('${uid}').style.display==='none'?'block':'none'; this.querySelector('.fa-chevron-down').style.transform = document.getElementById('${uid}').style.display==='none' ? 'rotate(0deg)' : 'rotate(180deg)';"
                     style="${style}; cursor:pointer; transition:all 0.3s">
                    
                    <div style="display:flex; align-items:center; justify-content:space-between">
                        <div style="display:flex; align-items:center; gap:15px">
                            <div style="font-family:'Courier New', monospace; font-size:1.1rem; opacity:0.8; width:110px; flex-shrink:0">${h.start} - ${h.end}</div>
                            <div style="font-size:1.5rem; width:30px; text-align:center">${icons[planet] || 'â­'}</div>
                            <div>
                                <div style="font-weight:bold; font-size:1rem; color:white">${planet} ${lang === 'tr' ? 'Saati' : 'Hour'}</div>
                                <div style="font-size:0.8rem; color:${colors[planet]}; opacity:0.9; letter-spacing:0.5px; text-transform:uppercase">${meaning}</div>
                            </div>
                        </div>
                        ${isActive ? `<div style="background:var(--accent); color:white; padding:4px 10px; border-radius:20px; font-size:0.7rem; font-weight:bold; margin-right:10px; animation:pulse 2s infinite">NOW</div>` : ''}
                        <div style="opacity:0.5"><i class="fas fa-chevron-down" style="transition:transform 0.3s"></i></div>
                    </div>

                    <div id="${uid}" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.95rem; line-height:1.6; color:rgba(255,255,255,0.8); animation: fadeIn 0.3s">
                        ${detail}
                    </div>

                </div>`;
            });

            html += `</div>`;
            div.innerHTML = html;
        }

        // --- SYNASTRY ---
        // --- SYNASTRY ---
        async function calcSynastry() {
            const btn = document.querySelector('#view-synastry button');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Calculating...';

            const date1 = document.getElementById('date').value;
            const date2 = document.getElementById('syn-date').value;
            const lang = document.getElementById('lang').value;
            const t = translations[lang];

            try {
                const res = await fetch('/api/calculate-synastry/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date1, time1: "12:00", date2, time2: "12:00", lang })
                });
                const data = await res.json();
                const resDiv = document.getElementById('syn-res');
                const terms = astroTerms[lang];

                // Advanced Grouping
                const groups = {
                    'Soul Connection': [], 'Attraction': [], 'Communication': [], 'Challenges': []
                };

                let lovePoints = 0;
                let commPoints = 0;

                if (data.aspects) {
                    data.aspects.forEach(a => {
                        // Map backend themes to display groups
                        let target = 'Communication';
                        if (a.theme === 'Attraction' || a.is_romance) target = 'Attraction';
                        if (a.category === 'Tension' || a.category === 'Conflict') target = 'Challenges';
                        if (a.theme === 'Growth' || (a.is_romance && a.category === 'Harmony')) target = 'Soul Connection';

                        groups[target].push(a);

                        // Points
                        if (target === 'Attraction' || target === 'Soul Connection') lovePoints++;
                        if (target === 'Communication') commPoints++;
                    });
                }

                // Strength Calculation
                const loveStrength = Math.min(100, lovePoints * 20 + 20);
                const commStrength = Math.min(100, commPoints * 25 + 20);

                const aspectTerms = {
                    en: { Conjunction: "Conjunction", Opposition: "Opposition", Square: "Square", Trine: "Trine", Sextile: "Sextile" },
                    tr: { Conjunction: "KavuÅŸum", Opposition: "KarÅŸÄ±t", Square: "Kare", Trine: "ÃœÃ§gen", Sextile: "Sekstil" }
                };

                // Helper for Lists
                const renderList = (list, icon) => {
                    if (!list.length) return `<div style="opacity:0.6; font-size:0.9rem; font-style:italic">${lang === 'tr' ? 'Ã–nemli aÃ§Ä± bulunamadÄ±.' : 'No major aspects found.'}</div>`;

                    return list.map((a, idx) => {
                        const p1 = terms[a.p1] || a.p1;
                        const p2 = terms[a.p2] || a.p2;
                        const typeVal = aspectTerms[lang][a.type] || a.type;
                        const uid = `syn-item-${Math.random().toString(36).substr(2, 9)}`;

                        return `
                        <div style="background:rgba(255,255,255,0.03); border-radius:8px; margin-bottom:8px; overflow:hidden; transition:background 0.3s">
                            <div onclick="const d=document.getElementById('${uid}'); const c=this.querySelector('.fa-chevron-down'); if(d.style.display==='none'){d.style.display='block'; c.style.transform='rotate(180deg)'; this.parentElement.style.background='rgba(255,255,255,0.08)'}else{d.style.display='none'; c.style.transform='rotate(0deg)'; this.parentElement.style.background='rgba(255,255,255,0.03)'}" 
                                 style="padding:10px 12px; cursor:pointer; display:flex; align-items:center; justify-content:space-between">
                                <div style="display:flex; align-items:center; gap:10px; font-size:0.95rem">
                                    <span style="color:var(--accent); font-size:1.1rem">${icon}</span>
                                    <span><b>${p1}</b> ${typeVal} <b>${p2}</b></span>
                                </div>
                                <i class="fas fa-chevron-down" style="font-size:0.8rem; opacity:0.5; transition:transform 0.3s"></i>
                            </div>
                            <div id="${uid}" style="display:none; padding:12px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.9rem; line-height:1.6; color:rgba(255,255,255,0.9)">
                                ${a.interpretation || 'No detail available.'}
                            </div>
                        </div>`;
                    }).join('');
                };

                let html = `
                <div style="animation:fadeIn 0.5s">
                    <!-- Score Card -->
                    <div class="glass-card" style="text-align:center; padding:30px; border-bottom: 4px solid var(--accent)">
                        <h4 style="letter-spacing:3px; opacity:0.8; margin-bottom:10px">${lang === 'tr' ? 'UYUM SKORU' : 'COMPATIBILITY SCORE'}</h4>
                        <div style="font-size:5rem; font-weight:800; color:var(--accent); line-height:1; margin-bottom:10px; text-shadow:0 0 20px rgba(233,69,96,0.3)">${data.score}%</div>
                        <p style="font-size:1.3rem; font-style:italic; opacity:0.9; max-width:600px; margin:0 auto">"${data.summary}"</p>
                    </div>

                    <!-- Meters -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px">
                         <div class="glass-card" style="padding:15px">
                            <h4 style="margin-bottom:10px"><i class="fas fa-heart" style="color:#e91e63"></i> ${lang === 'tr' ? 'Romantik Ã‡ekim' : 'Romantic Attraction'}</h4>
                            <div style="background:rgba(255,255,255,0.1); border-radius:10px; height:10px; width:100%"><div style="width:${loveStrength}%; background:#e91e63; height:100%; border-radius:10px; transition:width 1s"></div></div>
                            <div style="text-align:right; font-size:0.8rem; margin-top:5px; opacity:0.8">${loveStrength > 70 ? (lang === 'tr' ? 'Ã‡ok GÃ¼Ã§lÃ¼' : 'Very Strong') : (lang === 'tr' ? 'Orta Seviye' : 'Moderate')}</div>
                         </div>
                         <div class="glass-card" style="padding:15px">
                            <h4 style="margin-bottom:10px"><i class="fas fa-comments" style="color:#03a9f4"></i> ${lang === 'tr' ? 'Ä°letiÅŸim' : 'Communication'}</h4>
                            <div style="background:rgba(255,255,255,0.1); border-radius:10px; height:10px; width:100%"><div style="width:${commStrength}%; background:#03a9f4; height:100%; border-radius:10px; transition:width 1s"></div></div>
                            <div style="text-align:right; font-size:0.8rem; margin-top:5px; opacity:0.8">${commStrength > 70 ? (lang === 'tr' ? 'AkÄ±ÅŸkan' : 'Fluid') : (lang === 'tr' ? 'GeliÅŸtirilebilir' : 'Needs Work')}</div>
                         </div>
                    </div>

                    <!-- Detailed Analysis Categories -->
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-top:20px">
                        
                        <!-- Soul Connection -->
                        <div class="glass-card">
                            <h3 style="color:#9c27b0; margin-bottom:15px"><i class="fas fa-infinity"></i> ${lang === 'tr' ? 'Ruhsal BaÄŸ' : 'Soul Connection'}</h3>
                            ${renderList(groups['Soul Connection'], 'âœ¨')}
                            <p style="font-size:0.85rem; opacity:0.7; margin-top:10px; line-height:1.4">
                                ${lang === 'tr' ? 'Bu aÃ§Ä±lar iliÅŸkinin kadersel ve derin yÃ¶nÃ¼nÃ¼ gÃ¶sterir. Uzun vadeli baÄŸÄ±n temelidir.' : 'These aspects indicate the karmic and deep nature of the relationship. The foundation of a long-term bond.'}
                            </p>
                        </div>

                        <!-- Attraction -->
                        <div class="glass-card">
                            <h3 style="color:#e91e63; margin-bottom:15px"><i class="fas fa-fire"></i> ${lang === 'tr' ? 'Tutku & Ã‡ekim' : 'Passion & Attraction'}</h3>
                            ${renderList(groups['Attraction'], 'ðŸ”¥')}
                             <p style="font-size:0.85rem; opacity:0.7; margin-top:10px; line-height:1.4">
                                ${lang === 'tr' ? 'Fiziksel ve romantik enerjinin kaynaÄŸÄ±. Ä°liÅŸkinin heyecanÄ±nÄ± belirler.' : 'The source of physical and romantic energy. Determines the excitement of the relationship.'}
                            </p>
                        </div>

                        <!-- Challenges -->
                        <div class="glass-card">
                            <h3 style="color:#ff9800; margin-bottom:15px"><i class="fas fa-exclamation-circle"></i> ${lang === 'tr' ? 'GeliÅŸim AlanlarÄ±' : 'Challenges'}</h3>
                            ${renderList(groups['Challenges'], 'âš ï¸')}
                             <p style="font-size:0.85rem; opacity:0.7; margin-top:10px; line-height:1.4">
                                ${lang === 'tr' ? 'Bu alanlar iliÅŸkinin dersleridir. SabÄ±r ve anlayÄ±ÅŸla aÅŸÄ±ldÄ±ÄŸÄ±nda baÄŸÄ± gÃ¼Ã§lendirir.' : 'These are the lessons of the relationship. When overcome with patience, they strengthen the bond.'}
                            </p>
                        </div>

                    </div>
                </div>`;

                resDiv.innerHTML = html;
            } catch (e) { alert("Error: " + e); }
            btn.innerHTML = originalText;
        }

        // --- SOCIAL ---
        let members = [];
        async function addMember() {
            const nameInp = document.getElementById('soc-name');
            const dateInp = document.getElementById('soc-date');
            if (!nameInp.value || !dateInp.value) return alert("Enter name and date");
            const btn = document.querySelector('#view-social button');
            const originalText = btn.innerHTML; btn.innerHTML = '...';

            try {
                const res = await fetch('/api/calculate-chart/', { method: 'POST', body: JSON.stringify({ date: dateInp.value, time: "12:00", lat: 41.0, lon: 28.0, lang: document.getElementById('lang').value }) });
                const data = await res.json();
                if (data.error) alert(data.error);
                else { members.push({ name: nameInp.value, dominants: data.meta.dominants }); renderMembers(); analyzeGroup(); nameInp.value = ""; }
            } catch (e) { }
            btn.innerHTML = originalText;
        }
        function renderMembers() {
            const list = document.getElementById('member-list'); list.innerHTML = "";
            members.forEach((m, i) => list.innerHTML += `<div class="planet-row"><div class="planet-icon"><i class="fas fa-user"></i></div><div style="flex:1">${m.name}</div><i class="fas fa-trash" style="color:#ff4444; cursor:pointer" onclick="removeMember(${i})"></i></div>`);
        }
        function removeMember(i) { members.splice(i, 1); renderMembers(); analyzeGroup(); }
        function analyzeGroup() {
            const resDiv = document.getElementById('social-res');
            const lang = document.getElementById('lang').value;
            const t = translations[lang];

            if (members.length === 0) { resDiv.innerHTML = `<p style="opacity:0.6; font-style:italic">${t.soc_placeholder}</p>`; return; }

            // 1. Calculate Element Totals & Individual Roles
            let totals = { Fire: 0, Earth: 0, Air: 0, Water: 0 };
            const roles = [];

            members.forEach(m => {
                if (m.dominants) {
                    totals.Fire += m.dominants.Fire || 0;
                    totals.Earth += m.dominants.Earth || 0;
                    totals.Air += m.dominants.Air || 0;
                    totals.Water += m.dominants.Water || 0;

                    // Assign Role
                    const pMax = Math.max(m.dominants.Fire, m.dominants.Earth, m.dominants.Air, m.dominants.Water);
                    let role = "Member";
                    if (pMax === m.dominants.Fire) role = lang === 'tr' ? 'Ã–ncÃ¼ (AteÅŸ)' : 'The Spark (Fire)';
                    else if (pMax === m.dominants.Earth) role = lang === 'tr' ? 'Kurucu (Toprak)' : 'The Builder (Earth)';
                    else if (pMax === m.dominants.Air) role = lang === 'tr' ? 'Fikirci (Hava)' : 'The Thinker (Air)';
                    else if (pMax === m.dominants.Water) role = lang === 'tr' ? 'Duygusal BaÄŸ (Su)' : 'The Heart (Water)';
                    roles.push({ name: m.name, role: role });
                }
            });

            const totalScore = totals.Fire + totals.Earth + totals.Air + totals.Water;
            if (totalScore === 0) return;
            const pct = (v) => Math.round((v / totalScore) * 100);

            // 2. Identify Dominant & Weakest
            const sortedElements = Object.entries(totals).sort((a, b) => b[1] - a[1]);
            const domElement = sortedElements[0][0];
            const weakElement = sortedElements[3][0];

            // 3. Vibe Analysis
            let vibeTitle = "";
            let vibeDesc = "";

            // Complex Vibe Logic
            if (domElement === 'Fire') {
                vibeTitle = lang === 'tr' ? "YÃ¼ksek Enerji & Eylem" : "High Voltage & Action";
                vibeDesc = lang === 'tr' ? "Bu grup yerinde duramaz! Macera, risk ve baÅŸlatma enerjisi Ã§ok yÃ¼ksek." : "This group is unstoppable! High energy for adventure, risk-taking, and starting new things.";
            } else if (domElement === 'Earth') {
                vibeTitle = lang === 'tr' ? "SaÄŸlam & Ãœretken" : "Solid & Productive";
                vibeDesc = lang === 'tr' ? "AyaklarÄ± yere basan bir ekip. Somut sonuÃ§lar ve finansal baÅŸarÄ± odaklÄ±." : "A grounded team focused on tangible results, stability, and financial success.";
            } else if (domElement === 'Air') {
                vibeTitle = lang === 'tr' ? "Zeka & Ä°letiÅŸim" : "Intellectual & Social";
                vibeDesc = lang === 'tr' ? "Fikirler havada uÃ§uÅŸuyor. Sohbet hiÃ§ bitmez, sÃ¼rekli yeni planlar yapÄ±lÄ±r." : "Ideas are flowing non-stop. Endless conversation and constant new planning.";
            } else { // Water
                vibeTitle = lang === 'tr' ? "Derin BaÄŸlar & Empati" : "Deep Bonds & Empathy";
                vibeDesc = lang === 'tr' ? "Birbirini hisseden bir aile gibi. Duygusal destek ve sezgiler Ã¶n planda." : "Like a family that feels each other. Emotional support and intuition are the priority.";
            }

            // Warning
            let warning = "";
            if (totals[weakElement] < totalScore * 0.15) { // If less than 15%
                if (weakElement === 'Fire') warning = lang === 'tr' ? "âš ï¸ Eksik AteÅŸ: Harekete geÃ§mekte zorlanabilirsiniz." : "âš ï¸ Low Fire: You might struggle to take action.";
                if (weakElement === 'Earth') warning = lang === 'tr' ? "âš ï¸ Eksik Toprak: PlanlarÄ± somutlaÅŸtÄ±rmak zor olabilir." : "âš ï¸ Low Earth: Hard to make plans reality.";
                if (weakElement === 'Air') warning = lang === 'tr' ? "âš ï¸ Eksik Hava: Ä°letiÅŸim kopukluklarÄ± yaÅŸanabilir." : "âš ï¸ Low Air: Communication might get stuck.";
                if (weakElement === 'Water') warning = lang === 'tr' ? "âš ï¸ Eksik Su: Duygusal baÄŸlar zayÄ±f kalabilir." : "âš ï¸ Low Water: Emotional depth might be lacking.";
            }

            // 4. Render Rich Dashboard
            let html = `
            <div style="animation:fadeIn 0.5s">
                <div class="glass-card" style="background:linear-gradient(135deg, rgba(233,69,96,0.1), rgba(26,26,46,0.8)); border:1px solid var(--accent)">
                    <h2 style="color:var(--gold); text-transform:uppercase; letter-spacing:2px; font-size:1rem; margin-bottom:5px">${lang === 'tr' ? 'GRUP AURASI' : 'GROUP AURA'}</h2>
                    <h1 style="font-size:2.2rem; margin-bottom:10px">${vibeTitle}</h1>
                    <p style="font-size:1.1rem; line-height:1.6; opacity:0.9">${vibeDesc}</p>
                    ${warning ? `<div style="background:rgba(255,200,0,0.15); color:#ffd700; padding:10px; border-radius:8px; margin-top:15px; font-size:0.9rem"><i class="fas fa-exclamation-triangle"></i> ${warning}</div>` : ''}
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px">
                    <div class="glass-card">
                        <h3 style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px">${lang === 'tr' ? 'Element Dengesi' : 'Elemental Balance'}</h3>
                        <div style="display:flex; flex-direction:column; gap:10px">
                            <div><span style="color:#e25822">ðŸ”¥ Fire</span> <div style="width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:4px"><div style="width:${pct(totals.Fire)}%; background:#e25822; height:100%; border-radius:4px"></div></div></div>
                            <div><span style="color:#bada55">ðŸŒ¿ Earth</span> <div style="width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:4px"><div style="width:${pct(totals.Earth)}%; background:#bada55; height:100%; border-radius:4px"></div></div></div>
                            <div><span style="color:#a4dcf5">ðŸ’¨ Air</span> <div style="width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:4px"><div style="width:${pct(totals.Air)}%; background:#a4dcf5; height:100%; border-radius:4px"></div></div></div>
                            <div><span style="color:#1ca3ec">ðŸ’§ Water</span> <div style="width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:4px"><div style="width:${pct(totals.Water)}%; background:#1ca3ec; height:100%; border-radius:4px"></div></div></div>
                        </div>
                    </div>

                    <div class="glass-card">
                        <h3 style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px">${lang === 'tr' ? 'Kozmik Roller' : 'Cosmic Roles'}</h3>
                        <div style="display:flex; flex-direction:column; gap:10px">
                            ${roles.map(r => `
                                <div style="display:flex; align-items:center; gap:10px">
                                    <div style="width:30px; height:30px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center"><i class="fas fa-user-astronaut"></i></div>
                                    <div>
                                        <div style="font-weight:bold">${r.name}</div>
                                        <div style="font-size:0.8rem; color:var(--accent)">${r.role}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>`;

            resDiv.innerHTML = html;
        }

        // DAILY
        let chartInstance = null;
        async function loadDaily() {
            const lang = document.getElementById('lang').value;

            try {
                // No date param, defaults to Now (Today -> Future)
                const wRes = await fetch(`/api/weekly-forecast/?lang=${lang}`);
                const wData = await wRes.json();

                // Chart
                const ctx = document.getElementById('weeklyChart').getContext('2d');
                if (chartInstance) chartInstance.destroy();

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: wData.forecast.map(d => d.day),
                        datasets: [
                            { label: lang === 'tr' ? 'Genel' : 'General', data: wData.forecast.map(d => d.score), borderColor: '#E94560', backgroundColor: 'rgba(233,69,96,0.1)', tension: 0.4, fill: true },
                            { label: lang === 'tr' ? 'AÅŸk' : 'Love', data: wData.forecast.map(d => d.love), borderColor: '#d63384', borderDash: [5, 5], tension: 0.4, fill: false },
                            { label: lang === 'tr' ? 'Kariyer' : 'Career', data: wData.forecast.map(d => d.career), borderColor: '#FFD700', borderDash: [2, 2], tension: 0.4, fill: false }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { labels: { color: 'white' } } },
                        scales: { y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { grid: { display: false } } }
                    }
                });

                // Fortune List
                const listDiv = document.getElementById('daily-list');
                let listHtml = "";
                wData.forecast.forEach(d => {
                    let scoreColor = '#E94560';
                    if (d.score > 70) scoreColor = '#4caf50';
                    if (d.score > 40 && d.score <= 70) scoreColor = '#FFD700';

                    listHtml += `
                    <div style="display:flex; gap:15px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); align-items:center">
                        <div style="text-align:center; min-width:60px">
                            <div style="font-size:0.9rem; opacity:0.7">${d.day.split(' ')[0]}</div>
                            <div style="font-size:1.2rem; font-weight:bold">${d.day.split(' ')[1]}</div>
                        </div>
                        <div style="flex:1">
                            <div style="font-size:1rem; margin-bottom:4px; color:rgba(255,255,255,0.9)">${d.comment}</div>
                            <div style="display:flex; gap:10px; font-size:0.8rem; opacity:0.6">
                                <span>â¤ï¸ ${d.love}%</span> <span>ðŸ’¼ ${d.career}%</span>
                            </div>
                        </div>
                        <div style="font-size:1.5rem; font-weight:bold; color:${scoreColor}">${d.score}</div>
                    </div>`;
                });
                listDiv.innerHTML = listHtml;

                // Daily Tip (Generic)
                const dRes = await fetch(`/api/daily-planner/?lang=${lang}`);
                const dData = await dRes.json();
                document.getElementById('daily-text').innerText = dData.daily_summary || "";

                // Render Real Planetary Hours
                if (dData.hours && typeof renderHours === 'function') {
                    renderHours(dData.hours);
                }

                // FETCH WEEKLY EDITORIAL
                try {
                    const eRes = await fetch('/editorial/api/latest/');
                    const eData = await eRes.json();
                    if (eData.exists) {
                        const editorialEl = document.getElementById('dash-weekly-editorial');
                        editorialEl.style.display = 'block';

                        document.getElementById('dwe-title').innerHTML = eData.title;
                        document.getElementById('dwe-date').innerText = eData.date;

                        const contentDiv = document.getElementById('dwe-content');
                        contentDiv.innerHTML = eData.content;

                        // Check if content is long enough to clamp
                        // We can just add the class comfortably, and check approximate length to show button
                        if (eData.content.length > 300) {
                            contentDiv.classList.add('line-clamp-editorial');
                            document.getElementById('btn-toggle-editorial').style.display = 'flex';
                        } else {
                            document.getElementById('btn-toggle-editorial').style.display = 'none';
                        }

                    } else {
                        // If no content but USER IS ADMIN, show a placeholder asking to write one
                        // We can check local 'currentUser' variable or just rely on the button being visible
                        if (document.getElementById('btn-edit-editorial') && document.getElementById('btn-edit-editorial').style.display !== 'none') {
                            document.getElementById('dash-weekly-editorial').style.display = 'block';
                            document.getElementById('dwe-title').innerHTML = "HenÃ¼z HaftalÄ±k Yorum Girilmedi";
                            document.getElementById('dwe-content').innerHTML = "Yeni bir haftalÄ±k yorum yazmak iÃ§in 'DÃ¼zenle' butonuna tÄ±klayÄ±n.";
                            document.getElementById('btn-toggle-editorial').style.display = 'none';
                        }
                    }
                } catch (err) { console.error(err); }

            } catch (e) { console.error(e); }
        }

        // EDITORIAL TOGGLE LOGIC
        function toggleEditorial() {
            const contentDiv = document.getElementById('dwe-content');
            const icon = document.getElementById('icon-toggle-editorial');
            const label = document.getElementById('label-toggle-editorial');

            // Toggle class
            contentDiv.classList.toggle('line-clamp-editorial');

            const isClamped = contentDiv.classList.contains('line-clamp-editorial');

            if (!isClamped) {
                // Expanded
                icon.className = 'fas fa-chevron-up';
                label.innerText = document.getElementById('lang').value === 'tr' ? 'KÃ¼Ã§Ã¼lt' : 'Show Less';
            } else {
                // Collapsed
                icon.className = 'fas fa-chevron-down';
                label.innerText = document.getElementById('lang').value === 'tr' ? 'DevamÄ±nÄ± Oku' : 'Read More';
            }
        }

        // ==========================================
        // DYNAMIC LOCATION SELECTOR (API)
        // ==========================================

        // ==========================================
        // DYNAMIC LOCATION SELECTOR (API)
        // ==========================================

        async function loadCountries() {
            const lang = document.getElementById('lang').value;
            const cSel = document.getElementById('loc-country');
            cSel.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch('/api/countries/');
                const data = await res.json();

                if (data.countries) {
                    let html = `<option value="">${lang === 'tr' ? 'Ãœlke SeÃ§iniz' : 'Select Country'}</option>`;
                    data.countries.forEach(c => {
                        const selected = (c.code === 'TR') ? 'selected' : '';
                        html += `<option value="${c.code}" ${selected}>${c.name}</option>`;
                    });
                    cSel.innerHTML = html;
                    cSel.value = "TR";
                    loadProvinces(); // Changed from loadCities
                }
            } catch (e) {
                console.error(e);
                cSel.innerHTML = '<option value="">Error</option>';
            }
        }

        async function loadProvinces() {
            const lang = document.getElementById('lang').value;
            const code = document.getElementById('loc-country').value;
            const pSel = document.getElementById('loc-province');
            const cSel = document.getElementById('loc-city');

            // Reset City
            cSel.innerHTML = `<option value="">${lang === 'tr' ? 'Ã–nce Ä°l SeÃ§iniz...' : 'Select Province First...'}</option>`;

            if (!code) {
                pSel.style.display = 'none';
                return;
            }

            pSel.innerHTML = '<option value="">Loading...</option>';
            pSel.style.display = 'block'; // Show it

            try {
                const res = await fetch(`/api/provinces/?code=${code}`);
                const data = await res.json();

                // If we have provinces
                if (data.provinces && data.provinces.length > 0) {
                    let html = `<option value="">${lang === 'tr' ? 'Ä°l SeÃ§iniz' : 'Select Province'}</option>`;
                    data.provinces.forEach(p => {
                        html += `<option value="${p.code}">${p.name}</option>`;
                    });
                    pSel.innerHTML = html;
                    pSel.style.display = 'block';
                } else {
                    // No provinces found (flat country?), hide province sel and load cities directly
                    pSel.style.display = 'none';
                    pSel.innerHTML = '<option value="">-</option>';
                    loadCities();
                }
            } catch (e) {
                console.error(e);
                pSel.style.display = 'none';
                // Fallback to loading cities directly if province fetch fails?
                loadCities();
            }
        }

        async function loadCities() {
            const lang = document.getElementById('lang').value;
            const countryCode = document.getElementById('loc-country').value;
            const provinceCode = document.getElementById('loc-province').value;
            const citySel = document.getElementById('loc-city');

            if (!countryCode) return;

            // If Province is visible but not selected, wait
            const pSel = document.getElementById('loc-province');
            if (pSel.style.display !== 'none' && !provinceCode) {
                citySel.innerHTML = `<option value="">${lang === 'tr' ? 'Åžehir/Ä°lÃ§e SeÃ§iniz' : 'Select City/District'}</option>`;
                return;
            }

            citySel.innerHTML = '<option value="">Loading...</option>';

            try {
                // Fetch cities, passing admin_code if available
                let url = `/api/cities/?code=${countryCode}`;
                if (provinceCode) {
                    url += `&admin_code=${provinceCode}`;
                }

                const res = await fetch(url);
                const data = await res.json();

                if (data.cities) {
                    let html = `<option value="">${lang === 'tr' ? 'Ä°lÃ§e SeÃ§iniz' : 'Select District'}</option>`;
                    data.cities.forEach(c => {
                        html += `<option value="${c.lat},${c.lon}">${c.name}</option>`;
                    });
                    citySel.innerHTML = html;
                }
            } catch (e) {
                console.error(e);
                citySel.innerHTML = '<option value="">Error</option>';
            }
        }

        function setCityCoords() {
            const val = document.getElementById('loc-city').value;
            if (val) {
                const [lat, lon] = val.split(',');
                document.getElementById('lat').value = lat;
                document.getElementById('lon').value = lon;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCountries();
        });
    </script>

    <!-- AUTH LOGIC SCRIPT -->
    <script>
        let isRegistering = false;
        let currentUser = null;

        // Auto Check on Load
        document.addEventListener('DOMContentLoaded', () => {
            loadRegCountries();
            checkAuth();
        });

        async function checkAuth() {
            try {
                const res = await fetch('/api/check-auth/');
                const data = await res.json();

                if (data.authenticated) {
                    // SHOW APP
                    document.getElementById('landing-root').style.display = 'none';
                    document.getElementById('app-root').style.display = 'flex';

                    currentUser = data.username;
                    updateAuthUI(true, data.username);
                    document.getElementById('auth-modal').style.display = 'none';

                    if (data.is_superuser || data.username === 'admin') {
                        const adminBtn = document.getElementById('admin-nav-item');
                        const editorBtn = document.getElementById('editor-nav-item');
                        const editContentBtn = document.getElementById('btn-edit-editorial');

                        if (adminBtn) adminBtn.style.display = 'flex';
                        if (editorBtn) editorBtn.style.display = 'flex';
                        if (editContentBtn) editContentBtn.style.display = 'inline-flex';
                    }

                    // Auto-Fill & Lock Profile Data
                    if (data.profile) {
                        const dateEl = document.getElementById('date');
                        const timeEl = document.getElementById('time');
                        const latEl = document.getElementById('lat');
                        const lonEl = document.getElementById('lon');

                        if (data.profile.date) {
                            dateEl.value = data.profile.date;
                            dateEl.disabled = true;
                            dateEl.style.opacity = '0.7';
                        }
                        if (data.profile.time) {
                            timeEl.value = data.profile.time;
                            timeEl.disabled = true;
                            timeEl.style.opacity = '0.7';
                        }
                        if (data.profile.lat) {
                            latEl.value = data.profile.lat;
                            latEl.disabled = true;
                            latEl.style.opacity = '0.7';
                        }
                        if (data.profile.lon) {
                            lonEl.value = data.profile.lon;
                            lonEl.disabled = true;
                            lonEl.style.opacity = '0.7';
                        }

                        // Lock Location
                        document.getElementById('main-loc-container').style.display = 'none';
                        const lockedInput = document.getElementById('locked-loc-input');

                        lockedInput.style.display = 'block';
                        lockedInput.value = data.profile.place || (data.profile.lat ? `${data.profile.lat}, ${data.profile.lon}` : "Location Unknown");
                    }
                } else {
                    // SHOW LANDING
                    document.getElementById('landing-root').style.display = 'flex';
                    document.getElementById('app-root').style.display = 'none';

                    updateAuthUI(false);
                    loadDailyHoroscopes(); // Fetch data
                }
            } catch (e) { console.error("Auth check failed", e); }
        }



        async function loadDailyHoroscopes() {
            try {
                const lang = document.getElementById('lang').value;
                const t = translations[lang];
                const container = document.getElementById('horo-grid');
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';

                const res = await fetch(`/api/daily-horoscopes/?lang=${lang}`);
                const data = await res.json();

                if (!data.horoscopes) return;

                container.innerHTML = data.horoscopes.map((h, i) => `
                    <div class="horo-card" onclick="toggleHoro(this)">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <div style="font-size:1.5rem; font-weight:bold; color:var(--text)">${h.sign}</div>
                            <div style="font-size:2rem; filter:drop-shadow(0 0 10px var(--accent))">${h.mood}</div>
                        </div>
                        <div style="font-size:0.8rem; opacity:0.6; margin-top:5px">${h.date} - ${t.daily_comment}</div>
                        
                        <div class="horo-content">
                            <p>${h.text}</p>
                            <div style="margin-top:15px; text-align:right">
                                <button onclick="event.stopPropagation(); startLoginProcess()" 
                                        style="background:transparent; border:1px solid var(--accent); color:var(--accent); padding:5px 15px; border-radius:20px; cursor:pointer; font-size:0.8rem">
                                    ${t.daily_login_more} <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (e) { console.error(e); }
        }

        function toggleHoro(el) {
            // Uncollapse others
            document.querySelectorAll('.horo-card.active').forEach(c => {
                if (c !== el) {
                    c.classList.remove('active');
                    c.querySelector('.horo-content').style.display = 'none';
                }
            });

            el.classList.toggle('active');
            const content = el.querySelector('.horo-content');
            content.style.display = el.classList.contains('active') ? 'block' : 'none';

            // Smoother scroll if needed
            if (el.classList.contains('active')) {
                el.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }

        // Modal Controls (ROBUST IMPLEMENTATION)
        // Modal Controls (ROBUST IMPLEMENTATION)
        function openAuthModal() {
            const modal = document.getElementById('auth-modal');
            if (modal) {
                // Force Reset Styles
                modal.style.display = 'flex';
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'auto';

                // Initialize Tabs
                switchAuthTab('login');

                // Load Location Data if needed
                if (typeof loadRegCountries === 'function') {
                    const cSel = document.getElementById('reg-country');
                    if (cSel && cSel.options.length <= 1) loadRegCountries();
                }

                // Pre-fill Date/Time from Landing Inputs
                const mainDate = document.getElementById('date');
                const mainTime = document.getElementById('time');
                if (mainDate && document.getElementById('auth-date')) document.getElementById('auth-date').value = mainDate.value;
                if (mainTime && document.getElementById('auth-time')) document.getElementById('auth-time').value = mainTime.value;
            }
        }
        // Auth Logic Removed - Handled by Landing Page


        function updateAuthUI(isLoggedIn, name) {
            const btnLogin = document.getElementById('btn-login-trig');
            const btnLogout = document.getElementById('btn-logout-trig');
            const userDisplay = document.getElementById('user-display');

            if (isLoggedIn) {
                btnLogin.style.display = 'none';
                btnLogout.style.display = 'flex';
                userDisplay.innerHTML = `<i class="fas fa-user-circle"></i> ${name}`;
                userDisplay.style.display = 'block';
            } else {
                btnLogin.style.display = 'flex';
                btnLogout.style.display = 'none';
                userDisplay.style.display = 'none';
            }
        }

        // Duplicate scripts removed to ensure stability
        async function doLogout() {
            await fetch('/api/logout/');
            location.reload();
        }

        // Auto-Save Hook: Call this after successful chart calculation
        async function saveProfileToBackend() {
            if (!currentUser) return; // Only for logged in users

            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;

            // Try to find place name
            let placeName = "Unknown";
            const citySel = document.getElementById('loc-city');
            if (citySel && citySel.options.length > 0 && citySel.selectedIndex >= 0) {
                placeName = citySel.options[citySel.selectedIndex].text;
            }

            try {
                await fetch('/api/update-profile/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, time, lat, lon, place: placeName })
                });
                console.log("Profile auto-saved.");
            } catch (e) { console.error("Save failed", e); }
        }

        // EDITORIAL TOGGLE LOGIC
        function toggleEditorial() {
            const contentDiv = document.getElementById('dwe-content');
            const icon = document.getElementById('icon-toggle-editorial');
            const label = document.getElementById('label-toggle-editorial');

            const fullText = contentDiv.dataset.fullText;
            const isTruncated = contentDiv.dataset.isTruncated === 'true';

            if (isTruncated) {
                // EXPAND
                contentDiv.innerHTML = fullText;
                contentDiv.dataset.isTruncated = 'false';

                icon.className = 'fas fa-chevron-up';
                label.innerText = document.getElementById('lang').value === 'tr' ? 'KÃ¼Ã§Ã¼lt' : 'Show Less';
            } else {
                // COLLAPSE
                // Re-truncate
                const limit = 300;
                contentDiv.innerHTML = fullText.substring(0, limit) + "...";
                contentDiv.dataset.isTruncated = 'true';

                icon.className = 'fas fa-chevron-down';
                label.innerText = document.getElementById('lang').value === 'tr' ? 'DevamÄ±nÄ± Oku' : 'Read More';
            }
        }
    </script>

</body>

</html>